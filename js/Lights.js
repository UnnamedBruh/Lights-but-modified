function bind(t,e){return function(){e.apply(t,arguments)}}LIGHTS.GUI=function(t){this.initialize(t)},LIGHTS.GUI.prototype={shareLeft:49,initialize:function(t){LIGHTS.GUI.instance=this,this.setup(),t?this.setupGo():this.setupFail()},setup:function(){this.logo=document.getElementById("lights_logo"),this.hey=document.getElementById("lights_helloenjoy"),this.share=document.getElementById("lights_share"),this.credits=document.getElementById("lights_credits"),this.logo.style.visibility=this.hey.style.visibility=this.share.style.visibility=this.credits.style.visibility="hidden",this.share.style.display="none"},setupGo:function(){this.info=document.getElementById("lights_info"),this.info.style.visibility="hidden",this.div=document.getElementById("lights_outer"),this.active=!1},setupFail:function(){document.body.style.backgroundImage="url('images/home/background.jpg')",this.logo.style.visibility=this.hey.style.visibility=this.share.style.visibility=this.credits.style.visibility="visible",document.getElementById("lights_fail").style.visibility="visible",this.share.style.display="inline",this.share.style.left=this.shareLeft+"px"},fade:function(t){t>0?(this.logo.style.visibility=this.hey.style.visibility=this.info.style.visibility=this.share.style.visibility=this.credits.style.visibility="visible",this.setOpacity(this.logo,Math.max(0,Math.min(1,2*t))),this.setOpacity(this.hey,Math.max(0,Math.min(1,2*t-.5))),this.setOpacity(this.info,Math.max(0,Math.min(1,2*t-.25))),this.setOpacity(this.share,Math.max(0,Math.min(1,2*t-1))),this.setOpacity(this.credits,Math.max(0,Math.min(1,2*t-.75))),this.share.style.display="inline",this.share.style.left=this.shareLeft+"px"):this.logo.style.visibility=this.hey.style.visibility=this.info.style.visibility=this.share.style.visibility=this.credits.style.visibility="hidden"},setOpacity:function(t,e){t.style.opacity=e,void 0!==t.filters&&(t.filters.alpha.opacity=100*e)}},LIGHTS.releaseBuild=!0,LIGHTS.time=0,LIGHTS.deltaTime=0,LIGHTS.colors=[16717153,16773140,1376157,1365247,16751892],LIGHTS.hues=[341/360,56/360,155/360,191/360,35/360],LIGHTS.colorBlack=new THREE.Color(0),LIGHTS.colorWhite=new THREE.Color(16777215),document.onselectstart=function(){return!1},document.onmousedown=function(){return!1},window.onload=function(){this.lights=new LIGHTS.Lights},LIGHTS.Lights=function(){LIGHTS.Lights.instance=this,this.initialize()},LIGHTS.Lights.prototype={initialize:function(){Detector.webgl?(this.renderManager=new LIGHTS.RenderManager,this.input=new LIGHTS.Input,this.gui=new LIGHTS.GUI(!0),this.home=new LIGHTS.Home(this.renderManager,this.gui,bind(this,this.launchHome)),this.loader=new LIGHTS.Loader(bind(this,this.launch))):this.gui=new LIGHTS.GUI(!1)},launchHome:function(){this.home.launchIntro(),this.experiencePlaying=!1,this.animateLights()},launch:function(){LIGHTS.stopwatch=new LIGHTS.Stopwatch,this.view=new LIGHTS.View(this.renderManager),this.director=new LIGHTS.Director(this.view),this.home.launchPlay()},playExperience:function(){this.home.stop(),this.director.start(),this.experiencePlaying=!0},playHome:function(){this.director.stop(),this.home.start(),this.experiencePlaying=!1},animateLights:function(){requestAnimationFrame(bind(this,this.animateLights)),this.experiencePlaying?(this.view.clear(),this.director.update(),this.view.update(),this.director.postUpdate()):this.home.update()}};var rad45=Math.PI/4,rad90=Math.PI/2,rad180=Math.PI,rad360=2*Math.PI,deg2rad=Math.PI/180,rad2deg=180/Math.PI,phi=1.618033988749;function onTweetsLoaded(t){LIGHTS.Loader.prototype.instance.onTweetsLoaded(t)}LIGHTS.images={},LIGHTS.Loader=function(t){this.initialize(t)},LIGHTS.Loader.prototype={totalTweets:9,initialize:function(t){this.callback=t,LIGHTS.Loader.prototype.instance=this,this.avatarsLoaded=!1,this.loadMusic()},loadMusic:function(){var t=document.createElement("audio"),e=null;t.canPlayType&&(""!=t.canPlayType("audio/mpeg")?e=LIGHTS.Config.musicMP3:""!=t.canPlayType('audio/ogg; codecs="vorbis"')&&(e=LIGHTS.Config.musicOGG)),null!==e?(t.setAttribute("preload","auto"),t.setAttribute("src",e),this.canPlayThroughListener=bind(this,this.loadTweets),t.addEventListener("canplaythrough",this.canPlayThroughListener,!0),t.load(),LIGHTS.musicAudio=t):console.error("Error: loadMusic")},loadTweets:function(){if(LIGHTS.musicAudio.removeEventListener("canplaythrough",this.canPlayThroughListener,!0),LIGHTS.tweets=[],this.isServerOk=!1,LIGHTS.releaseBuild)try{var t=document.createElement("script");t.type="text/javascript",t.src=LIGHTS.Config.tweetsFeed,document.body.appendChild(t),this.timeout=setTimeout("LIGHTS.Loader.prototype.instance.onLoadTweetsError()",5e3)}catch(t){console.error("Error: loadTweets",t),this.onLoadTweetsError()}else this.onLoadTweetsError()},onLoadTweetsError:function(){this.loadAvatarImages([])},onTweetsLoaded:function(t){clearTimeout(this.timeout);var e,i,s,a,r=[];if("error"==t.result)console.error("Error: onTweetsLoaded",t);else{LIGHTS.releaseBuild||console.log("onTweetsLoaded!",t.entries[0]);var o=t.entries;for(s=0,a=o.length;s<a;s++)e=(i=o[s].actor).id.substr(i.id.lastIndexOf("/")+1),-1==LIGHTS.tweets.indexOf(e)&&(LIGHTS.tweets.push(e),r.push(i.avatar),LIGHTS.releaseBuild||console.log(e,i.avatar))}for(s=0,a=r.length;s<a;s++)r[s]=LIGHTS.Config.avatarHandler+encodeURI(r[s]);this.loadAvatarImages(r)},loadAvatarImages:function(t){if(!this.avatarsLoaded){this.avatarsLoaded=!0,LIGHTS.releaseBuild||console.log("loadAvatarImages");var e,i,s=0;for(e=LIGHTS.tweets.length,i=this.totalTweets;e<i;e++)t.push(LIGHTS.Config.defaultAvatars[s]),LIGHTS.tweets.push(LIGHTS.Config.defaultTweets[s]),s++;for(e=0,i=this.totalTweets;e<i;e++)LIGHTS.Config.images["avatar"+e]=t[e];this.loadImages()}},strip:function(t){var e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText},loadImages:function(){var t=bind(this,this.loadFont),e=0,i=0;for(var s in LIGHTS.Config.images)i++,LIGHTS.images[s]=new Image,LIGHTS.images[s].onload=function(){++e>=i&&t()},LIGHTS.images[s].src=LIGHTS.Config.images[s]},loadFont:function(){var t=bind(this,this.onLoaderComplete);client=new XMLHttpRequest,client.open("GET",LIGHTS.Config.font),client.onreadystatechange=function(e){e.currentTarget.readyState==XMLHttpRequest.DONE&&(LIGHTS.DotsFont=new LIGHTS.BitmapFont(client.responseText,LIGHTS.images.font),t())},client.send()},onLoaderComplete:function(){this.callback()}},LIGHTS.BeatEvents=function(t){this.initialize(t)},LIGHTS.BeatEvents.prototype={colors:[128,4194432,16512],initialize:function(t){this.director=t,this.terrain=t.terrain,this.displacement=t.terrain.displacement,this.tileManager=t.tileManager,this.player=t.player,this.skybox=t.skybox,this.vox=t.vox,this.stars=this.tileManager.stars,this.terrainDots=this.tileManager.terrainDots,this.terrainMesh=this.tileManager.terrainMesh,this.balls=this.tileManager.balls,this.cannons=this.tileManager.cannons,this.beatData=LIGHTS.Music.beatData,this.beats=0},start:function(){LIGHTS.Music.startTime>0?this.lastTime=LIGHTS.Music.startTime:this.lastTime=this.beatData.start-this.beatData.freq,this.nextIncluded=0,this.included=!0,this.color=0,this.beats=0},stop:function(){this.vox.stop()},update:function(){this.included&&LIGHTS.time>this.beatData.included[this.nextIncluded]&&(this.nextIncluded++,this.included=this.nextIncluded<this.beatData.included.length),LIGHTS.time>=this.beatData.start&&LIGHTS.time<this.beatData.end&&LIGHTS.time-this.lastTime>this.beatData.freq&&(this.lastTime+=this.beatData.freq,-1==this.beatData.excluded.indexOf(this.lastTime)&&this.beat())},launch:function(){switch(LIGHTS.Music.phase.index){case 0:this.terrain.reset(),this.terrainMesh.active=!1,this.displacement.active=!1,this.cannons.active=!1,this.balls.active=!0,this.balls.launch(),this.stars.active=!0,this.stars.launch(),this.terrainDots.launch(),this.terrainDots.active=!0,this.tileManager.apply(),this.player.launch(),this.skybox.mesh.visible=!1,this.director.spectrumEvents.start(1/4e3,8);break;case 1:this.terrainMesh.active=!0,this.terrainMesh.launch(),this.vox.start(),this.nextBeat=3;break;case 2:case 20:this.terrainMesh.launch(),this.terrainDots.launch(),this.balls.launch();break;case 3:this.balls.launch(),this.terrainDots.launch(),this.terrainMesh.launch(),this.terrainDots.active=!0,this.tileManager.apply(),this.player.launch(),this.skybox.mesh.visible=!0;break;case 4:case 5:case 6:this.terrainDots.launch(),this.balls.launch();break;case 7:this.balls.launch(),this.terrainMesh.launch(),this.terrainDots.launch(),this.tileManager.apply(),this.player.launch(),this.skybox.mesh.visible=!1;break;case 8:this.balls.launch(),this.terrainMesh.launch(),this.terrainDots.active=!1,this.tileManager.apply();break;case 9:this.player.launch(),this.balls.launch(),this.tileManager.apply();break;case 10:this.balls.launch(),this.tileManager.apply();break;case 11:this.balls.launch(),this.player.launch(),this.terrainMesh.launch(),this.terrainDots.active=!0,this.terrainDots.launch(),this.tileManager.apply(),this.skybox.mesh.visible=!0;break;case 12:this.balls.launch(),this.terrainDots.launch(),this.tileManager.apply();break;case 13:this.balls.launch(),this.terrainMesh.launch(),this.terrainDots.launch(),this.tileManager.apply(),this.player.launch();break;case 14:this.terrainMesh.launch();break;case 15:this.balls.launch(),this.terrainDots.launch(),this.terrainMesh.launch(),this.tileManager.apply(),this.displacement.active=!0,this.director.spectrumEvents.start(5e-4,4),this.player.launch();break;case 16:this.terrainMesh.launch(),this.terrainDots.launch(),this.balls.launch(),this.tileManager.apply(),this.player.launch(),this.skybox.mesh.visible=!1;break;case 17:this.terrainMesh.launch(),this.terrainDots.launch(),this.balls.launch(),this.cannons.active=!0,this.cannons.launch(),this.tileManager.apply(),this.player.launch(),this.displacement.launchFlat2Terrain(),this.skybox.mesh.visible=!0;break;case 18:this.terrainMesh.launch(),this.terrainDots.launch(),this.balls.launch(),this.player.launch(),this.displacement.active=!1;break;case 19:this.cannons.launch(),this.terrainMesh.launch(),this.terrainDots.launch(),this.balls.launch();break;case 21:this.terrainDots.active=!0,this.terrainDots.launch(),this.balls.launch(),this.terrainMesh.launch(),this.tileManager.apply(),this.displacement.active=!0,this.director.spectrumEvents.start(1/4e3,4),this.player.launch();break;case 22:this.skybox.mesh.visible=!1,this.balls.launch(),this.terrainMesh.launch(),this.player.launch(),this.terrainDots.launch(),this.cannons.launch(),this.stars.launch(),this.vox.finish();break;case 23:this.cannons.active=!1,this.terrainDots.active=!1,this.terrainMesh.active=!1,this.balls.active=!1,this.tileManager.apply(),LIGHTS.Lights.instance.playHome()}},beat:function(){switch(LIGHTS.Music.phase.index){case 1:0==this.nextBeat?(this.balls.beat(),this.terrainDots.beat()):1==this.nextBeat?(this.vox.launch(),this.balls.launch(),this.terrainDots.launch(),this.terrainMesh.launch(),this.balls.active=!0,this.terrainMesh.active=!0,this.tileManager.apply(),this.player.launch(),this.nextBeat--):this.nextBeat--;break;case 2:case 3:case 4:case 5:this.balls.beat(),this.terrainDots.beat();break;case 6:this.balls.beat(),this.terrainDots.beat(),this.terrainMesh.beat();break;case 7:this.terrainMesh.beat();break;case 8:case 9:case 10:this.balls.beat(),this.terrainMesh.beat();break;case 11:case 12:case 17:case 18:case 19:case 20:case 21:this.balls.beat(),this.terrainMesh.beat(),this.terrainDots.beat();break;case 13:case 22:this.terrainDots.beat();break;case 14:case 15:this.terrainMesh.beat(),this.terrainDots.beat()}this.beats++}},LIGHTS.Music={startTime:0,mute:!1,phase:{times:[7,24.5,40,48,55.5,64,72,80,88,96,104,112,120,128,136,149.75,152,160,168,176,184,200,210],index:0},beatData:{start:7,go:24,end:204,freq:.5,excluded:[40,48,55.5,64,70,70.5,71,104,112,120,128,136,150,150.5,151,151.5,152,160,168,176,184,200],included:[69.75,71.25,71.375,71.75,149.75]}},LIGHTS.Director=function(t){this.initialize(t)},LIGHTS.Director.prototype={initialize:function(t){this.view=t,this.player=new LIGHTS.Player(this),this.vox=new LIGHTS.Vox(this),this.materialCache=new LIGHTS.MaterialCache(this),this.terrain=new LIGHTS.Terrain(this),this.tileManager=new LIGHTS.TileManager(this),this.skybox=new LIGHTS.Skybox(this),this.beatEvents=new LIGHTS.BeatEvents(this),this.volumeEvents=new LIGHTS.VolumeEvents(this),this.spectrumEvents=new LIGHTS.SpectrumEvents(this),this.music=LIGHTS.musicAudio},start:function(){this.lastTime=(new Date).getTime(),this.music.currentTime=LIGHTS.time=LIGHTS.Music.startTime,this.music.play(),this.music.volume=LIGHTS.Music.mute?0:1,LIGHTS.deltaTime=0,this.view.start(),LIGHTS.Music.phase.index=0,this.launch(),this.beatEvents.start(),this.volumeEvents.start(),this.isFast=!1,this.active=!0},stop:function(){this.active=!1,this.music.pause(),this.view.stop(),this.vox.stop(),this.beatEvents.stop()},update:function(){!LIGHTS.releaseBuild&&LIGHTS.Input.keySpace&&LIGHTS.Lights.instance.playHome();var t=(new Date).getTime();-1!=this.lastTime?!LIGHTS.releaseBuild&&LIGHTS.Input.keyUp?(this.isFast||(this.isFast=!0,this.music.volume=0),LIGHTS.deltaTime=(t-this.lastTime)/1e3+.1,LIGHTS.time+=LIGHTS.deltaTime):(LIGHTS.deltaTime=(t-this.lastTime)/1e3,this.isFast?(this.isFast=!1,this.music.volume=LIGHTS.Music.mute?0:1,this.music.currentTime=LIGHTS.time+LIGHTS.deltaTime):LIGHTS.time=this.music.currentTime):LIGHTS.time=LIGHTS.deltaTime=this.music.currentTime,LIGHTS.deltaTime=Math.min(LIGHTS.deltaTime,.2),this.lastTime=t,LIGHTS.time>LIGHTS.Music.phase.times[LIGHTS.Music.phase.index]&&(LIGHTS.Music.phase.index++,this.launch(),LIGHTS.time>LIGHTS.Music.phase.times[LIGHTS.Music.phase.index]&&(this.beatEvents.beat(),this.beatEvents.beat(),this.beatEvents.beat(),this.beatEvents.beat())),this.player.update(),this.vox.update(),this.terrain.update(),this.tileManager.update(),this.beatEvents.update(),this.volumeEvents.update(),this.spectrumEvents.update(),this.skybox.update()},postUpdate:function(){this.tileManager.balls.raycast()},launch:function(){this.beatEvents.launch(),LIGHTS.releaseBuild||console.log("Phase: "+LIGHTS.Music.phase.index)}},LIGHTS.SpectrumEvents=function(t){this.initialize(t)},LIGHTS.SpectrumEvents.prototype={amplitudeTarget:1/4096,spectrumData:[],initialize:function(t){this.director=t,this.displacement=t.terrain.displacement,this.vox=t.vox,this.displacement.spectrum=[],this.averageSpectrum=[],this.createSpectrumData()},createSpectrumData:function(){var t,e,i,s,a,r,o,n,h,l=LIGHTS.images.spectrumData,c=document.createElement("canvas"),d=c.getContext("2d");for(c.width=l.width,c.height=l.height,d.drawImage(l,0,0),t=d.getImageData(0,0,l.width,l.height).data,a=0,e=0,i=Math.floor(t.length/256);e<i;e++)for(h=this.spectrumData[e]=[],s=0;s<64;s++)r=t[a++],o=t[a++],n=t[a++],t[a++],h[s]=(r<<16)+(o<<8)+n},start:function(t,e){this.amplitudeTarget=t,this.blur=e,this.offset=0,this.amplitude=0;var i,s,a=this.displacement.spectrum;for(i=0,s=this.spectrumData[0].length;i<s;i++)a[i]=0},update:function(){if(LIGHTS.Music.phase.index<23){var t,e,i,s,a,r,o,n,h=LIGHTS.deltaTime,l=20*h,c=10*h,d=this.spectrumData,p=this.averageSpectrum,u=this.displacement.spectrum,m=this.vox.spectrum,T=this.offset,g=Math.floor(60*LIGHTS.time),f=d[g],y=this.blur,v=2*y+1,b=this.amplitude/v;if(g>0){for(e=0,i=f.length;e<i;e++){for(t=0,s=e-y,a=e+y;s<=a;s++)t+=s>=0?f[s%i]:f[(s+i)%i];p[e]=t*b}for(e=0,i=f.length;e<i;e++)o=e+T*i,o-=r=Math.floor(o),t=p[r%i]*(1-o)+p[(r+1)%i]*o,n=u[e],u[e]-=n>t?(n-t)*l:(n-t)*c,m[e]=u[e];this.offset=(this.offset+LIGHTS.deltaTime)%1,this.amplitude-=(this.amplitude-this.amplitudeTarget)*(LIGHTS.deltaTime/4)}}}},LIGHTS.VolumeData={vox:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,7,28,54,144,247,302,306,337,327,330,302,322,295,282,267,249,249,243,263,280,284,293,291,308,282,301,303,288,311,289,308,237,159,198,210,217,233,234,266,278,276,281,314,283,269,281,267,250,288,299,338,354,379,336,369,360,343,347,341,361,316,354,318,313,323,312,331,311,322,286,304,298,295,286,255,283,280,291,315,280,260,255,220,253,257,285,269,261,216,178,162,149,129,114,122,467,558,612,553,443,419,445,537,546,486,458,463,474,487,485,476,476,466,452,429,414,421,423,444,442,457,450,452,443,425,396,413,405,400,424,440,442,455,437,430,439,441,437,452,452,447,447,439,426,416,424,423,434,426,426,431,439,417,335,426,433,403,402,405,396,382,387,385,386,396,404,391,351,335,296,310,330,343,347,332,317,324,304,297,307,337,361,364,366,360,368,337,312,243,188,138,65,34,34,41,77,96,113,113,102,91,96,91,90,86,74,47,31,19,16,26,53,63,134,772,753,584,467,382,363,402,434,487,470,478,457,461,489,482,491,468,478,449,418,398,345,194,224,248,253,187,97,730,614,511,463,419,404,398,395,375,389,427,407,398,440,473,483,473,473,432,418,409,413,442,426,395,388,401,398,376,362,491,512,508,475,494,483,493,452,408,375,359,370,366,303,291,283,399,523,465,420,402,389,381,367,389,397,374,359,358,403,460,480,474,440,428,435,418,422,346,341,361,376,396,387,390,382,383,399,417,410,389,384,393,387,371,245,101,52,31,36,33,32,214,484,522,455,427,431,436,423,440,440,441,423,393,388,413,414,414,393,389,402,409,404,383,383,393,398,382,388,381,380,382,390,404,403,395,392,389,384,372,382,369,375,370,376,393,323,430,417,401,390,391,358,366,368,359,392,385,383,381,350,396,356,339,341,321,344,300,320,307,315,287,220,284,252,315,346,347,317,334,294,262,198,109,69,78,72,67,73,73,60,67,66,61,62,60,62,61,56,54,65,57,60,45,59,36,41,45,44,42,38,37,41,38,30,33,28,30,30,33,28,31,33,35,33,37,44,46,48,48,47,54,56,59,68,71,77,73,76,62,59,69,62,48,15,14,18,187,45,110,265,249,277,303,334,368,380,340,356,284,298,254,241,243,241,259,264,266,251,250,262,247,269,301,320,286,142,87,195,240,225,239,212,203,222,223,220,215,196,194,130,144,145,143,162,209,324,368,360,338,351,327,377,351,379,333,370,316,312,318,284,292,253,259,216,218,188,198,159,145,147,164,160,156,149,116,121,133,132,146,132,134,123,107,100,119,129,134,139,209,457,547,531,559,509,449,405,444,558,530,479,485,456,457,463,462,455,451,473,466,481,459,375,349,396,414,471,466,334,380,394,362,360,391,399,411,402,400,388,379,399,380,375,375,364,348,403,458,457,443,416,399,416,409,431,421,420,426,419,396,358,348,353,338,304,246,168,84,34,26,31,48,70,90,110,142,145,165,137,137,141,119,118,61,18,18,17,20,162,239,508,563,486,451,409,294,101,78,74,94,143,149,154,220,332,548,545,361,308,322,199,35,24,24,21,34,157,116,55,59,376,725,579,465,426,374,363,351,361,424,455,446,420,411,423,449,473,513,487,365,299,342,400,469,267,101,141,169,337,360,389,388,365,326,284,265,255,243,228,213,186,180,208,287,563,556,503,472,437,411,414,418,411,447,497,509,504,465,448,487,464,420,325,370,386,438,488,444,345,223,134,63,76,224,305,461,463,424,393,388,374,349,334,330,320,327,325,327,321,312,316,331,315,302,307,299,297,250,115,63,60,75,84,144,231,268,267,220,136,73,84,74,87,84,64,62,92,84,67,182,219,277,337,347,350,352,320,361,347,335,335,321,364,311,337,321,352,344,335,361,320,338,331,334,355,334,348,376,375,378,370,336,338,360,324,348,326,335,359,321,343,319,327,355,335,382,389,368,392,367,362,372,340,373,375,362,389,368,376,392,368,370,375,351,371,399,380,359,384,382,359,367,414,412,430,403,372,348,350,343,329,335,312,326,315,338,349,334,340,337,336,334,342,329,336,312,297,262,211,150,99,36,20,22,24,23,25,25,28,28,25,24,24,34,35,35,33,30,31,29,26,30,27,28,32,30,28,31,32,32,34,32,31,33,34,35,38,37,41,38,40,40,39,41,42,39,43,34,42,34,30,23,13,6,7,10,57,98,13,8,7,6,7,11,25,370,511,595,565,543,521,502,490,456,399,423,392,419,445,446,470,467,418,362,337,309,308,349,369,384,403,417,428,437,448,445,444,441,435,456,453,450,464,433,369,420,418,424,575,597,462,455,439,465,539,534,539,478,427,427,416,292,38,31,85,251,249,287,285,304,295,334,310,294,281,190,208,77,64,282,784,638,557,511,498,499,545,516,507,498,490,503,478,493,484,494,458,460,434,341,31,33,45,47,53,47,58,91,73,97,793,623,507,461,437,463,479,478,485,510,492,500,483,428,406,427,431,451,440,448,478,418,424,388,412,384,344,370,344,576,566,536,364,307,289,303,289,351,446,452,445,479,444,414,406,439,438,441,453,447,439,437,437,420,436,454,442,433,449,444,413,465,440,405,412,416,425,442,455,428,397,388,375,381,401,383,406,458,467,443,423,389,381,448,473,519,518,482,480,460,457,490,505,497,462,443,414,427,431,395,411,412,398,279,157,162,193,162,176,158,135,121,114,113,116,115,134,122,123,121,126,150,153,150,138,134,107,98,110,98,67,93,85,87,663,787,591,489,474,490,483,512,421,332,155,153,160,145,145,136,77,859,521,640,658,523,467,433,435,438,442,436,432,445,462,469,412,376,341,358,359,336,257,207,82,81,85,84,85,131,140,168,219,372,468,458,409,376,406,444,421,406,411,337,227,231,238,217,236,270,242,82,50,48,77,183,252,239,282,225,138,416,535,490,433,411,388,383,396,392,377,371,364,374,375,316,226,149,132,148,153,144,155,143,146,165,161,190,288,457,572,507,470,424,449,493,449,378,295,271,304,282,260,239,245,227,236,234,227,220,195,92,37,33,31,26,30,29,31,145,207,127,63,179,301,318,334,331,331,327,325,321,336,338,321,321,271,163,90,68,30,23,20,21,21,22,22,26,64,292,414,388,378,383,403,407,398,405,389,374,366,358,348,362,348,349,379,390,406,394,390,387,365,365,372,379,375,384,380,361,361,348,365,353,342,337,312,286,207,109,30,20,24,48,110,67,34,35,51,62,68,72,76,85,87,92,89,91,91,90,101,100,106,108,100,105,106,94,75,40,15,12,18,151,57,308,678,621,569,552,549,425,345,444,453,364,226,177,191,302,694,560,577,459,427,498,643,674,572,513,472,438,457,464,437,429,383,381,370,380,359,330,303,369,395,297,167,151,194,256,651,822,707,498,487,478,512,507,429,375,348,159,64,48,36,41,45,53,49,51,49,49,44,37,34,43,37,31,28,120,119,104,88,160,989,783,583,527,475,459,423,435,480,498,478,479,471,473,421,392,322,70,43,53,46,43,33,47,86,89,267,919,621,518,461,463,453,464,472,476,471,466,439,407,432,441,429,437,438,429,408,408,412,392,422,397,417,395,446,595,371,341,355,325,344,377,380,399,395,391,380,402,428,418,410,416,419,422,417,401,412,400,415,395,407,422,433,394,404,400,408,409,405,417,425,418,426,427,438,437,440,471,473,473,470,437,462,470,459,440,463,424,444,450,460,461,446,408,395,397,400,452,448,431,425,358,342,357,404,437,435,433,438,339,156,48,53,48,40,33,52,60,81,84,80,70,75,76,87,75,70,73,68,94,72,62,58,54,68,54,38,29,68,115,434,577,511,408,307,300,305,288,291,300,315,281,154,105,112,337,717,842,436,541,721,683,618,545,536,501,500,504,425,427,419,365,219,135,62,102,82,62,65,86,84,70,72,63,82,53,81,376,744,617,564,383,360,375,379,403,406,408,454,449,422,391,345,336,291,199,339,469,462,494,425,395,377,383,376,413,429,443,403,364,345,365,395,451,398,357,345,341,316,300,364,454,450,399,339,323,267,176,131,74,67,64,60,56,60,53,121,258,269,171,181,314,356,390,419,376,273,143,58,66,75,75,75,82,108,89,70,61,59,60,48,52,77,72,46,78,76,229,484,515,496,469,411,405,358,336,314,258,209,162,232,312,302,342,337,344,346,278,242,104,211,240,275,283,308,309,359,427,397,392,375,373,387,367,396,372,359,347,332,329,341,370,378,380,361,399,424,368,350,400,381,313,286,294,182,113,92,85,58,29,56,61,56,51,84,80,61,70,92,89,92,98,103,113,107,94,105,91,75,58,47,29,30,96,609,834,817,690,679,497,496,491,522,503,485,563,562,583,550,430,661,505,816,700,823,724,774,696,855,832,778,841,522,350,288,644,659,724,672,731,799,618,539,411,504,544,671,895,872,868,703,603,789,673,626,664,716,648,713,732,628,680,833,812,656,345,130,139,203,358,446,469,461,425,374,310,269,142,77,95,139,613,893,714,752,664,778,632,718,693,662,361,195,99,277,325,434,379,406,465,462,432,432,419,421,357,199,86,69,128,352,717,814,743,521,664,737,741,631,499,202,137,138,277,422,557,666,684,850,872,713,681,746,658,881,609,523,402,215,91,103,139,209,243,203,162,135,90,90,86,81,73,98,330,412,708,680,748,787,769,761,766,766,693,758,758,769,790,833,688,616,521,566,513,447,371,294,190,123,88,88,134,258,416,483,294,460,694,759,782,681,619,743,718,732,641,556,327,262,172,110,119,129,108,104,133,192,253,301,395,418,343,235,116,49,204,771,891,744,726,688,610,766,782,713,762,818,702,573,505,689,773,723,719,673,714,767,691,707,745,707,712,778,768,702,599,605,758,773,749,845,813,721,667,698,729,677,514,397,493,679,797,622,679,578,524,419,402,567,723,682,572,462,636,445,367,435,504,601,624,377,367,435,467,480,524,509,529,558,449,452,849,679,780,826,755,813,770,720,758,729,758,734,643,617,699,621,555,586,553,332,269,182,119,82,83,92,173,285,524,563,788,798,738,681,657,682,560,620,538,501,266,150,74,76,89,149,231,271,298,314,278,202,189,155,123,59,51,47,106,660,1005,922,856,746,668,714,631,585,674,657,563,593,557,755,792,755,795,705,611,703,777,829,770,697,672,502,518,516,620,850,695,636,667,760,807,761,727,651,711,816,788,735,586,863,752,699,675,713,789,724,773,763,710,766,843,839,898,744,724,703,750,816,778,710,668,643,618,598,736,781,815,784,777,716,776,710,717,779,742,581,618,721,742,808,889,769,613,626,459,471,457,491,518,425,337,317,283,184,140,143,127,120,99,99,96,97,92,85,83,86,82,88,74,75,73,64,67,61,70,69,82,81,80,82,94,72,104,90,88,60,63,48,31,108,452,742,670,614,493,397,364,368,398,373,397,408,390,410,362,452,696,854,700,712,687,790,685,619,762,702,720,621,758,734,776,866,718,752,717,673,591,649,366,105,99,79,244,424,365,286,596,876,863,756,790,743,701,888,806,678,487,462,496,650,751,669,691,529,483,511,127,77,80,83,80,94,175,411,542,675,767,710,575,486,650,639,589,598,591,494,452,490,430,458,380,351,390,358,289,278,241,220,255,312,354,374,381,352,322,486,814,747,732,590,605,671,692,613,456,351,152,150,110,97,307,891,835,738,785,707,742,837,834,547,504,317,113,92,134,182,213,238,247,246,232,239,286,283,218,119,76,78,94,182,465,884,844,801,798,743,854,672,625,530,534,644,893,781,545,708,740,657,536,382,181,123,76,76,77,87,120,140,138,297,768,683,590,469,446,521,739,746,657,480,325,207,116,115,166,191,187,173,162,118,92,70,172,337,419,419,375,374,326,463,825,766,864,852,754,723,733,701,695,772,739,669,878,845,793,692,624,554,750,857,904,817,729,825,858,799,578,753,741,663,694,745,612,831,813,619,599,757,719,694,770,651,508,395,501,803,690,619,682,716,680,714,693,669,634,708,544,584,717,618,717,761,695,572,550,512,492,464,363,264,212,156,352,383,323,505,686,950,982,898,918,877,739,718,743,701,700,839,840,763,678,586,521,532,656,778,481,352,265,132,158,200,491,607,512,791,891,615,566,630,613,711,744,647,773,664,795,712,437,333,162,84,115,182,209,222,222,214,197,157,98,59,63,58,66,345,759,722,755,697,738,613,650,726,739,744,704,535,621,666,744,766,779,737,824,794,770,830,646,528,397,318,144,81,103,152,215,223,240,210,209,160,146,101,63,145,231,225,229,340,821,935,594,824,732,603,659,706,769,728,745,636,526,739,817,541,486,686,868,904,867,851,831,850,857,753,730,795,723,671,725,775,607,676,562,687,803,810,790,705,460,393,309,148,139,131,166,204,205,238,242,223,172,100,72,75,80,81,152,456,502,863,841,849,790,752,730,700,795,710,637,653,649,743,802,734,423,389,361,326,352,350,356,328,294,244,163,101,102,139,673,786,803,736,819,753,698,688,710,600,565,781,706,629,647,628,552,750,620,469,400,334,104,63,65,71,94,114,240,434,456,878,641,826,886,853,883,871,827,702,620,662,660,690,872,804,750,752,705,778,902,810,750,727,771,675,638,642,586,626,721,715,606,613,680,553,547,531,523,713,603,350,377,263,198,136,187,244,230,217,202,175,134,98,64,59,54,360,367,425,666,802,746,821,765,790,788,661,777,740,729,753,720,663,845,837,746,851,887,814,819,734,657,820,883,716,606,725,689,619,674,698,744,701,659,584,591,623,665,698,662,578,462,406,287,157,159,177,169,169,170,157,111,94,109,94,74,75,315,412,648,682,751,932,766,635,725,715,700,693,724,803,813,818,823,833,821,793,752,770,868,953,930,868,816,797,637,463,648,742,853,801,782,733,690,704,703,803,785,700,587,359,171,88,96,143,211,216,207,185,160,140,108,102,87,83,91,85,228,387,812,869,882,897,934,927,713,884,790,742,792,842,724,506,192,82,65,102,132,128,127,131,115,127,91,91,92,110,164,359,819,769,716,666,700,702,726,659,741,712,676,383,372,379,388,239,246,248,261,242,191,134,110,139,73,80,69,71,304,485,500,929,766,757,724,690,691,641,656,720,850,796,773,712,731,653,710,596,773,734,754,810,686,786,788,563,547,608,632,735,590,571,644,729,753,735,754,850,616,473,449,538,480,291,178,107,186,206,206,222,220,204,154,99,66,68,64,51,379,459,546,647,567,751,821,817,808,719,728,689,596,501,502,657,522,568,630,664,773,694,655,699,643,708,626,786,692,686,812,716,788,780,669,738,671,655,655,745,747,772,678,434,438,308,250,148,178,221,224,195,178,151,108,100,113,96,83,84,299,405,595,686,818,881,785,626,676,681,632,719,827,790,579,651,524,575,508,590,604,645,745,685,756,544,584,708,578,718,718,726,720,752,684,657,671,723,764,666,466,401,435,318,171,162,170,199,218,230,208,233,218,182,151,122,89,81,213,435,538,742,804,828,855,788,880,861,774,811,761,667,634,659,746,720,805,793,817,687,768,759,682,596,554,642,587,489,530,469,547,568,734,657,694,694,637,633,614,630,681,626,629,634,605,583,563,612,734,818,843,850,730,729,807,755,663,670,741,651,480,503,613,877,807,730,796,848,782,739,696,765,864,873,851,841,833,716,679,815,797,706,791,662,776,708,715,663,583,638,564,533,190,116,142,235,379,454,435,420,403,324,243,141,75,87,456,745,849,752,696,638,767,625,612,530,489,314,125,80,128,305,298,330,272,284,325,305,275,253,340,393,371,288,287,191,200,503,936,780,781,797,775,676,680,683,402,163,58,160,259,449,523,856,797,734,860,864,835,841,799,551,407,404,329,188,98,122,179,196,197,183,158,123,115,92,76,94,75,95,323,436,622,810,854,757,700,742,676,705,623,659,719,726,677,705,657,581,732,606,366,314,243,157,91,79,63,73,145,301,370,396,677,840,851,796,637,589,805,709,619,512,517,499,427,454,357,321,246,180,202,207,223,267,335,375,397,395,365,348,376,397,643,922,863,783,790,773,725,737,837,754,824,818,900,819,837,830,677,752,785,870,680,762,826,765,801,846,715,886,700,813,768,858,840,805,790,731,797,756,657,803,822,710,584,539,668,742,702,637,522,638,630,707,714,647,712,559,406,774,732,885,657,786,789,731,710,587,502,522,542,555,565,577,625,550,461,472,757,861,701,794,886,644,701,873,734,670,597,526,591,677,721,636,614,578,566,578,484,493,290,297,390,404,381,408,599,728,668,478,526,592,559,692,609,608,396,169,102,92,123,152,151,183,204,209,197,191,173,145,109,99,71,56,57,223,535,928,917,693,795,818,759,784,706,640,697,769,549,549,689,714,818,709,759,828,872,772,750,740,630,569,647,684,536,488,432,563,799,831,905,951,705,558,643,781,862,850,782,623,898,858,758,701,722,706,727,852,781,847,885,807,841,722,808,707,750,709,698,734,711,681,760,786,688,726,788,739,710,676,698,741,715,661,711,771,758,812,879,833,795,879,879,843,786,782,836,840,809,750,746,757,727,694,625,596,696,789,828,767,696,724,751,788,786,688,791,766,607,773,802,729,682,732,771,702,751,716,756,695,710,693,806,643,802,684,702,780,764,784,711,837,726,849,776,767,789,809,794,782,793,861,841,802,865,784,723,772,708,737,807,855,817,712,730,664,676,729,688,676,760,738,720,730,707,689,648,781,779,683,746,690,733,714,622,572,717,555,505,649,695,700,665,553,538,637,625,542,462,531,580,509,566,549,559,558,588,517,394,345,404,279,243,278,189,295,263,287,245,184,220,140,179,171,199,265,232,303,389,405,393,435,380,238,749,723,749,681,548,558,615,520,596,620,662,693,700,733,708,690,629,545,605,665,681,621,654,482,433,470,493,537,539,568,565,528,533,520,541,516,528,543,539,503,520,484,520,531,505,544,553,551,546,530,517,529,531,530,535,514,511,511,518,525,537,514,498,480,462,456,456,483,475,393,457,497,467,455,448,411,376,314,244,303,329,338,206,54,29,71,153,214,265,271,254,251,203,186,184,142,111,68,25,43,65,212,656,829,737,680,644,663,686,447,42,24,27,30,37,41,121,113,69,532,809,796,733,696,704,659,646,641,615,582,544,529,526,595,652,738,727,712,688,627,551,246,107,133,177,136,113,89,118,317,577,682,675,669,611,568,562,578,550,528,527,508,501,530,558,555,522,406,162,190,182,186,196,179,158,132,131,154,187,334,699,768,584,618,631,634,619,562,547,534,537,550,562,572,524,496,504,481,424,442,449,478,505,459,489,465,446,426,367,357,308,352,361,368,343,352,365,370,379,373,378,343,329,319,308,290,292,319,340,333,321,297,262,233,155,99,91,113,194,400,396,368,408,416,387,397,372,372,370,337,321,289,272,250,257,267,292,307,331,337,308,318,339,376,408,394,302,269,291,306,336,358,407,412,448,447,428,420,446,417,399,431,401,381,381,420,455,474,451,477,446,438,468,445,453,436,455,441,462,487,459,470,475,454,459,495,503,505,499,480,486,441,413,445,471,451,420,347,299,299,321,349,358,286,273,244,224,172,180,212,245,172,205,219,226,228,219,205,198,203,188,173,150,173,216,201,196,216,210,211,207,212,203,177,169,174,260,309,317,344,331,324,319,333,341,346,318,294,288,245,241,213,182,177,171,153,132,115,118,105,103,98,95,88,100,113,143,184,134,381,288,388,420,386,391,423,353,341,316,322,276,179,86,67,64,53,57,59,104,250,472,435,401,376,405,327,190,95,162,189,193,186,186,187,227,242,254,284,324,268,154,64,42,34,316,374,339,336,336,354,380,375,357,385,352,389,343,353,351,328,336,282,285,260,270,274,287,267,228,178,189,203,229,224,235,248,216,177,167,236,331,276,290,288,270,287,288,194,27,29,211,347,637,539,663,677,647,607,629,613,587,570,588,590,568,555,565,577,560,573,573,572,593,585,549,553,551,543,588,566,513,511,461,479,501,518,541,516,529,513,511,509,532,531,522,548,518,488,470,475,494,466,546,600,591,577,581,588,548,518,543,479,430,346,215,91,44,36,58,84,110,128,127,144,145,151,146,160,156,159,150,178,173,114,55,37,54,71,84,714,717,583,498,452,441,467,500,518,476,397,298,358,65,48,48,83,115,145,177,166,112,56,29,49,112,152,205,514,804,804,755,706,660,654,648,587,576,572,565,561,548,551,536,535,553,537,539,503,71,64,61,46,41,43,64,39,96,102,705,838,648,561,553,536,542,529,535,533,505,467,451,487,567,544,536,526,528,542,590,608,520,179,231,239,252,233,250,223,120,55,100,543,837,659,638,574,513,506,517,491,469,489,469,397,363,392,439,489,481,468,475,472,470,474,407,141,54,62,52,49,293,683,586,522,473,462,509,543,546,554,557,541,570,614,635,617,622,583,494,358,169,35,48,40,35,43,50,43,46,64,433,629,611,573,550,549,537,529,518,514,526,514,506,480,521,631,591,593,585,583,584,568,568,573,579,573,567,581,547,586,564,573,557,515,533,532,514,509,487,467,495,474,439,465,499,517,519,551,557,542,544,508,519,548,551,573,550,550,498,415,242,78,74,108,116,116,103,88,86,70,51,51,45,42,31,26,23,25,28,36,27,21,22,26,23,15,14,16,16,18,19,18,19,14,9,11,13,17,18,11,9,10,12,12,12,12,13,10,12,13,14,14,15,17,18,20,25,31,31,36,43,56,55,51,60,63,70,63,77,85,98,96,117,120,132,136,146,146,120,97,87,72,60,23,11,20,8,7,174,518,652,653,620,583,568,457,385,418,438,472,470,473,473,478,523,541,540,530,561,570,615,600,464,210,169,417,658,280,85,149,499,682,711,645,558,527,545,598,568,512,494,470,468,461,504,569,557,514,303,171,111,109,105,111,89,84,91,169,140,310,761,627,566,570,564,552,521,542,531,521,532,613,497,276,111,69,57,66,112,104,113,87,75,58,50,44,38,87,336,470,866,615,611,667,584,579,568,562,569,556,554,565,575,559,542,454,435,269,112,61,45,41,53,49,41,39,114,286,315,327,860,736,637,567,507,525,507,527,520,517,564,555,537,567,550,585,585,582,531,547,534,578,584,502,259,120,91,111,431,861,625,538,541,571,608,599,582,575,581,581,584,579,595,591,596,603,600,597,587,580,596,599,592,594,590,581,580,576,564,565,589,606,612,640,616,577,548,557,607,631,610,569,544,541,556,496,614,594,619,631,620,620,609,563,531,546,517,484,448,263,170,148,151,160,170,215,409,322,142,138,153,155,177,205,161,158,154,158,147,151,149,150,123,87,72,74,73,151,328,604,727,683,687,594,598,581,586,581,561,548,529,515,498,478,447,468,460,484,598,615,602,358,244,250,151,62,52,51,188,716,624,623,590,598,588,581,607,601,610,613,582,588,599,563,582,580,584,545,559,558,527,549,279,107,86,100,105,103,63,50,202,667,617,573,586,584,591,531,503,532,520,473,248,104,45,52,75,90,106,125,138,201,117,69,42,42,38,34,94,624,599,540,533,506,465,500,583,632,637,598,505,399,380,329,334,331,322,309,286,261,254,263,265,302,314,317,325,325,336,351,442,392,348,338,332,337,355,355,346,351,350,360,407,473,524,406,232,236,289,324,293,301,303,283,286,292,295,293,264,225,332,670,692,659,659,503,480,473,469,491,466,414,223,218,308,288,297,303,281,280,286,286,270,256,111,37,31,94,146,397,600,477,425,394,383,368,384,396,410,407,381,277,170,167,250,294,292,313,302,301,302,317,297,278,216,159,135,220,352,480,450,458,542,568,529,512,489,460,426,398,424,437,439,537,678,670,654,593,571,582,548,482,492,475,438,423,249,140,58,38,41,116,103,45,48,71,91,131,128,163,177,177,184,198,183,193,181,186,169,158,129,154,175,78,28,68,38,84,93,265,696,640,806,739,645,629,570,579,580,635,602,587,618,554,562,613,518,501,521,457,493,521,484,485,544,456,497,416,599,592,541,599,594,590,585,567,587,518,594,371,400,236,58,56,115,165,221,269,251,267,248,209,250,202,52,92,172,220,132,831,850,738,636,589,608,609,628,635,608,610,597,588,606,604,600,515,558,578,464,467,485,541,617,549,374,430,584,554,558,555,579,567,612,577,619,621,572,561,587,580,572,578,567,578,585,569,575,559,562,563,526,441,147,66,40,55,79,180,309,999,723,553,623,649,630,664,632,593,607,619,643,610,602,599,584,627,611,612,622,627,611,610,608,584,578,598,628,606,541,604,667,592,507,518,487,544,556,554,558,560,553,535,507,531,538,471,435,497,478,465,499,471,511,508,502,560,498,507,497,369,411,337,277,307,411,393,366,374,387,415,394,365,373,369,239,164,153,158,139,131,131,150,170,158,174,161,177,198,194,178,168,183,192,180,160,153,161,149,147,139,141,154,375,847,811,729,627,648,630,629,611,585,477,400,390,308,537,560,557,633,622,627,644,643,609,600,605,593,578,574,585,563,547,524,517,507,516,493,527,405,209,239,322,320,325,368,266,469,592,574,542,543,534,525,477,518,489,490,489,502,475,425,460,358,132,81,80,91,81,75,197,336,317,207,247,437,479,320,434,496,581,541,590,614,653,599,547,502,466,480,451,366,375,348,320,366,406,405,424,397,321,296,308,314,307,302,315,332,387,417,381,365,337,320,311,311,336,335,357,350,323,198,138,147,152,150,145,163,156,126,108,92,78,71,67,75,108,156,209,294,494,576,510,544,494,437,456,502,557,638,528,439,363,308,266,219,256,267,295,313,319,300,293,300,261,280,298,275,213,452,644,489,426,442,415,441,472,480,527,502,471,423,443,442,474,457,478,494,474,486,559,552,429,415,397,378,356,356,377,405,420,424,424,382,318,268,224,213,242,257,262,251,238,233,279,288,284,284,246,239,192,141,253,221,249,222,243,598,820,640,461,395,551,683,467,537,503,515,542,535,582,538,443,761,586,761,820,770,704,744,680,833,818,688,754,480,346,335,554,699,738,768,720,623,606,605,704,781,813,787,740,820,852,843,692,768,605,677,723,620,813,715,653,542,653,719,742,775,340,149,166,232,362,457,471,445,434,378,332,282,156,97,95,169,751,954,831,736,743,656,654,680,784,597,428,195,125,282,325,422,363,433,443,475,421,418,452,432,371,220,105,91,135,375,884,786,830,767,761,698,717,541,488,246,153,164,277,427,585,924,647,669,582,671,651,675,693,595,481,561,423,222,89,99,150,194,230,205,175,136,103,86,73,75,73,88,320,426,727,694,809,754,804,835,737,750,766,718,670,742,813,750,611,700,724,606,454,425,368,292,186,112,85,85,136,274,412,442,303,406,677,835,802,575,604,654,854,816,714,576,354,268,171,111,120,126,104,102,134,188,250,316,406,432,355,243,122,58,210,766,830,799,746,815,710,744,756,706,685,767,727,709,654,632,815,770,758,711,717,788,637,693,768,778,792,730,716,780,758,752,846,804,767,671,679,626,606,597,702,616,573,494,503,639,770,661,517,550,491,558,559,521,639,626,647,623,677,671,799,765,663,579,526,334,339,439,475,451,507,511,500,512,447,428,863,793,782,716,794,769,759,694,737,728,726,677,572,460,604,671,602,487,476,374,272,192,121,77,76,100,169,286,484,595,859,912,702,634,624,800,637,543,448,477,272,155,94,81,99,148,222,267,287,306,266,211,202,165,119,68,51,48,104,643,1020,855,886,703,677,695,606,598,712,733,528,508,630,677,861,756,728,745,775,823,864,709,662,732,806,661,571,567,516,689,670,668,548,614,752,599,509,476,563,697,767,820,892,812,556,731,648,748,836,670,788,681,756,701,761,764,864,774,713,706,759,779,791,751,644,559,523,543,703,873,809,740,732,741,778,767,721,792,782,732,686,666,591,758,806,769,667,697,469,446,467,491,523,419,339,322,270,183,141,143,121,98,103,101,95,87,83,80,79,84,83,85,72,69,67,64,64,60,70,68,74,77,77,80,100,129,158,129,120,111,75,43,29,52,476,682,568,688,688,516,368,370,386,385,385,396,374,383,361,297,603,899,710,712,674,738,766,697,821,751,613,591,739,789,679,729,703,736,727,713,707,661,318,112,95,91,247,408,369,289,554,882,776,747,780,812,541,648,798,779,743,789,842,835,862,798,654,564,439,478,146,73,81,94,91,93,181,413,545,677,783,687,712,659,640,599,552,576,579,558,452,510,456,440,374,359,389,358,291,280,243,220,260,316,343,385,370,353,330,484,800,682,754,746,656,631,625,532,568,339,150,146,115,100,299,867,867,751,761,675,772,762,767,726,568,296,119,91,138,176,201,245,243,250,233,234,296,277,220,119,66,68,98,171,505,929,812,708,745,761,710,690,843,763,544,602,800,743,674,551,571,598,458,407,171,116,79,69,76,83,116,143,136,288,736,660,679,694,627,437,663,794,708,466,319,209,115,114,162,183,197,184,161,115,80,66,167,351,419,414,368,379,320,439,825,812,850,838,805,744,726,774,717,701,746,733,714,753,763,744,685,673,671,736,791,670,613,752,744,801,741,669,680,808,805,671,707,721,679,605,634,749,701,568,704,593,472,424,497,821,813,686,594,722,678,678,738,632,636,755,603,536,764,703,768,847,786,637,519,522,489,461,363,261,208,160,360,382,308,507,672,826,794,797,875,945,836,786,871,865,802,884,926,908,838,797,661,620,565,687,462,374,273,148,172,209,498,603,540,951,948,682,618,774,735,656,796,693,671,699,886,706,439,331,170,96,115,173,210,226,233,220,207,153,100,59,62,55,70,389,608,850,683,653,781,795,778,825,607,587,722,564,601,549,780,675,712,793,819,869,828,799,505,484,396,320,147,89,113,147,217,229,238,224,209,167,151,109,71,151,232,226,233,345,888,875,793,716,716,684,735,643,787,805,877,789,638,689,808,630,674,779,846,802,733,662,631,701,748,692,644,815,714,660,785,695,708,585,654,779,742,744,716,654,457,398,315,180,173,183,202,236,233,242,246,219,169,96,70,65,70,148,307,531,567,839,896,847,800,830,868,823,826,795,681,673,703,708,814,818,440,400,388,356,372,352,352,334,301,246,157,103,106,219,732,794,823,759,772,707,696,653,745,722,579,739,726,666,644,679,550,700,638,546,440,355,157,148,85,80,91,133,324,497,506,909,698,819,846,764,817,802,925,836,782,795,758,715,796,841,799,790,742,757,855,810,842,793,771,607,654,746,706,746,782,751,582,655,661,658,588,545,516,699,676,440,470,340,270,216,223,244,233,225,208,200,152,117,84,57,62,356,369,457,630,815,821,760,774,724,825,690,662,682,693,704,730,673,679,767,732,723,801,768,848,864,734,744,744,575,664,669,751,625,780,770,746,711,663,663,672,646,600,672,672,601,526,445,326,194,187,202,170,176,185,182,150,137,136,94,77,70,328,448,634,650,705,842,793,755,710,703,719,750,799,809,731,720,728,764,761,706,693,691,697,811,829,763,691,791,563,500,589,806,813,830,782,734,760,746,756,831,804,684,571,350,269,199,156,158,225,265,216,196,184,156,132,116,93,88,114,213,419,546,904,875,957,938,960,938,714,879,798,758,828,819,716,514,259,188,131,123,159,149,146,151,141,149,121,105,101,118,191,449,868,763,711,686,756,777,690,721,785,776,651,451,411,522,517,357,330,315,311,316,249,221,214,201,111,90,75,77,351,506,568,925,779,717,771,778,828,715,769,753,782,718,706,721,792,703,796,709,675,638,708,788,785,724,709,520,570,662,664,735,708,664,659,729,754,744,748,838,657,541,533,576,468,284,180,115,188,214,221,240,241,221,189,144,96,77,65,60,399,480,545,661,589,812,880,833,801,807,795,712,670,583,640,646,567,565,717,720,823,766,733,801,705,773,671,789,723,717,807,704,801,791,666,742,700,659,677,755,750,711,704,475,442,325,253,147,177,226,237,214,197,178,141,114,123,106,87,88,342,443,644,751,787,858,778,728,645,673,708,778,875,708,562,479,584,622,542,556,613,670,673,668,672,567,522,644,690,771,735,696,733,772,667,599,695,788,703,562,454,504,450,444,312,207,209,226,259,250,245,271,239,197,171,141,105,85,193,446,579,734,818,868,840,850,900,816,787,838,768,723,729,728,755,770,809,794,824,722,769,764,716,608,598,656,594,518,555,483,550,639,625,639,744,690,639,630,614,639,674,647,624,628,615,579,564,693,805,845,864,842,742,663,729,765,664,700,693,608,504,502,589,734,703,723,789,804,672,735,667,741,881,962,929,839,789,626,678,789,831,687,779,688,777,736,741,683,722,826,657,509,165,88,134,238,376,449,426,437,404,320,240,142,84,99,466,745,837,770,711,543,745,705,636,524,496,317,125,83,133,304,296,336,273,289,325,305,275,258,340,393,381,280,299,190,195,395,875,911,852,749,819,665,622,656,425,157,66,158,260,453,522,848,873,815,868,961,975,866,705,526,428,408,332,193,122,149,191,209,215,198,165,138,127,105,84,86,67,90,328,435,821,744,771,807,761,796,722,789,687,698,751,717,652,646,610,652,701,624,376,311,240,154,94,84,72,76,136,295,370,401,603,826,684,654,569,568,695,685,521,514,518,501,423,479,369,323,241,175,204,204,218,260,319,361,398,402,353,349,376,397,665,947,847,847,754,731,729,723,835,750,783,802,874,840,826,794,728,799,753,839,783,822,812,697,740,818,686,838,710,845,823,850,796,754,817,668,777,785,758,735,841,709,602,535,631,722,762,732,608,617,593,649,753,775,850,761,660,697,682,700,520,679,732,763,684,470,520,512,542,551,561,582,612,530,491,470,760,829,773,778,812,759,799,709,686,823,756,653,644,735,857,750,666,606,641,709,556,438,301,284,367,405,402,454,522,850,749,644,600,581,657,583,486,384,368,190,113,103,127,155,155,179,202,216,200,195,181,151,111,102,77,48,57,170,555,778,776,739,914,871,797,755,688,592,665,808,610,642,730,735,615,705,741,767,795,738,709,621,598,689,680,637,583,671,635,664,915,911,869,766,722,818,909,900,880,860,977,883,712,904,616,677,665,659,662,503,774,577,635,678,706,713,739,774,803,821,746,677,714,788,727,644,674,705,655,662,739,776,773,738,667,699,764,662,614,692,730,687,674,693,666,582,594,666,735,754,707,707,753,755,793,876,852,778,699,697,740,714,712,714,747,784,764,710,854,835,796,796,743,842,756,810,794,780,793,780,834,857,768,780,779,798,701,764,782,743,600,713,836,817,782,728,780,749,737,686,759,720,724,698,788,739,705,727,747,762,765,705,700,716,784,874,868,841,849,784,826,836,782,784,781,796,798,798,804,819,639,785,764,740,651,700,628,523,529,543,716,695,643,679,648,641,611,565,560,498,528,559,484,467,463,470,467,439,390,331,298,295,232,172,148,141,95,69,69,61,62,63,61,57,52,47,57,48,39,48,39,40,39,42,45,39,34,41,41,35,29,27,27,24,24,20,18,24,23,258,647,593,555,612,522,515,517,408,367,328,292,248,97,58,56,58,78,90,92,85,98,96,94,88,80,66,43,49,47,37,45,40,39,37,32,31,36,31,24,30,26,25,24,23,26,27,25,34,34,30,20,20,19,16,14,13,12,14,13,258,648,594,556,613,522,514,516,409,366,326,293,250,96,57,56,59,78,90,92,84,97,95,94,87,80,66,43,49,46,36,45,40,39,37,32,30,36,31,23,30,26,25,24,119,310,452,348,292,32,102,255,451,321,17,185,453,365,256,47,246,804,634,678,663,478,561,617,457,408,331,269,285,146,106,166,314,496,363,358,374,371,399,393,275,289,344,302,208,62,152,443,331,286,384,188,177,218,298,445,380,386,331,344,330,291,249,321,237,230,242,202,242,265,156,140,162,166,113,70,258,572,514,479,554,529,519,542,425,422,361,332,324,196,162,163,131,161,138,116,127,134,130,139,118,101,77,75,73,47,61,97,77,79,83,58,43,49,66,108,86,84,82,77,80,61,57,63,61,60,56,41,53,53,30,29,28,27,22,15,256,631,579,541,603,526,516,522,410,374,330,290,249,97,55,62,59,82,89,89,83,99,93,95,91,81,64,43,49,46,38,45,40,40,35,34,29,36,34,30,34,25,26,24,29,27,29,26,35,36,32,20,22,21,16,15,12,12,14,13,258,645,591,553,611,524,514,517,410,368,327,290,250,96,63,58,60,83,90,92,85,98,96,95,88,81,66,43,52,48,38,371,490,383,331,352,441,324,263,366,380,294,254,357,324,265,237,326,244,223,261,286,195,184,230,166,80,56,73,64,237,739,692,513,567,629,594,589,491,582,573,432,454,311,378,339,408,402,381,417,433,463,360,410,268,200,174,172,196,206,236,304,343,317,334,395,236,284,197,166,407,504,605,692,615,503,742,739,621,516,478,491,486,578,487,496,533,594,579,592,607,794,744,670,702,683,692,645,628,559,607,566,544,507,531,552,563,503,368,407,479,538,589,588,499,456,391,558,527,546,573,554,557,516,537,544,556,565,549,506,486,413,380,335,269,286,331,364,309,277,341,392,458,468,437,431,389,467,439,435,525,705,675,651,683,642,622,605,539,510,504,482,404,423,387,381,420,436,439,425,411,418,398,406,323,289,198,201,182,200,241,264,301,314,336,343,340,324,273,209,172,152,176,287,423,362,276,894,927,620,513,464,419,465,506,508,533,577,530,547,578,748,671,654,731,660,649,680,642,656,572,583,539,437,459,537,524,495,434,553,588,555,517,527,563,533,375,510,495,529,524,515,529,547,524,510,535,537,533,484,377,425,334,316,360,481,502,446,258,329,494,533,470,380,435,529,456,531,376,445,646,742,656,761,610,543,639,646,590,629,592,494,438,425,422,506,539,560,533,527,526,576,444,474,488,493,458,433,410,422,421,480,608,541,511,421,421,422,486,576,511,553,527,484,480,419,426,491,406,473,461,433,423,432,414,424,413,402,375,374,516,707,731,671,681,563,588,590,494,470,431,438,392,314,287,261,237,250,212,202,224,187,198,194,187,200,167,173,160,173,170,178,194,195,207,179,175,151,158,160,151,146,133,128,108,101,101,104,87,97,99,79,78,80,80,79,68,76,63,76,246,717,629,575,666,538,582,573,442,436,427,381,344,279,288,271,240,255,248,253,223,236,232,212,201,225,183,154,174,165,158,275,241,190,188,161,183,176,168,161,173,159,148,142,157,156,131,141,143,140,108,129,112,112,101,118,99,83,82,91,82,119,103,83,81,61,81,75,73,64,80,73,62,57,70,67,54,60,60,60,47,55,51,49,39,53,43,37,35,39,36,50,43,36,36,27,35,33,31,28,33,30,27,24,30,29,24,25,26,25,20,23,22,21,17,22,18,16,14,17,15,20,17,15,15,11,14,14,13,11,14,12,12,90,566,638,930,910,774,584,388,468,476,502,515,574,571,555,546,463,526,482,761,815,728,758,733,724,506,677,694,669,499,358,313,649,756,852,872,788,689,693,480,572,748,883,933,874,755,692,724,712,790,707,647,698,624,559,626,682,575,662,758,749,775,333,144,132,205,355,452,478,461,434,378,324,271,139,76,84,139,758,916,733,628,675,736,678,647,698,639,480,204,115,287,324,415,368,419,462,426,416,419,417,415,367,200,87,60,129,467,892,765,816,742,770,675,666,631,465,259,138,148,265,420,623,883,567,703,589,644,734,786,762,654,494,561,413,222,74,90,145,206,210,208,164,135,90,82,71,82,71,90,338,425,715,685,797,756,820,720,743,789,696,599,662,766,908,904,731,785,694,603,450,410,359,286,185,107,70,76,132,277,407,455,301,601,837,721,582,633,671,565,700,754,786,558,366,272,171,113,124,125,105,104,137,185,251,322,396,426,366,242,118,60,201,758,958,743,785,861,773,778,747,791,770,846,849,822,734,758,775,752,735,712,719,754,639,821,815,666,616,714,641,698,743,820,808,618,584,656,741,758,758,718,671,663,595,515,497,622,769,683,679,613,633,548,643,624,580,669,628,743,691,824,797,752,756,631,534,478,339,430,455,482,497,492,517,520,474,423,858,777,763,724,830,668,715,571,753,768,665,726,773,753,781,729,727,708,595,426,254,179,119,73,82,106,165,316,486,601,928,799,539,585,543,742,779,714,591,463,292,141,85,83,97,144,217,265,289,300,277,219,192,171,111,74,69,52,100,640,1040,908,870,661,741,637,620,706,705,666,640,688,558,764,681,804,788,820,760,734,796,796,695,654,667,621,526,600,487,701,540,641,774,631,609,801,763,750,733,753,686,768,817,816,532,715,729,667,730,874,658,749,713,704,698,712,726,777,744,729,787,817,728,773,788,806,804,822,720,741,669,706,698,679,551,642,541,471,693,767,769,808,839,710,640,671,667,674,468,456,482,499,532,424,338,326,252,188,143,137,126,106,100,89,106,99,87,83,79,84,87,83,79,76,72,67,63,61,69,66,72,75,77,78,102,131,152,131,118,111,72,46,30,52,437,714,856,901,822,600,345,361,389,368,378,387,378,382,380,450,661,620,778,710,715,758,753,719,732,629,706,643,756,767,700,654,612,712,680,720,674,613,374,104,103,74,231,414,362,287,564,957,863,803,783,786,657,719,649,593,705,747,708,608,636,687,739,567,506,500,133,89,84,83,80,93,182,412,552,674,787,750,632,556,628,602,570,570,594,493,442,496,515,384,344,370,391,353,291,276,234,216,263,305,333,392,368,371,308,486,732,779,700,689,636,674,689,617,460,355,158,146,111,100,381,872,833,729,776,749,754,812,805,539,492,320,110,90,138,181,210,239,238,246,224,234,288,279,224,125,74,74,94,183,464,851,879,829,789,807,847,652,591,613,643,648,840,715,514,669,760,667,548,384,188,130,73,73,77,89,123,142,135,303,777,681,586,485,453,523,708,752,671,474,322,209,112,115,166,185,191,175,157,120,93,69,174,360,443,409,390,372,328,472,829,762,862,902,781,728,723,688,711,756,746,639,879,837,803,694,617,544,738,869,922,768,682,851,833,833,566,746,730,688,681,756,594,802,799,676,598,766,737,673,746,617,512,406,483,807,671,644,690,737,668,717,700,657,636,698,526,607,689,583,690,723,687,583,553,510,490,454,368,264,213,153,351,381,301,499,709,1002,998,870,904,857,724,725,729,682,683,815,831,759,687,569,513,544,688,791,476,342,262,133,174,212,497,596,505,812,802,592,465,569,701,696,695,623,735,516,599,656,529,426,274,201,224,235,273,296,298,295,259,188,105,76,77,91,107,382,806,770,749,660,707,680,723,782,701,774,670,623,598,679,781,757,752,649,758,805,703,732,721,602,425,321,152,80,101,150,224,234,240,220,198,169,157,120,76,149,236,231,247,329,831,880,682,912,817,809,829,880,678,851,694,701,725,738,519,586,732,744,711,634,623,685,807,862,875,831,760,646,758,618,653,756,627,673,595,702,800,771,710,640,483,426,332,184,164,175,212,237,230,252,251,222,166,100,63,71,63,144,304,537,553,844,801,726,794,645,544,760,779,714,669,690,694,816,836,700,450,407,387,353,356,363,344,321,306,226,157,110,119,220,715,765,790,768,777,783,745,738,653,582,691,794,742,681,625,668,729,777,610,517,449,346,170,151,78,69,96,137,308,495,502,882,675,852,906,881,860,668,589,593,563,712,722,691,709,652,627,593,601,596,626,703,610,670,660,757,813,764,547,506,706,767,688,623,662,548,606,689,696,744,594,500,445,323,270,200,213,234,238,227,199,194,148,122,93,75,60,356,389,486,696,815,805,842,837,791,823,744,754,740,752,773,727,761,783,749,691,673,655,698,652,702,700,684,750,861,803,762,711,696,723,712,776,777,721,724,709,721,706,780,735,593,518,499,431,354,376,370,386,363,401,334,363,360,334,375,341,346,439,532,685,755,756,809,819,877,842,794,740,775,651,642,692,743,741,687,762,743,728,664,691,700,729,762,744,701,749,623,852,785,763,766,728,707,749,736,735,744,735,666,578,417,262,209,159,178,231,263,222,216,192,174,139,111,78,90,119,216,421,543,878,855,766,672,644,785,810,840,859,822,814,852,816,569,244,174,128,109,117,124,123,119,121,132,94,82,97,114,174,427,848,858,802,734,741,757,705,737,616,661,744,575,423,491,497,367,333,310,310,320,252,218,212,193,109,81,70,66,354,501,535,879,676,790,790,835,758,820,757,768,695,774,736,787,781,764,775,826,854,749,762,722,746,665,799,823,787,691,660,676,664,646,690,658,725,799,763,766,716,679,521,556,469,274,181,106,187,209,220,251,238,216,194,138,87,79,76,79,409,469,564,641,638,768,846,797,792,792,711,879,806,861,839,808,809,906,782,816,786,774,847,707,808,716,754,761,732,736,709,699,666,737,761,777,754,694,776,804,821,646,621,520,477,329,253,162,198,232,244,226,203,182,153,129,114,97,79,77,319,451,601,662,760,870,823,848,825,898,866,738,592,795,897,808,897,813,842,826,856,840,801,745,759,857,887,709,722,736,773,696,814,751,657,672,726,809,827,842,702,626,393,396,300,205,198,224,253,248,251,271,235,205,181,160,117,115,229,443,559,760,856,795,728,771,777,773,749,729,726,853,779,817,763,750,823,807,744,711,823,751,687,620,608,650,576,504,578,482,551,560,673,680,752,669,646,650,593,628,683,629,625,631,605,590,548,608,698,858,796,786,795,765,776,633,685,838,744,538,506,492,634,931,856,734,692,737,676,598,554,657,776,766,753,650,611,697,840,757,585,824,767,699,764,804,680,668,583,736,739,602,146,93,128,226,376,447,426,413,402,335,250,149,89,88,464,742,897,861,725,777,668,700,583,521,487,327,137,93,144,310,304,348,274,290,327,306,289,256,333,384,389,302,291,192,199,455,914,818,731,681,694,742,724,604,368,156,65,164,262,456,571,916,823,751,894,933,791,673,510,400,472,414,339,195,94,121,196,195,197,186,153,130,109,77,66,87,66,89,339,449,674,618,664,665,722,784,733,671,757,684,568,581,620,627,549,541,871,601,375,303,236,149,88,65,57,70,130,296,373,392,676,667,705,857,739,652,774,685,566,550,553,550,484,480,351,312,244,182,204,212,220,252,336,375,383,398,337,347,378,398,654,949,836,792,826,817,757,860,717,741,792,830,878,812,820,750,696,738,829,899,749,738,659,702,823,888,727,787,745,761,773,856,748,763,821,709,726,653,577,803,774,755,606,546,647,768,686,630,549,723,628,704,699,654,793,679,441,783,757,929,703,812,823,784,727,567,508,515,548,568,578,589,626,557,475,470,737,816,751,754,826,574,760,895,662,691,655,555,623,735,733,611,569,563,572,584,482,492,290,297,387,406,379,414,626,779,702,487,546,588,576,666,563,575,412,170,104,88,126,158,153,201,202,215,193,193,178,138,104,95,71,56,56,223,541,935,931,723,812,839,749,780,728,672,691,776,603,616,738,732,823,750,718,741,688,725,637,629,710,693,711,728,601,620,541,651,675,738,858,706,562,729,645,842,780,801,782,782,530,801,620,668,665,612,677,696,661,701,667,697,810,724,729,748,757,754,667,674,688,748,691,647,627,723,628,580,708,730,783,724,700,725,707,636,607,646,706,749,698,704,681,630,623,571,720,607,711,721,755,823,869,920,836,787,750,731,769,703,704,757,763,802,797,760,890,900,794,863,802,838,790,807,835,764,814,814,814,853,753,924,857,765,634,725,798,753,640,742,771,843,833,739,768,739,819,653,721,703,755,728,821,772,750,779,769,799,742,754,751,758,803,881,893,833,775,835,748,789,731,779,791,817,816,879,825,899,746,816,802,748,761,730,820,787,819,745,811,830,780,783,832,807,771,780,701,685,767,675,661,681,733,726,707,522,571,618,724,748,713,722,616,553,745,657,696,744,703,710,678,683,699,716,726,703,651,623,526,519,421,357,356,425,500,424,373,454,520,599,611,582,563,516,620,580,562,637,721,725,730,737,730,703,696,631,612,605,572,514,540,514,502,565,571,568,556,534,546,518,531,424,374,254,271,243,279,332,367,418,429,453,462,460,436,368,283,234,207,247,391,580,487,366,932,989,831,688,624,565,618,671,673,696,740,686,697,708,806,747,731,779,737,739,771,790,803,716,725,679,576,608,699,678,639,564,717,755,707,658,675,724,688,486,667,649,688,677,665,684,703,676,659,691,691,685,626,496,560,445,417,460,541,589,513,457,443,513,542,639,528,527,564,590,603,545,562,595,827,790,746,766,666,699,750,662,656,620,585,554,556,547,588,665,631,607,573,587,614,626,622,599,571,591,572,550,548,507,659,582,560,595,525,547,552,615,657,635,593,611,597,568,498,477,565,485,534,560,554,587,582,506,527,515,494,495,480,604,656,705,623,748,672,651,678,547,585,483,434,429,376,344,349,273,303,234,216,262,255,258,248,238,243,207,217,222,225,237,249,240,264,273,247,243,205,218,221,203,180,159,151,142,129,122,121,95,109,125,108,118,110,106,104,91,99,88,100,240,631,581,545,614,535,525,520,420,379,323,289,258,111,75,75,79,98,100,95,99,113,105,107,100,96,82,66,69,68,61,61,54,57,56,55,54,52,52,47,46,42,40,35,38,34,42,50,52,50,49,38,40,37,37,33,31,31,28,32,264,645,591,556,612,524,516,517,412,367,326,295,247,97,61,62,62,83,92,94,88,100,97,96,90,143,72,49,53,48,39,370,492,382,333,353,442,326,264,366,379,294,257,357,325,264,241,330,248,221,264,288,195,185,231,170,81,56,78,69,244,741,692,513,566,632,599,593,498,588,575,442,463,324,389,347,411,405,375,411,432,457,346,415,237,117,86,82,118,135,147,267,303,283,309,377,230,382,343,244,400,294,380,583,698,607,601,616,905,900,774,721,660,674,553,598,638,670,615,681,744,781,742,736,801,748,809,752,754,748,732,728,665,604,649,677,703,668,702,542,610,738,707,560,624,745,752,648,680,680,690,660,679,696,707,668,617,595,491,511,493,537,412,381,330,368,389,585,546,557,438,529,535,484,497,561,600,536,547,550,588,739,745,716,747,662,699,666,620,579,552,574,584,440,483,511,533,528,495,461,527,559,522,483,531,574,440,337,310,266,221,234,260,296,365,403,431,384,349,267,254,259,245,232,418,486,384,557,990,952,815,639,603,649,699,714,768,697,686,693,697,820,800,781,798,787,746,817,746,756,752,773,687,665,610,631,721,648,776,525,548,678,742,737,555,798,634,685,663,668,706,702,679,689,687,619,305,335,375,422,428,478,450,410,388,778,968,841,721,653,614,586,717,735,706,729,752,709,657,665,721,872,813,821,817,752,699,839,726,693,688,670,708,606,586,728,697,668,735,748,719,724,653,702,678,689,675,613,682,664,660,712,647,578,638,643,639,627,681,721,724,686,703,660,707,624,640,655,652,686,699,657,610,633,611,644,632,634,698,651,659,749,662,692,722,741,752,753,672,682,707,489,475,516,469,487,491,493,521,538,573,566,575,565,587,593,603,591,616,585,543,542,535,593,587,560,593,578,559,569,615,582,602,573,518,495,530,529,520,579,564,569,591,588,541,509,472,512,530,523,680,806,658,655,814,579,612,741,607,599,704,677,640,485,500,507,524,553,571,598,611,609,596,569,530,474,453,441,500,545,501,554,559,547,551,519,489,500,545,622,604,589,559,518,513,534,498,517,528,562,564,515,519,535,534,502,459,473,486,505,621,833,682,753,665,579,654,686,398,434,570,710,626,471,432,452,443,411,419,420,409,346,237,192,206,215,180,198,228,233,212,395,414,380,377,354,367,393,381,384,399,388,336,361,352,336,324,310,291,302,270,260,231,224,216,212,192,173,197,190,317,700,607,589,614,538,543,541,418,423,351,316,278,217,191,199,172,178,186,179,163,173,155,150,125,144,119,100,117,112,115,152,130,116,107,97,100,114,112,102,106,113,100,101,93,94,82,80,87,87,69,71,59,61,55,58,51,45,48,52,56,65,54,48,47,40,48,53,55,47,49,53,46,48,43,40,36,39,37,38,29,30,26,27,23,27,22,20,23,25,26,29,23,22,21,19,21,26,27,23,23,26,23,24,20,19,17,18,18,18,15,14,11,12,11,12,9,9,11,12,12,13,10,10,10,9,10,13,13,11,11,13,11,12,10,9,8,9,9,9,8,7,5,5,6,6,4,4,5,6,6,6,5,5,5,4,5,6,7,6,5,6,6,6,5,4,4,4,4,4,4,3,2,2,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3,3,3,3,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},LIGHTS.VolumeEvents=function(t){this.initialize(t)},LIGHTS.VolumeEvents.prototype={initialize:function(t){this.director=t,this.vox=t.vox},start:function(){this.voxVolume=0},update:function(){var t,e=LIGHTS.VolumeData.vox,i=e[s]/512,s=Math.floor(60*LIGHTS.time),a=0,r=5*LIGHTS.deltaTime;if(s>0){for(t=Math.max(0,s-6);t<=s;t++)a+=e[t]/512;i=a/=Math.min(6,s),this.voxVolume<i?this.voxVolume=i:this.voxVolume-=(this.voxVolume-i)*r,this.vox.volume=this.voxVolume}}},LIGHTS.Home=function(t,e,i){this.initialize(t,e,i)},LIGHTS.Home.prototype={fadeValue:.5,hitRadius2:2500,circleCount:64,replayButtonsX:64,mouseOverScale:1.1,buttonOpacity:.3,buttonY:-46,initialize:function(t,e,i){this.renderManager=t,this.renderer=t.renderer,this.gui=e,this.callback=i,this.loadImages()},loadImages:function(){var t=bind(this,this.setup),e=0,i=0;for(var s in this.images={},LIGHTS.Config.homeImages)i++,this.images[s]=new Image,this.images[s].onload=function(){++e>=i&&t()},this.images[s].src=LIGHTS.Config.homeImages[s]},setup:function(){this.setupScene(),this.callback()},setupScene:function(){this.camera=new THREE.Camera,this.camera.projectionMatrix=THREE.Matrix4.makeOrtho(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),this.camera.position.z=1e3,this.scene=new THREE.Scene;var t,e,i,s,a,r=LIGHTS.BallGeometries.prototype.sphereColors,o=[];for(a=0;a<r.length;a++)t=new THREE.PlaneGeometry(1,1),s=r[a],THREE.MeshUtils.createVertexColorGradient(t,[s[0],s[1]]),o.push(t);for((i=new THREE.Texture(this.images.bokeh)).needsUpdate=!0,this.circles=[],a=0;a<this.circleCount;a++){t=o[Math.floor(Math.random()*o.length)],e=new THREE.MeshBasicMaterial({map:i,color:0,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0});var n=new THREE.Mesh(t,e);n.position.z=-1e3,n.scale.x=n.scale.y=n.scale.z=100*Math.random()+50,n.rotation.z=Math.random()*rad360,this.circles.push(new LIGHTS.HomeCircle(n,e)),this.scene.addChild(n)}(i=new THREE.Texture(this.images.loadingButton)).needsUpdate=!0,e=new THREE.MeshBasicMaterial({map:i,color:0,transparent:!0}),this.loadingColor=e.color,this.loading=new THREE.Mesh(new THREE.PlaneGeometry(128,128),e),this.loading.position.y=this.buttonY,this.loading.position.z=200,this.loadingRot=this.loading.rotation,this.loadingRot.y=rad180,this.scene.addChild(this.loading),(i=new THREE.Texture(this.images.playButton)).needsUpdate=!0,this.playMaterial=new THREE.MeshBasicMaterial({map:i,color:0,opacity:1-this.buttonOpacity,transparent:!0}),this.playColor=this.playMaterial.color,this.play=new THREE.Mesh(new THREE.PlaneGeometry(128,128),this.playMaterial),this.play.position.y=this.buttonY,this.play.position.z=400,this.playRot=this.play.rotation,this.playRot.y=rad180,this.scene.addChild(this.play),e=new THREE.MeshBasicMaterial({color:0,opacity:.5,blending:THREE.MultiplyBlending,transparent:!0}),this.fadeColor=e.color,this.fade=new THREE.Mesh(new THREE.PlaneGeometry(1,1),e),this.scene.addChild(this.fade),this.onWindowResizeListener=bind(this,this.onWindowResize),this.onWindowResize(),this.onClickListener=bind(this,this.onClick)},setupReplay:function(){texture=new THREE.Texture(LIGHTS.images.replayButton),texture.needsUpdate=!0,this.replayMaterial=new THREE.MeshBasicMaterial({map:texture,color:0,opacity:1-this.buttonOpacity,transparent:!0}),this.replayColor=this.replayMaterial.color,this.replay=new THREE.Mesh(new THREE.PlaneGeometry(128,128),this.replayMaterial),this.replay.position.x=-this.replayButtonsX,this.replay.position.y=this.buttonY,this.replay.position.z=200,this.replayRot=this.replay.rotation,this.replayRot.y=rad180,this.scene.addChild(this.replay),texture=new THREE.Texture(LIGHTS.images.tweetButton),texture.needsUpdate=!0,this.tweetMaterial=new THREE.MeshBasicMaterial({map:texture,color:0,opacity:1-this.buttonOpacity,transparent:!0}),this.tweetColor=this.tweetMaterial.color,this.tweet=new THREE.Mesh(new THREE.PlaneGeometry(128,128),this.tweetMaterial),this.tweet.position.x=this.replayButtonsX,this.tweet.position.y=this.buttonY,this.tweet.position.z=200,this.tweetRot=this.tweet.rotation,this.tweetRot.y=rad180,this.scene.addChild(this.tweet)},start:function(){this.time=(new Date).getTime(),this.isReplay=!0,this.tweetReady=!0,this.openTweetThis=!1,this.isClosing=!1,this.isOpening=!0,this.alpha=0,this.delay=1,window.addEventListener("resize",this.onWindowResizeListener,!1),this.onWindowResize(),window.addEventListener("click",this.onClickListener,!1);var t,e,i,s=this.circles;for(t=0,e=s.length;t<e;t++)(i=s[t]).life=0,i.lifeTime=0,i.fadeIn=0,i.fadeOut=0,i.delay=4*Math.random()+1,i.rotSpeed=2*Math.random()-1,i.color.setHex(0)},stop:function(){window.removeEventListener("resize",this.onWindowResizeListener,!1),this.isReplay&&window.removeEventListener("resize",this.onClickListener,!1)},launchIntro:function(){this.time=(new Date).getTime(),this.isIntro=!0,this.isReplay=!1,this.isClosing=!1,this.isOpening=!0,this.isLoaded=!1,this.isLoading=!0,this.alpha=0,this.delay=1,this.introDelay=1e3,window.addEventListener("resize",this.onWindowResizeListener,!1),this.onWindowResize()},launchPlay:function(){this.alpha<1?this.isLoaded=!0:(this.isLoading=!1,this.alpha=0),this.setupReplay()},update:function(){var t,e,i,s=window.innerWidth,a=window.innerHeight,r=(new Date).getTime()-this.time,o=this.circles;if(this.introDelay<0){for(this.time+=r,r/=1e3,e=0,i=o.length;e<i;e++)(t=o[e]).delay<0?(t.life+=r,t.life>t.lifeTime&&(t.position.x=(Math.random()-.5)*s,t.position.y=(Math.random()-.5)*a,t.color.setHex(0),t.life=0,t.lifeTime=4*Math.random()+2,t.fadeIn=(.5*Math.random()+.5)*t.lifeTime,t.fadeOut=(.5*Math.random()+.5)*(t.lifeTime-t.fadeIn),t.fadeOutTime=t.lifeTime-t.fadeOut),t.life<t.fadeIn?t.color.setHex(65793*Math.floor(256*t.life/t.fadeIn)):t.life>t.fadeOutTime&&t.color.setHex(65793*Math.floor(256*(1-(t.life-t.fadeOutTime)/t.fadeOut))),t.rotation.z+=r*t.rotSpeed):t.delay-=r;this.updateButtons(r),this.renderer.render(this.scene,this.camera),this.renderManager.update()}else this.introDelay-=r},updateButtons:function(t){var e,i,s,a,r=LIGHTS.Input,o=this.buttonY;this.isOpening?(this.alpha+=.5*t,this.alpha>=1&&(this.playScale=1,this.replayScale=1,this.tweetScale=1,this.isOpening=!1,this.alpha=1),this.isIntro||(a=Math.min(4*this.alpha,1)-1,this.replayRot.y=rad180*a,this.tweetRot.y=rad180*a),this.gui.fade(this.alpha),this.fadeColor.setHSV(0,0,this.alpha*this.fadeValue),1==this.alpha&&(this.alpha=0)):this.isIntro?this.delay<0?this.isLoading?this.alpha<1&&(this.alpha+=2*t,this.alpha>=1&&(this.alpha=1),this.loadingRot.y=rad180*(this.alpha-1),this.isLoaded&&1==this.alpha&&(this.isLoading=!1,this.alpha=0)):(this.alpha+=2*t,this.alpha>=1&&(this.playScale=1,this.isIntro=!1,this.alpha=1),this.loadingRot.y=rad180*this.alpha,this.playRot.y=rad180*(this.alpha-1)):this.delay-=t:this.isReplay?(this.isClosing?(this.alpha+=2*t,this.alpha>=1&&(LIGHTS.Lights.instance.playExperience(),this.alpha=1),this.replayRot.y=this.tweetRot.y=rad180*this.alpha,s=this.mouseOverScale-this.alpha*(this.mouseOverScale-1),this.replayScale=Math.min(this.replayScale,s),this.tweetScale=Math.min(this.tweetScale,s),a=1-this.buttonOpacity*this.alpha,this.replayMaterial.opacity=Math.min(this.replayMaterial.opacity,a),this.tweetMaterial.opacity=Math.min(this.replayMaterial.opacity,a),this.gui.fade(1-this.alpha),this.fadeColor.setHSV(0,0,(1-this.alpha)*this.fadeValue)):(e=(r.pointerX+this.replayButtonsX)*(r.pointerX+this.replayButtonsX)+(r.pointerY+o)*(r.pointerY+o),i=(r.pointerX-this.replayButtonsX)*(r.pointerX-this.replayButtonsX)+(r.pointerY+o)*(r.pointerY+o),e<this.hitRadius2||r.keyReturn?(this.replayScale-=(this.replayScale-this.mouseOverScale)*t*8,this.replayMaterial.opacity-=(this.replayMaterial.opacity-1)*t*8,document.body.style.cursor="pointer",(LIGHTS.Input.mouseDown||r.keyReturn)&&(document.body.style.cursor="auto",this.isClosing=!0,this.alpha=0)):(this.replayScale-=(this.replayScale-1)*t*8,this.replayMaterial.opacity-=(this.replayMaterial.opacity-(1-this.buttonOpacity))*t*8),this.tweetReady&&i<this.hitRadius2?(this.tweetScale-=(this.tweetScale-this.mouseOverScale)*t*8,this.tweetMaterial.opacity-=(this.tweetMaterial.opacity-1)*t*8,document.body.style.cursor="pointer",LIGHTS.Input.mouseDown&&(this.openTweetThis=!0,this.tweetReady=!1,document.body.style.cursor="auto")):(this.tweetScale-=(this.tweetScale-1)*t*8,this.tweetMaterial.opacity-=(this.tweetMaterial.opacity-(1-this.buttonOpacity))*t*8),this.tweetReady||(this.tweetReady=i>=this.hitRadius2),e>=this.hitRadius2&&i>=this.hitRadius2&&(document.body.style.cursor="default")),this.replay.scale.x=this.replay.scale.y=this.replay.scale.z=this.replayScale,this.tweet.scale.x=this.tweet.scale.y=this.tweet.scale.z=this.tweetScale):(this.isClosing?(this.alpha+=2*t,this.alpha>=1&&(LIGHTS.Lights.instance.playExperience(),this.alpha=1),this.playRot.y=rad180*this.alpha,this.playScale=this.mouseOverScale-this.alpha*(this.mouseOverScale-1),this.playMaterial.opacity=1-this.buttonOpacity*this.alpha,this.gui.fade(1-this.alpha),this.fadeColor.setHSV(0,0,(1-this.alpha)*this.fadeValue)):(e=r.pointerX*r.pointerX+(r.pointerY+o)*(r.pointerY+o))<this.hitRadius2||r.keyReturn?(this.playScale-=(this.playScale-this.mouseOverScale)*t*8,this.playMaterial.opacity-=(this.playMaterial.opacity-1)*t*8,document.body.style.cursor="pointer",(LIGHTS.Input.mouseDown||r.keyReturn)&&(document.body.style.cursor="auto",this.isClosing=!0,this.alpha=0)):(this.playScale-=(this.playScale-1)*t*8,this.playMaterial.opacity-=(this.playMaterial.opacity-(1-this.buttonOpacity))*t*8,document.body.style.cursor="default"),this.play.scale.x=this.play.scale.y=this.play.scale.z=this.playScale),this.loadingColor.r=this.loadingColor.g=this.loadingColor.b=Math.sin(this.loadingRot.y+rad90),this.playColor.r=this.playColor.g=this.playColor.b=Math.sin(this.playRot.y+rad90),this.isReplay&&(this.replayColor.r=this.replayColor.g=this.replayColor.b=Math.sin(this.replayRot.y+rad90),this.tweetColor.r=this.tweetColor.g=this.tweetColor.b=Math.sin(this.tweetRot.y+rad90))},onClick:function(t){this.openTweetThis&&(this.openTweetThis=!1,window.open(LIGHTS.Config.tweetThis,"_blank",LIGHTS.Config.tweetThisSpecs))},onWindowResize:function(){var t=window.innerWidth,e=window.innerHeight,i=t/2,s=e/2;this.fade.scale.x=t,this.fade.scale.y=e,this.renderer.setSize(t,e),this.camera.projectionMatrix=THREE.Matrix4.makeOrtho(-i,i,s,-s,-1e4,1e4)}},LIGHTS.HomeCircle=function(t,e){this.position=t.position,this.rotation=t.rotation,this.color=t.materials[0].color,this.life=0,this.lifeTime=0,this.fadeIn=0,this.fadeOut=0,this.delay=4*Math.random()+1,this.rotSpeed=2*Math.random()-1},LIGHTS.Player=function(t){this.initialize(t)},LIGHTS.Player.prototype={playerPan:.25,playerPanFast:.75,initialize:function(t){if(this.director=t,this.isCamera=!LIGHTS.View.prototype.options.debugView,this.isCamera)this.camera=t.view.camera,this.cameraPosition=this.camera.position,this.targetPosition=this.camera.target.position,this.targetPosition.x=0,this.targetPosition.y=60,this.targetPosition.z=-100,this.camera.useTarget=!1,this.camera.matrixAutoUpdate=!1;else{this.camera=new THREE.Object3D;var e=new THREE.Trident;e.position.y=100,this.camera.addChild(e),t.view.scene.addChild(this.camera),this.targetPosition=(new THREE.Object3D).position}this.frustum=60*deg2rad,this.angle=30*deg2rad,this.forward=new THREE.Vector2(0,-1),this.right=new THREE.Vector2(1,0),this.cameraUp=new THREE.Vector3,this.rollAxis=new THREE.Vector3,this.auxMatrix=new THREE.Matrix4,this.altitude=this.altitudeOrigin=this.altitudeTarget=0,this.fov=this.fovOrigin=this.fovTarget=0,this.tilt=this.tiltOrigin=this.tiltTarget=0,this.velocity=this.velocityOrigin=this.velocityTarget=0,this.cameraTilt=this.roll=0,this.turbo=1,this.alpha=1,this.duration=1},update:function(t){var e,i=LIGHTS.Input,s=LIGHTS.deltaTime,a=0;if(LIGHTS.releaseBuild||!i.keyDown){if(s*=e=(t=void 0!==t)?0:1,!t){if(this.alpha<1&&!t){this.alpha+=s/this.duration,this.alpha>1&&(this.alpha=1);var r=.5*(Math.sin(this.alpha*rad180-rad90)+1),o=1-r;this.altitude=this.altitudeOrigin*o+this.altitudeTarget*r,this.tilt=this.tiltOrigin*o+this.tiltTarget*r,this.velocity=this.velocityOrigin*o+this.velocityTarget*r,this.isCamera&&(this.fov=this.fovOrigin*o+this.fovTarget*r,this.camera.fov!=this.fov&&(this.camera.fov=this.fov,this.camera.updateProjectionMatrix()))}i.mouseDown?this.turbo-=(this.turbo-2.5)*s*4:this.turbo-=(this.turbo-1)*s*2,a=s*this.velocity*this.turbo,this.angle-=i.mouseX*this.turbo*s*this.velocity*.001}this.cameraPosition.x+=this.forward.x*a,this.cameraPosition.y=this.altitude,this.cameraPosition.z+=this.forward.y*a,this.targetPosition.x=this.cameraPosition.x-Math.sin(this.angle)*this.targetDistance,this.targetPosition.y=this.cameraPosition.y,this.targetPosition.z=this.cameraPosition.z-Math.cos(this.angle)*this.targetDistance,this.isCamera||(this.director.view.camera.position.x=this.cameraPosition.x,this.director.view.camera.position.z=this.cameraPosition.z),this.roll-=(this.roll-e*i.mouseX*this.velocity*.001)*s*.3*this.turbo,this.rollAxis.sub(this.cameraPosition,this.targetPosition),this.rollAxis.normalize(),this.cameraUp.x=this.cameraUp.z=0,this.cameraUp.y=1,this.auxMatrix.setRotationAxis(this.rollAxis,-this.roll),this.auxMatrix.rotateAxis(this.cameraUp),this.camera.matrix.lookAt(this.cameraPosition,this.targetPosition,this.cameraUp),this.cameraTilt-=(this.cameraTilt+e*i.mouseY*this.velocity*5e-4+this.tilt)*s*2,this.auxMatrix.setRotationX(this.cameraTilt),this.camera.matrix.multiply(this.camera.matrix,this.auxMatrix),this.camera.matrix.setPosition(this.cameraPosition),this.camera.update(null,!0,this.camera),this.targetPosition.x=this.targetPosition.y=0,this.targetPosition.z=-this.targetDistance,this.camera.matrix.multiplyVector3(this.targetPosition),this.forward.x=-Math.sin(this.angle),this.forward.y=-Math.cos(this.angle),this.right.x=-Math.sin(this.angle+rad90),this.right.y=-Math.cos(this.angle+rad90)}},launch:function(){if(this.targetDistance=150,this.isCamera)switch(LIGHTS.Music.phase.index){case 0:this.camera.fov=this.fov=this.fovTarget=25,this.camera.updateProjectionMatrix(),this.cameraPosition.y=this.altitude=-40,this.altitudeTarget=60,this.cameraTilt=this.tilt=.1*-rad90,this.tiltTarget=.1*rad90,this.velocity=this.velocityTarget=0,this.alpha=1,this.targetPosition.x=this.cameraPosition.x-Math.sin(this.angle)*this.targetDistance,this.targetPosition.y=this.cameraPosition.y,this.targetPosition.z=this.cameraPosition.z-Math.cos(this.angle)*this.targetDistance,this.update(!0),this.tween(8);break;case 1:this.velocityTarget=150,this.tween(1);break;case 3:this.fovTarget=30,this.altitudeTarget=110,this.velocityTarget=250,this.tween(4);break;case 7:this.altitudeTarget=80,this.tiltTarget=.1*rad90,this.velocityTarget=150,this.tween(2);break;case 9:this.altitudeTarget=120,this.tiltTarget=.15*rad90,this.velocityTarget=200,this.tween(4);break;case 11:this.altitudeTarget=80,this.tiltTarget=.1*rad90,this.velocityTarget=250,this.tween(4);break;case 13:this.altitudeTarget=200,this.fovTarget=40,this.tiltTarget=.3*rad90,this.velocityTarget=200,this.tween(4);break;case 15:this.altitudeTarget=200,this.fovTarget=40,this.tiltTarget=.2*rad90,this.velocityTarget=200,this.tween(8);break;case 16:this.velocityTarget=0,this.tween(3);break;case 17:this.altitudeTarget=90,this.fovTarget=30,this.tiltTarget=.1*rad90,this.velocityTarget=200,this.tween(2);break;case 18:this.altitudeTarget=130,this.tiltTarget=.15*rad90,this.velocityTarget=200,this.tween(4);break;case 21:this.altitudeTarget=100,this.fovTarget=40,this.tiltTarget=.1*rad90,this.velocityTarget=200,this.tween(4);break;case 22:this.velocityTarget=100,this.altitudeTarget=200,this.tiltTarget=.3*rad90,this.tween(8)}},tween:function(t){this.duration=t,LIGHTS.releaseBuild||console.log("CAMERA: vel:",this.velocityTarget,"alt:",this.altitudeTarget,"tilt:",this.tiltTarget,"fov:",this.fovTarget),this.altitudeOrigin=this.altitude,this.fovOrigin=this.fov,this.tiltOrigin=this.tilt,this.velocityOrigin=this.velocity,this.alpha=0}},LIGHTS.RenderManager=function(){this.initialize()},LIGHTS.RenderManager.prototype={initialize:function(){var t=document.createElement("div"),e=t.style;e.position="absolute",e.top="0px",e.left="0px",e.zIndex="-100",e.margin="0",e.padding="0",document.body.appendChild(t);var i=document.createElement("canvas"),s="",a=function(t){s=t.statusMessage||"unknown error"};i.addEventListener("webglcontextcreationerror",a,!1);var r=i.getContext("experimental-webgl");if(i.removeEventListener("webglcontextcreationerror",a,!1),r){var o=new THREE.WebGLRenderer({canvas:i,clearColor:0,clearAlpha:1,antialias:!1});o.setSize(window.innerWidth,window.innerHeight),o.autoClear=!1,t.appendChild(o.domElement),this.renderer=o}else alert("WebGL error: "+s);LIGHTS.releaseBuild||(this.renderStats=new THREE.RenderStats(this.renderer),this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="-42px",this.renderStats.container.appendChild(this.stats.domElement))},update:function(){LIGHTS.releaseBuild||(this.renderStats.update(),this.stats.update())}},LIGHTS.Skybox=function(t){this.initialize(t)},LIGHTS.Skybox.prototype={initialize:function(t){var e,i,s;this.view=t.view,this.cameraPosition=t.player.camera.position,e=new LIGHTS.CapsuleGeometry(1280,1280,640,16,[0,1],!0,640,8,!1),THREE.MeshUtils.translateVertices(e,0,-640,0),THREE.MeshUtils.transformUVs(e,0,1,1,-1),(s=new THREE.Texture(LIGHTS.images.skybox)).needsUpdate=!0,s.repeat.x=4,s.wrapS=THREE.RepeatWrapping,i=new THREE.MeshBasicMaterial({map:s,color:16711680}),this.color=i.color,this.mesh=new THREE.Mesh(e,i),this.mesh.flipSided=!0,this.view.renderer.initMaterial(i,{},null,null),LIGHTS.View.prototype.options.debugView||this.view.scene.addChild(this.mesh)},update:function(){this.mesh.position.copy(this.cameraPosition);var t=.3*LIGHTS.time%2;t>1&&(t=1-(t-1)),this.color.setHSV(.6+.35*t,1,1)}},LIGHTS.Stars=function(t){this.initialize(t)},LIGHTS.Stars.particleCount=10,LIGHTS.Stars.particleSize=4,LIGHTS.Stars.prototype={initialize:function(t){var e,i,s;for(this.terrain=t.terrain,this.player=t.player,this.particles=new THREE.Geometry,this.particles.dynamic=!0,this.particles.colors=[],this.stars=[],s=new THREE.ParticleBasicMaterial({vertexColors:!0,size:2*LIGHTS.Stars.particleSize,map:LIGHTS.TextureUtils.getCircleTexture(32),blending:THREE.AdditiveBlending,transparent:!0}),e=0;e<LIGHTS.Stars.particleCount;e++)(i=new LIGHTS.Star).position=new THREE.Vector3(999999,0,999999),i.color=new THREE.Color(16711680),this.stars.push(i),this.particles.vertices.push(new THREE.Vertex(i.position)),this.particles.colors.push(i.color);this.particleSystem=new THREE.ParticleSystem(this.particles,s),this.particleSystem.sortParticles=!1,this.particleSystem.dynamic=!0,t.view.scene.addChild(this.particleSystem)},lifeFade:.5,update:function(){var t,e;for(this.particles.__dirtyColors=!0,t=0;t<LIGHTS.Stars.particleCount;t++)(e=this.stars[t]).life+=LIGHTS.deltaTime,e.life<e.fadeIn?e.color.setHex(65793*Math.floor(256*e.life/e.fadeIn)):e.life>e.fadeOut&&e.color.setHex(65793*Math.floor(256*(1-(e.life-e.fadeOut)/e.fadeOutTime))),(e.life>e.lifeTime||!this.terrain.isVisible(e.position.x,e.position.z))&&(this.terrain.selectCenterTile(),this.terrain.selectTerrainRandomVertex(!1),e.position.copy(this.terrain.randomPosition),e.position.y+=50+150*Math.random(),e.color.setHex(0),e.life=0,e.lifeTime=.5+.5*Math.random(),e.fadeIn=(.5+.5*Math.random())*e.lifeTime,e.fadeOut=(.5+.5*Math.random())*(e.lifeTime-e.fadeIn),e.fadeOutTime=e.lifeTime-e.fadeOut,this.particles.__dirtyVertices=!0)}},LIGHTS.Star=function(){this.initialize()},LIGHTS.Star.prototype={initialize:function(){this.position=null,this.color=null,this.life=0,this.lifeTime=0,this.fadeIn=0,this.fadeOut=0}},LIGHTS.View=function(t){this.initialize(t)},LIGHTS.View.prototype={options:{debugView:!1,debugViewY:5e3,antialias:!1,fog:!0,fogAmount:.002},postprocessing:{enabled:!0,blurAmount:.0015},initialize:function(t){this.renderManager=t,this.renderer=t.renderer,this.options.debugView?(this.camera=new THREE.Camera(33,window.innerWidth/window.innerHeight,1,16e3),this.camera.position.x=0,this.camera.position.y=this.options.debugViewY,this.camera.position.z=700,this.camera.rotation.x=-rad90,this.camera.useTarget=!1):this.camera=new THREE.Camera(30,window.innerWidth/window.innerHeight,1,1600),this.scene=new THREE.Scene,!this.options.debugView&&this.options.fog&&(this.scene.fog=new THREE.FogExp2(0,this.options.fogAmount)),this.sceneVox=new THREE.Scene,this.initPostprocessing(),this.onWindowResizeListener=bind(this,this.onWindowResize)},clear:function(){this.renderer.clear()},setFog:function(t){!this.options.debugView&&this.options.fog&&(this.scene.fog.fogAmount=t)},start:function(){window.addEventListener("resize",this.onWindowResizeListener,!1),this.onWindowResize()},stop:function(){window.removeEventListener("resize",this.onWindowResizeListener,!1)},update:function(){this.postprocessing.enabled?(this.renderer.render(this.scene,this.camera,this.postprocessing.rtTexture1,!0),this.renderManager.update(),this.postprocessing.quad.materials[0]=this.postprocessing.materialConvolution,this.postprocessing.materialConvolution.uniforms.tDiffuse.texture=this.postprocessing.rtTexture1,this.postprocessing.materialConvolution.uniforms.uImageIncrement.value=this.postprocessing.blurx,this.renderer.render(this.postprocessing.scene,this.postprocessing.camera,this.postprocessing.rtTexture2,!0),this.postprocessing.materialConvolution.uniforms.tDiffuse.texture=this.postprocessing.rtTexture2,this.postprocessing.materialConvolution.uniforms.uImageIncrement.value=this.postprocessing.blury,this.renderer.render(this.postprocessing.scene,this.postprocessing.camera,this.postprocessing.rtTexture3,!0),this.postprocessing.quad.materials[0]=this.postprocessing.materialScreen,this.postprocessing.materialScreen.uniforms.tDiffuse.texture=this.postprocessing.rtTexture3,this.postprocessing.materialScreen.uniforms.opacity.value=1.3,this.renderer.render(this.postprocessing.scene,this.postprocessing.camera,this.postprocessing.rtTexture1,!1),this.postprocessing.materialVignette.uniforms.tDiffuse.texture=this.postprocessing.rtTexture1,this.renderer.render(this.postprocessing.sceneScreen,this.postprocessing.camera),this.renderer.render(this.sceneVox,this.camera)):(this.renderer.render(this.scene,this.camera),this.renderer.render(this.sceneVox,this.camera),this.renderManager.update())},initPostprocessing:function(){this.postprocessing.scene=new THREE.Scene,this.postprocessing.sceneScreen=new THREE.Scene,this.postprocessing.camera=new THREE.Camera,this.postprocessing.camera.projectionMatrix=THREE.Matrix4.makeOrtho(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),this.postprocessing.camera.position.z=100;var t={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};this.postprocessing.rtTexture1=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,t),this.postprocessing.rtTexture2=new THREE.WebGLRenderTarget(512,512,t),this.postprocessing.rtTexture3=new THREE.WebGLRenderTarget(512,512,t);var e=THREE.ShaderUtils.lib.screen,i=THREE.UniformsUtils.clone(e.uniforms);i.tDiffuse.texture=this.postprocessing.rtTexture1,i.opacity.value=1,this.postprocessing.materialScreen=new THREE.MeshShaderMaterial({uniforms:i,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,blending:THREE.AdditiveBlending,transparent:!0});var s=["varying vec2 vUv;","uniform sampler2D tDiffuse;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 coords = (vUv - 0.5) * 2.0;","float coordDot = dot (coords,coords);","float mask = 1.0 - coordDot * 0.3;","gl_FragColor = texel * mask;","}"].join("\n");this.postprocessing.materialVignette=new THREE.MeshShaderMaterial({uniforms:i,vertexShader:e.vertexShader,fragmentShader:s,blending:THREE.AdditiveBlending,transparent:!0});var a=THREE.ShaderUtils.lib.convolution,r=THREE.UniformsUtils.clone(a.uniforms);this.postprocessing.blurx=new THREE.Vector2(this.postprocessing.blurAmount,0),this.postprocessing.blury=new THREE.Vector2(0,this.postprocessing.blurAmount),r.tDiffuse.texture=this.postprocessing.rtTexture1,r.uImageIncrement.value=this.postprocessing.blurx,r.cKernel.value=THREE.ShaderUtils.buildKernel(8),this.postprocessing.materialConvolution=new THREE.MeshShaderMaterial({uniforms:r,vertexShader:"#define KERNEL_SIZE 25.0\n"+a.vertexShader,fragmentShader:"#define KERNEL_SIZE 25\n"+a.fragmentShader}),this.postprocessing.quad=new THREE.Mesh(new THREE.PlaneGeometry(1,1),this.postprocessing.materialConvolution),this.postprocessing.quad.scale.x=window.innerWidth,this.postprocessing.quad.scale.y=window.innerHeight,this.postprocessing.quad.position.z=-500,this.postprocessing.scene.addObject(this.postprocessing.quad),this.postprocessing.quadScreen=new THREE.Mesh(new THREE.PlaneGeometry(1,1),this.postprocessing.materialVignette),this.postprocessing.quadScreen.scale.x=window.innerWidth,this.postprocessing.quadScreen.scale.y=window.innerHeight,this.postprocessing.quadScreen.position.z=-500,this.postprocessing.sceneScreen.addObject(this.postprocessing.quadScreen)},onWindowResize:function(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.postprocessing.camera.projectionMatrix=THREE.Matrix4.makeOrtho(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),this.postprocessing.quad.scale.x=window.innerWidth,this.postprocessing.quad.scale.y=window.innerHeight,this.postprocessing.quadScreen.scale.x=window.innerWidth,this.postprocessing.quadScreen.scale.y=window.innerHeight;var t={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};this.postprocessing.rtTexture1=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,t)}},LIGHTS.Vox=function(t){this.initialize(t)},LIGHTS.Vox.prototype={particleCount:256,trailCountAdd:24,trailCountAlpha:24,spectrumLength:64,initialize:function(t){this.director=t,this.player=t.player,this.targetPosition=this.player.targetPosition,this.vox=new THREE.Object3D,t.view.sceneVox.addChild(this.vox),this.voxPosition=this.vox.position,this.voxPositionY=0,this.position=new THREE.Vector3,this.velocity=new THREE.Vector3,this.createParticles(),this.createTrails(),this.createBengal(),this.volume=1,this.time=0,this.isIntro=!1,this.isOutro=!1,this.active=!1},update:function(){if(this.active){var t=LIGHTS.deltaTime*(this.player.velocity*this.player.turbo/40);this.velocity.x=(this.targetPosition.x-this.position.x)*t,this.velocity.y=(this.targetPosition.y-this.position.y)*t,this.velocity.z=(this.targetPosition.z-this.position.z)*t,this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.position.z+=this.velocity.z,this.voxPositionY-=(this.voxPositionY-64*(this.player.cameraTilt+this.player.tilt))*t*.5,this.voxPosition.x=this.position.x+this.player.right.x*this.player.roll*128,this.voxPosition.y=this.position.y+this.voxPositionY,this.voxPosition.z=this.position.z+this.player.right.y*this.player.roll*128,this.bengal.visible&&this.updateBengal(),this.isIntro?this.updateParticlesIntro():this.isOutro?this.updateParticlesOutro():(this.updateTrailPositions(),this.updateTrailGeometry(this.trailGeometryAdd),this.updateTrailGeometry(this.trailGeometryAlpha))}},finish:function(){this.lineSystem.visible=!0,this.isOutro=!0,this.bengalAlpha=0,this.setupParticlesOutro()},stop:function(){this.lineSystem.visible=!1,this.trailSystemAdd.visible=!1,this.trailSystemAlpha.visible=!1,this.bengal.visible=!1,this.bengalShadow.visible=!1,this.active=!1},start:function(){this.active=!0,this.lineSystem.visible=!0,this.trailSystemAdd.visible=!1,this.trailSystemAlpha.visible=!1,this.bengal.visible=!1,this.bengalShadow.visible=!1,this.position.copy(this.director.player.targetPosition),this.isIntro=!0,this.isOutro=!1,this.introTime=0,this.bengalMaterialCache.visible=!0,this.setupParticlesIntro()},launchBengal:function(){this.bengal.visible=!0,this.bengalShadow.visible=!0,this.bengalTime=0,this.bengalAlpha=0,this.bengal.scale.x=this.bengal.scale.y=.001,this.bengalShadow.scale.x=this.bengalShadow.scale.y=this.bengal.scale.x},launch:function(){LIGHTS.Music.startTime>0&&this.launchBengal(),this.isIntro=!1,this.lineSystem.visible=!1,this.trailSystemAdd.visible=!0,this.trailSystemAlpha.visible=!0,this.setupTrailGeometry(this.trailGeometryAdd),this.setupTrailGeometry(this.trailGeometryAlpha),this.setupTrailPositions(),this.bengalMaterialCache.visible=!1},createTrails:function(){var t,e,i,s=this.director.view.sceneVox,a=new THREE.Texture(LIGHTS.images.spotLine);for(a.needsUpdate=!0,this.trailGeometryAdd=new LIGHTS.SpotGeometry(10,10,64,64,this.trailCountAdd),this.trailGeometryAdd.computeBoundingSphere(),this.trailGeometryAdd.boundingSphere.radius=Number.MAX_VALUE,this.trailGeometryAdd.trailCount=this.trailCountAdd,e=0,i=this.trailGeometryAdd.vertices.length;e<i;e++)this.trailGeometryAdd.vertices[e].linePosition=new THREE.Vector3;for(t=new THREE.MeshBasicMaterial({map:a,blending:THREE.AdditiveBlending,transparent:!0}),this.trailSystemAdd=new THREE.Mesh(this.trailGeometryAdd,t),this.trailSystemAdd.renderDepth=0,this.trailSystemAdd.dynamic=!0,this.trailSystemAdd.doubleSided=!0,s.addChild(this.trailSystemAdd),this.trailGeometryAdd.trailDatas=[],e=0,i=this.trailCountAdd;e<i;e++)this.trailGeometryAdd.trailDatas.push(this.createTrailData(3));for((a=new THREE.Texture(LIGHTS.images.spotLineAlpha)).needsUpdate=!0,this.trailGeometryAlpha=new LIGHTS.SpotGeometry(10,10,64,64,this.trailCountAlpha),this.trailGeometryAlpha.computeBoundingSphere(),this.trailGeometryAlpha.boundingSphere.radius=Number.MAX_VALUE,this.trailGeometryAlpha.trailCount=this.trailCountAdd,e=0,i=this.trailGeometryAlpha.vertices.length;e<i;e++)this.trailGeometryAlpha.vertices[e].linePosition=new THREE.Vector3;for(this.setupTrailVertexColors(this.trailGeometryAlpha),t=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,map:a,opacity:.75,transparent:!0}),this.trailSystemAlpha=new THREE.Mesh(this.trailGeometryAlpha,t),this.trailSystemAlpha.renderDepth=20,this.trailSystemAlpha.dynamic=!0,this.trailSystemAlpha.doubleSided=!0,s.addChild(this.trailSystemAlpha),this.trailGeometryAlpha.trailDatas=[],e=0,i=this.trailCountAlpha;e<i;e++)this.trailGeometryAlpha.trailDatas.push(this.createTrailData(6));for(this.trailPositions=[],e=0;e<=70;e++)this.trailPositions[e]=new THREE.Vector3;for(this.spectrum=[],e=0;e<this.spectrumLength;e++)this.spectrum[e]=0;this.spectrumIndex=0},setupTrailVertexColors:function(t){var e,i,s,a,r,o=t.trailCount,n=t.faces,h=n.length/o,l=[1,0,0],c=[1,0,0],d=0;for(e=0;e<o;e++)for(c[1]=.5*Math.random()+.5,c[2]=.5*Math.random(),l[1]=.5*Math.random()+.5,l[2]=.5*Math.random(),i=0;i<h;i++)face=n[d++],r=1-(a=i/h),(s=new THREE.Color).r=r*c[0]+a*l[0],s.g=r*c[1]+a*l[1],s.b=r*c[2]+a*l[2],face.vertexColors.push(s),face.vertexColors.push(s),r=1-(a=(i+1)/h),(s=new THREE.Color).r=r*c[0]+a*l[0],s.g=r*c[1]+a*l[1],s.b=r*c[2]+a*l[2],face.vertexColors.push(s),face.vertexColors.push(s);t.__dirtyColors=!0},setupTrailGeometry:function(t){var e,i,s=t.vertices,a=s.length;for(e=0;e<a;e++)(i=s[e].linePosition).x=0,i.y=0,i.z=0;t.__dirtyVertices=!0},setupTrailPositions:function(){var t,e,i,s=this.trailPositions,a=this.voxPosition.x,r=this.voxPosition.y,o=this.voxPosition.z;for(t=0,e=s.length;t<e;t++)(i=s[t]).x=a,i.y=r,i.z=o,i.active=!1},updateTrailPositions:function(){var t=this.voxPosition,e=this.trailPositions.pop();e.x=t.x,e.y=t.y,e.z=t.z,e.active=!0,this.trailPositions.unshift(e),this.time+=LIGHTS.deltaTime},createTrailData:function(t){return{offset:Math.random()*rad360,offsetZ:Math.random()*rad360,freq:rad180*(2*Math.random()+.5),amp:10*(Math.random()-.5),rows:Math.floor(8*Math.random())+4,spectrumOffset:Math.floor(64*Math.random()),head:[(Math.random()-.5)*t,(Math.random()-.5)*t,(Math.random()-.5)*t]}},updateTrailGeometry:function(t){var e,i,s,a,r,o,n,h,l,c,d,p,u,m=this.time,T=this.spectrum,g=this.spectrumLength,f=this.trailPositions,y=t.trailDatas,v=t.trailCount,b=this.voxPosition.x,S=this.voxPosition.y,H=this.voxPosition.z,E=t.vertices,x=E.length,w=x/v;for(e=w-1;e>2;e-=2)for(i=0;i<v;i++)a=E[s=e+i*w].linePosition,r=E[s-2].linePosition,a.x=r.x,a.y=r.y,a.z=r.z,a=E[s-1].linePosition,r=E[s-3].linePosition,a.x=r.x,a.y=r.y,a.z=r.z;for(i=0;i<v;i++)s=w*i,u=(c=y[i]).amp,p=c.freq,d=c.offset,n=c.head,o=m*p+d,(r=E[s].linePosition).x=u*Math.sin(o),r.y=u*Math.cos(o),r.z=u*Math.sin(o+c.offsetZ),(a=E[s+1].linePosition).x=r.x+n[0],a.y=r.y+n[1],a.z=r.z+n[2];for(this.spectrumIndex+=10*LIGHTS.deltaTime,h=Math.floor(this.spectrumIndex),e=0;e<x;e+=2){l=T[(e%w+h+(c=y[Math.floor(e/w)]).spectrumOffset)%g],p=c.freq,d=c.offset;var M=e/2%(w/2),G=f[M];u=Math.sin(Math.min(M/16,1)*rad90)*(.15+.005*l)*this.volume+.1,G.active?(a=E[e].position,r=E[e].linePosition,a.x=G.x+r.x*u,a.y=G.y+r.y*u,a.z=G.z+r.z*u,a=E[e+1].position,r=E[e+1].linePosition,a.x=G.x+r.x*u,a.y=G.y+r.y*u,a.z=G.z+r.z*u):((a=E[e].position).x=b,a.y=S,a.z=H,(a=E[e+1].position).x=b,a.y=S,a.z=H)}t.__dirtyVertices=!0},createBengal:function(){this.bengalIndex=0,this.bengalTexture=new THREE.Texture(LIGHTS.images.bengalSeq),this.bengalTexture.repeat.x=this.bengalTexture.repeat.y=.25,this.bengalTexture.needsUpdate=!0;var t=new THREE.MeshBasicMaterial({map:this.bengalTexture,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1});this.bengal=new THREE.Mesh(new THREE.PlaneGeometry(20,20),t),this.bengal.doubleSided=!0,this.bengal.renderDepth=10,this.director.view.sceneVox.addChild(this.bengal),this.bengalPosition=this.bengal.position;var e=new THREE.Texture(LIGHTS.images.bengalShadow);e.needsUpdate=!0,t=new THREE.MeshBasicMaterial({map:e,blending:THREE.MultiplyBlending,transparent:!0}),this.bengalShadow=new THREE.Mesh(new THREE.PlaneGeometry(20,20),t),this.bengalShadow.doubleSided=!0,this.bengalShadow.renderDepth=40,this.director.view.sceneVox.addChild(this.bengalShadow),this.bengalMaterialCache=new THREE.Mesh(new THREE.PlaneGeometry(0,0),t),this.bengalMaterialCache.doubleSided=!0,this.vox.addChild(this.bengalMaterialCache)},updateBengal:function(){var t=LIGHTS.deltaTime;this.bengalTime+=t,this.bengalTime>=1/30&&(this.bengalTime-=1/30,this.bengalIndex++,this.bengalIndex>=16&&(this.bengalIndex=0),this.bengalTexture.offset.x=this.bengalIndex%4*.25,this.bengalTexture.offset.y=.25*Math.floor(this.bengalIndex/4)),this.bengalAlpha<1?(this.bengalAlpha+=t,this.isIntro?this.bengal.scale.x-=(this.bengal.scale.x-1)*t*4:this.isOutro&&this.bengal.scale.x>0&&(this.bengal.scale.x=Math.max(.001,this.bengal.scale.x-2*t),this.bengalShadow.scale.x=this.bengalShadow.scale.y=this.bengal.scale.x),this.bengal.scale.y=this.bengal.scale.x):this.isOutro||(this.bengal.scale.x=this.bengal.scale.y=.25+.5*this.volume),this.bengalShadow.scale.x=this.bengalShadow.scale.y=this.bengal.scale.x,this.bengalPosition.x=this.voxPosition.x,this.bengalPosition.y=this.voxPosition.y,this.bengalPosition.z=this.voxPosition.z,this.bengal.lookAt(this.director.view.camera.position),this.bengalShadow.position.x=this.voxPosition.x,this.bengalShadow.position.y=this.voxPosition.y,this.bengalShadow.position.z=this.voxPosition.z,this.bengalShadow.lookAt(this.director.view.camera.position)},createParticles:function(){var t,e,i,s,a;for(this.particleGeometry=new THREE.Geometry,s=this.particleGeometry.vertices,a=this.particles=[],t=0,e=this.particleCount;t<e;t++)i=new LIGHTS.VoxParticle,s.push(new THREE.Vertex(i.positionStart)),s.push(new THREE.Vertex(i.positionEnd)),a.push(i);this.lineMaterial=new THREE.LineBasicMaterial({color:16744512,linewidth:1,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1}),this.lineSystem=new THREE.Line(this.particleGeometry,this.lineMaterial,THREE.LinePieces),this.lineSystem.dynamic=!0,this.lineSystem.visible=!1,this.director.view.scene.addChild(this.lineSystem)},setupParticlesIntro:function(){var t,e,i,s,a,r,o,n,h,l=this.particles,c=this.voxPosition.x,d=this.voxPosition.y,p=this.voxPosition.z;for(a=0,r=this.particleCount;a<r;a++)o=l[a],t=2*Math.random()-1,e=Math.random()*rad360,i=Math.sqrt(1-t*t),(h=o.normal).x=Math.cos(e)*i,h.y=Math.sin(e)*i,h.z=t,s=50*Math.random()+100,(n=o.positionStart).x=c+h.x*s,n.y=d+h.y*s,n.z=p+h.z*s,(n=o.positionEnd).x=c+h.x*s,n.y=d+h.y*s,n.z=p+h.z*s,o.end=o.start=s,o.startVelocity=Math.random()*s*.5+s,o.endVelocity=Math.random()*s*.5+s;this.particleGeometry.__dirtyVertices=!0,this.lineMaterial.color.setHex(16744512),this.introTime=0},updateParticlesIntro:function(){var t,e,i,s,a,r,o=LIGHTS.deltaTime,n=this.particles,h=this.voxPosition.x,l=this.voxPosition.y,c=this.voxPosition.z;for(t=0,e=this.particleCount;t<e;t++)(i=n[t]).start=Math.max(0,i.start-o*i.startVelocity),i.end=Math.max(0,i.end-o*i.endVelocity),a=i.normal,r=i.start,(s=i.positionStart).x=h+a.x*r,s.y=l+a.y*r,s.z=c+a.z*r,r=i.end,(s=i.positionEnd).x=h+a.x*r,s.y=l+a.y*r,s.z=c+a.z*r;this.particleGeometry.__dirtyVertices=!0,this.introTime+=o,this.introTime>.75&&!this.bengal.visible&&this.launchBengal()},setupParticlesOutro:function(){var t,e,i,s,a=this.particles,r=this.voxPosition.x,o=this.voxPosition.y,n=this.voxPosition.z;for(t=0,e=this.particleCount;t<e;t++)(s=(i=a[t]).positionStart).x=r,s.y=o,s.z=n,(s=i.positionEnd).x=r,s.y=o,s.z=n,i.end=i.start=50-100*Math.random();this.particleGeometry.__dirtyVertices=!0,this.outroTime=0},updateParticlesOutro:function(){var t,e,i,s,a,r,o,n,h=LIGHTS.deltaTime,l=this.particles,c=this.voxPosition.x,d=this.voxPosition.y,p=this.voxPosition.z;for(t=0,e=this.particleCount;t<e;t++)(i=l[t]).start+=h*i.startVelocity,i.end+=h*i.endVelocity,i.start>0&&i.end>0&&(a=i.normal,r=i.start,(s=i.positionStart).x=c+a.x*r,s.y=d+a.y*r,s.z=p+a.z*r,r=i.end,(s=i.positionEnd).x=c+a.x*r,s.y=d+a.y*r,s.z=p+a.z*r);this.particleGeometry.__dirtyVertices=!0,this.outroTime+=h,this.outroTime>1&&(n=1-4*h,(o=this.lineMaterial.color).r*=n,o.g*=n,o.b*=n,this.outroTime>1.7&&this.stop())}},LIGHTS.VoxParticle=function(){this.positionStart=new THREE.Vector3,this.positionEnd=new THREE.Vector3,this.normal=new THREE.Vector3},Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var t=document.createElement("div");return t.style.fontFamily="monospace",t.style.fontSize="13px",t.style.textAlign="center",t.style.shadow="#eee",t.style.color="#000",t.style.padding="1em",t.style.width="475px",t.style.margin="5em auto 0",this.webgl||(t.innerHTML=window.WebGLRenderingContext?['Sorry, your graphics card doesn\'t support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>'].join("\n"):['Sorry, your browser doesn\'t support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a><br/>',"Please try with",'<a href="http://www.google.com/chrome">Chrome</a>, ','<a href="http://www.mozilla.com/en-US/firefox/new/">Firefox 4</a> or','<a href="http://nightly.webkit.org/">Webkit Nightly (Mac)</a>'].join("\n")),t},addGetWebGLMessage:function(t){var e,i,s;e=void 0!==(t=t||{}).parent?t.parent:document.body,i=void 0!==t.id?t.id:"oldie",(s=Detector.getWebGLErrorMessage()).id=i,e.appendChild(s)}},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)});var Stats=function(){function t(t,e,i){var s,a,r;for(a=0;a<30;a++)for(s=0;s<73;s++)t[r=4*(s+74*a)]=t[r+4],t[r+1]=t[r+5],t[r+2]=t[r+6];for(a=0;a<30;a++)r=4*(73+74*a),a<e?(t[r]=R[i].bg.r,t[r+1]=R[i].bg.g,t[r+2]=R[i].bg.b):(t[r]=R[i].fg.r,t[r+1]=R[i].fg.g,t[r+2]=R[i].fg.b)}var e,i,s,a,r,o,n,h,l,c,d,p,u,m,T=0,g=2,f=0,y=(new Date).getTime(),v=y,b=y,S=0,H=1e3,E=0,x=0,w=1e3,M=0,G=0,I=1e3,L=0,R={fps:{bg:{r:16,g:16,b:48},fg:{r:0,g:255,b:255}},ms:{bg:{r:16,g:48,b:16},fg:{r:0,g:255,b:0}},mb:{bg:{r:48,g:16,b:26},fg:{r:255,g:0,b:128}}};(e=document.createElement("div")).style.cursor="pointer",e.style.width="80px",e.style.opacity="0.9",e.style.zIndex="10001",e.addEventListener("click",(function(){switch(++T==g&&(T=0),i.style.display="none",n.style.display="none",d.style.display="none",T){case 0:i.style.display="block";break;case 1:n.style.display="block";break;case 2:d.style.display="block"}}),!1),(i=document.createElement("div")).style.backgroundColor="rgb("+Math.floor(R.fps.bg.r/2)+","+Math.floor(R.fps.bg.g/2)+","+Math.floor(R.fps.bg.b/2)+")",i.style.padding="2px 0px 3px 0px",e.appendChild(i),(s=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",s.style.textAlign="left",s.style.fontSize="9px",s.style.color="rgb("+R.fps.fg.r+","+R.fps.fg.g+","+R.fps.fg.b+")",s.style.margin="0px 0px 1px 3px",s.innerHTML='<span style="font-weight:bold">FPS</span>',i.appendChild(s),(a=document.createElement("canvas")).width=74,a.height=30,a.style.display="block",a.style.marginLeft="3px",i.appendChild(a),(r=a.getContext("2d")).fillStyle="rgb("+R.fps.bg.r+","+R.fps.bg.g+","+R.fps.bg.b+")",r.fillRect(0,0,a.width,a.height),o=r.getImageData(0,0,a.width,a.height),(n=document.createElement("div")).style.backgroundColor="rgb("+Math.floor(R.ms.bg.r/2)+","+Math.floor(R.ms.bg.g/2)+","+Math.floor(R.ms.bg.b/2)+")",n.style.padding="2px 0px 3px 0px",n.style.display="none",e.appendChild(n),(h=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",h.style.textAlign="left",h.style.fontSize="9px",h.style.color="rgb("+R.ms.fg.r+","+R.ms.fg.g+","+R.ms.fg.b+")",h.style.margin="0px 0px 1px 3px",h.innerHTML='<span style="font-weight:bold">MS</span>',n.appendChild(h),(a=document.createElement("canvas")).width=74,a.height=30,a.style.display="block",a.style.marginLeft="3px",n.appendChild(a),(l=a.getContext("2d")).fillStyle="rgb("+R.ms.bg.r+","+R.ms.bg.g+","+R.ms.bg.b+")",l.fillRect(0,0,a.width,a.height),c=l.getImageData(0,0,a.width,a.height);try{performance&&performance.memory&&performance.memory.totalJSHeapSize&&(g=3)}catch(t){}return(d=document.createElement("div")).style.backgroundColor="rgb("+Math.floor(R.mb.bg.r/2)+","+Math.floor(R.mb.bg.g/2)+","+Math.floor(R.mb.bg.b/2)+")",d.style.padding="2px 0px 3px 0px",d.style.display="none",e.appendChild(d),(p=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",p.style.textAlign="left",p.style.fontSize="9px",p.style.color="rgb("+R.mb.fg.r+","+R.mb.fg.g+","+R.mb.fg.b+")",p.style.margin="0px 0px 1px 3px",p.innerHTML='<span style="font-weight:bold">MB</span>',d.appendChild(p),(a=document.createElement("canvas")).width=74,a.height=30,a.style.display="block",a.style.marginLeft="3px",d.appendChild(a),(u=a.getContext("2d")).fillStyle="#301010",u.fillRect(0,0,a.width,a.height),m=u.getImageData(0,0,a.width,a.height),{domElement:e,update:function(){f++,y=(new Date).getTime(),x=y-v,w=Math.min(w,x),M=Math.max(M,x),t(c.data,Math.min(30,30-x/200*30),"ms"),h.innerHTML='<span style="font-weight:bold">'+x+" MS</span> ("+w+"-"+M+")",l.putImageData(c,0,0),v=y,y>b+1e3&&(S=Math.round(1e3*f/(y-b)),H=Math.min(H,S),E=Math.max(E,S),t(o.data,Math.min(30,30-S/100*30),"fps"),s.innerHTML='<span style="font-weight:bold">'+S+" FPS</span> ("+H+"-"+E+")",r.putImageData(o,0,0),3==g&&(G=954e-9*performance.memory.usedJSHeapSize,I=Math.min(I,G),L=Math.max(L,G),t(m.data,Math.min(30,30-G/2),"mb"),p.innerHTML='<span style="font-weight:bold">'+Math.round(G)+" MB</span> ("+Math.round(I)+"-"+Math.round(L)+")",u.putImageData(m,0,0)),b=y,f=0)}}};LIGHTS.MapCircles=function(t){this.initialize(t)},LIGHTS.MapCircles.prototype={circleCount:64,colors:[3158016,12336,3145776,3145728,12288,48],circles:[],initialize:function(t){this.map=t;var e,i,s,a,r,o,n=LIGHTS.TerrainMap.size;for((r=new THREE.Texture(LIGHTS.images.circle)).minFilter=THREE.LinearMipMapLinearFilter,r.magFilter=THREE.LinearMipMapLinearFilter,r.needsUpdate=!0,s=[],e=0;e<this.colors.length;e++)s.push(new THREE.MeshBasicMaterial({color:this.colors[e],map:r,blending:THREE.AdditiveBlending,transparent:!0}));for(o=new THREE.PlaneGeometry(n,n),e=0;e<this.circleCount;e++)a=s[Math.floor(Math.random()*s.length)],i=new THREE.Mesh(o,a),this.circles.push(new LIGHTS.MapCircle(i,a))},launch:function(){this.circles;var t,e,i,s,a,r=LIGHTS.TerrainMap.size;for(t=0,e=this.circleCount;t<e;t++)s=.05+.15*Math.random(),a=this.map.viewRadius-r*s*.5,(i=this.circles[t]).size=s,i.posMax=a,this.resetCircle(i),this.map.scene.addChild(i.mesh)},clear:function(){var t,e,i=this.circles;for(t=0,e=this.circleCount;t<e;t++)this.map.scene.removeChild(i[t].mesh)},update:function(){this.circles;var t,e,i=LIGHTS.deltaTime;for(t=0,e=this.circleCount;t<e;t++)circle=this.circles[t],circle.life-=i,circle.life<0&&this.resetCircle(circle),circle.radius+=i*circle.speed,circle.scale.x=circle.scale.y=circle.radius*circle.size},resetCircle:function(t){var e=t.posMax;t.life=4*Math.random()+4,t.position.x=2*Math.random()*e-e,t.position.y=2*Math.random()*e-e,t.radius=.001,t.scale.x=t.scale.y=t.radius*t.size,t.speed=.15*Math.random()+.15}},LIGHTS.MapCircle=function(t){this.mesh=t,this.position=t.position,this.scale=t.scale,this.life=this.size=this.posMax=this.radius=this.speed=0},LIGHTS.MapDots=function(t){this.initialize(t)},LIGHTS.MapDots.prototype={colors:[8421376,32896,8388736,8388608,32768,128],dotCount:64,colorIndex:0,drawCount:0,dots:[],dotMaterials:[],addDot:!1,removeDot:!1,initialize:function(t){this.map=t;var e,i,s,a;LIGHTS.TerrainMap.size;for((a=new THREE.Texture(LIGHTS.images.dot)).minFilter=THREE.LinearMipMapLinearFilter,a.magFilter=THREE.LinearMipMapLinearFilter,a.needsUpdate=!0,e=0;e<this.dotCount;e++)s=new THREE.MeshBasicMaterial({color:16777215,map:a,blending:THREE.AdditiveBlending,transparent:!0}),i=new THREE.Mesh(new THREE.PlaneGeometry(LIGHTS.TerrainMap.size,LIGHTS.TerrainMap.size),s),this.dots.push(i),this.dotMaterials.push(s)},drawDots:function(t){var e,i,s,a,r;for(this.drawCount=t,e=0;e<t;e++)s=.05+.15*Math.random(),a=LIGHTS.TerrainMap.size*s,r=this.map.viewRadius-.5*a,(i=this.dots[e]).position.x=2*Math.random()*r-r,i.position.y=2*Math.random()*r-r,i.scale.x=i.scale.y=s,this.map.scene.addChild(i),this.dotMaterials[e].color.setHex(this.colors[this.colorIndex++%this.colors.length]);this.addDot=!0,this.removeDot=!1},clear:function(){for(var t=0;t<this.dotCount;t++)this.map.scene.removeChild(this.dots[t])},update:function(){if(this.addDot)this.addDot=!1,this.removeDot=!0;else if(this.removeDot){for(var t=0;t<this.drawCount;t++)this.map.scene.removeChild(this.dots[t]);this.removeDot=!1}}},LIGHTS.MapGlows=function(t){this.initialize(t)},LIGHTS.MapGlows.prototype={colors:[[[1,1,0],[1,0,0]],[[1,0,1],[1,0,0]],[[1,1,0],[0,1,0]],[[0,1,1],[0,1,0]],[[0,1,1],[0,0,1]],[[1,0,1],[0,0,1]]],glows:[],initialize:function(t){var e,i;for(this.map=t,this.ballSize=LIGHTS.BallGeometries.prototype.ballSize,this.texture=new THREE.Texture(LIGHTS.images.glow),this.texture.minFilter=THREE.LinearMipMapLinearFilter,this.texture.magFilter=THREE.LinearMipMapLinearFilter,this.texture.needsUpdate=!0,this.glowCount=LIGHTS.BallsManager.prototype.ballsPerTile,this.geometry=new LIGHTS.SpotGeometry(1,1,1,1,this.glowCount),i=new THREE.MeshBasicMaterial({vertexColors:THREE.FaceColors,map:this.texture,blending:THREE.AdditiveBlending,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,i),this.mesh.dynamic=!0,e=0;e<this.glowCount;e++)this.glows.push(new LIGHTS.MapGlow(e,this.geometry))},launch:function(t){this.balls=t;this.glows;var e,i,s,a,r,o=LIGHTS.Terrain.prototype.tileSize,n=2*this.map.viewRadius;for(e=0,i=this.glowCount;e<i;e++)a=(r=t.behaviours[e]).position,(s=this.glows[e]).behaviour=r,s.position.x=a.x/o*n,s.position.y=a.z/o*n;this.map.glowScene.addChild(this.mesh)},clear:function(){this.map.scene.removeChild(this.mesh)},update:function(){this.glows;var t,e,i,s,a,r,o,n,h,l,c,d,p,u,m,T,g=this.ballSize,f=this.colors;for(t=0,e=this.glowCount;t<e;t++)(n=(i=this.glows[t]).behaviour).visible&&n.state<2?(h=n.multiply,l=n.additive,c=n.grow,d=n.scale,i.visible=!0,i.scale==d&&i.grow==c&&i.multiply==h&&i.additive==l||(s=i.color,o=(a=f[n.colorIndex])[0],r=a[1],p=1-c,s.r=(r[0]*p+o[0]*c)*h+l,s.g=(r[1]*p+o[1]*c)*h+l,s.b=(r[2]*p+o[2]*c)*h+l,u=i.position.x,m=i.position.y,T=3*(n.scale*g*(1-.5*c)-l),i.posA.x=u-T,i.posA.y=m-T,i.posB.x=u+T,i.posB.y=m-T,i.posC.x=u-T,i.posC.y=m+T,i.posD.x=u+T,i.posD.y=m+T,i.scale=d,i.grow=c,i.multiply=h,i.additive=l,this.geometry.__dirtyVertices=!0,this.geometry.__dirtyColors=!0)):i.visible&&(i.visible=!1,i.scale=0,i.posA.x=i.posA.y=i.posB.x=i.posB.y=i.posC.x=i.posC.y=i.posD.x=i.posD.y=0,this.geometry.__dirtyVertices=!0)}},LIGHTS.MapGlow=function(t,e){this.position=new THREE.Vector3,this.posA=e.vertices[4*t].position,this.posB=e.vertices[4*t+1].position,this.posC=e.vertices[4*t+2].position,this.posD=e.vertices[4*t+3].position,this.posA.z=10,this.posB.z=10,this.posC.z=10,this.posD.z=10,e.faces[t].color=this.color=new THREE.Color,this.scale=0,this.grow=0,this.multiply=0,this.additive=0,this.visible=!1},LIGHTS.MapLines=function(t){this.initialize(t)},LIGHTS.MapLines.prototype={colors:[16776960,65535,16711935,16711680,65280,255],lineCount:64,colorIndex:0,drawCount:0,lines:[],lineMaterials:[],addLine:!1,removeLine:!1,initialize:function(t){this.map=t;var e,i,s,a;LIGHTS.TerrainMap.size;for(e=0;e<this.lineCount;e++)s=new THREE.MeshBasicMaterial({color:16777215}),a=Math.ceil(4*Math.random()),i=new THREE.Mesh(new THREE.PlaneGeometry(LIGHTS.TerrainMap.size,a),s),this.lines.push(i),this.lineMaterials.push(s)},drawLines:function(t){var e,i,s,a,r;for(this.drawCount=t,e=0;e<t;e++)s=.05+.1*Math.random(),a=LIGHTS.TerrainMap.size*s,r=this.map.viewRadius-.5*a,(i=this.lines[e]).position.x=0,i.position.y=2*Math.random()*r-r,i.speed=0,i.speed*=i.position.y>0?-1:1,this.map.scene.addChild(i),this.lineMaterials[e].color.setHex(this.colors[this.colorIndex++%this.colors.length]),this.addLine=!0,this.removeLine=!1},moveLines:function(){for(var t=0;t<this.lineCount;t++)this.lines[t].rotation.z+=.1*Math.random()},clear:function(){for(var t=0;t<this.lineCount;t++)this.map.scene.removeChild(this.lines[t])},update:function(){for(var t=0;t<this.lineCount;t++)this.lines[t].position.y+=this.lines[t].speed*LIGHTS.deltaTime}},LIGHTS.Terrain=function(t){this.initialize(t)},LIGHTS.Terrain.prototype={mapResolution:66,tileSize:480,gridSize:5,height:140,selectedTile:null,randomVertexIndex:null,randomVertexPosition:new THREE.Vector3,randomPosition:new THREE.Vector3,randomNormal:new THREE.Vector3,randomX:null,randomY:null,tiles:[],tileIdSet:{},usedVertices:[],initialize:function(t){var e,i,s;for(this.director=t,this.scene=t.view.scene,this.player=t.player,this.camera=this.player.camera,this.gridRadius=Math.floor(this.gridSize/2),e=0;e<this.gridSize;e++)for(this.tiles[e]=[],i=0;i<this.gridSize;i++)(s=new THREE.Object3D).visible=!1,s.justOn=s.justOff=s.justMoved=!1,this.tiles[e][i]=s;for(this.terrainPlane=new LIGHTS.TerrainPlane(this.tileSize,this.mapResolution,this.height,LIGHTS.images["terrain"+this.mapResolution]),this.displacement=new LIGHTS.TerrainDisplacement(this),e=0;e<=this.terrainPlane.resolution;e++)for(this.usedVertices[e]=[],i=0;i<=this.terrainPlane.resolution;i++)this.usedVertices[e][i]=!1},update:function(){var t,e,i,s,a,r,o,n,h,l,c,d=this.camera.position.x,p=this.camera.position.z,u=Math.sin(this.player.angle),m=Math.cos(this.player.angle);for(l in this.cameraTileX=(Math.round(d/this.tileSize)-this.gridRadius)*this.tileSize,this.cameraTileY=(Math.round(p/this.tileSize)-this.gridRadius)*this.tileSize,this.tileIdSet)delete this.tileIdSet[l];for(t=0;t<this.gridSize;t++)for(e=0;e<this.gridSize;e++)a=(n=this.cameraTileX+this.tileSize*t)-d,r=(h=this.cameraTileY+this.tileSize*e)-p,s=Math.atan2(a,r),c=(i=Math.floor(Math.max(Math.abs(t-this.gridRadius),Math.abs(e-this.gridRadius))))>1?m*Math.cos(s)+u*Math.sin(s)<-.5:1!=i||m*Math.cos(s)+u*Math.sin(s)<.5,o=this.tiles[t][e],c?(o.justOff=!1,o.justOn=!o.visible,o.justOn&&(this.scene.addChild(o),o.visible=!0),l=n+"/"+h,this.tileIdSet[l]=!0,o.justMoved=o.tileId!=l,o.justMoved&&(o.position.x=n,o.position.z=h,o.tileId=l)):(o.justOff=o.visible,o.justOn=!1,o.justOff&&(this.scene.removeChild(o),o.visible=!1));this.displacement.active&&this.displacement.update()},isVisible:function(t,e){var i=(Math.round(t/this.tileSize)-this.gridRadius)*this.tileSize,s=(Math.round(e/this.tileSize)-this.gridRadius)*this.tileSize,a=(i-this.cameraTileX)/this.tileSize+this.gridRadius,r=(s-this.cameraTileY)/this.tileSize+this.gridRadius;return!(isNaN(a)||isNaN(r)||a<0||a>=this.gridSize||r<0||r>=this.gridSize)&&this.tiles[a][r].visible},reset:function(){var t,e;for(t=0;t<=this.terrainPlane.resolution;t++)for(e=0;e<=this.terrainPlane.resolution;e++)this.usedVertices[t][e]=!1;this.terrainPlane.resetVertices()},selectTile:function(t,e){this.selectedTile=this.tiles[t][e]},selectTileById:function(t){var e,i,s;for(e=0;e<this.gridSize;e++)for(s=this.tiles[e],i=0;i<this.gridSize;i++)if(s[i].tileId==t)return this.selectedTile=s[i],!0;return!1},selectCenterTile:function(){this.selectedTile=this.tiles[this.gridRadius][this.gridRadius]},selectRandomTile:function(t){this.selectRandomTileAtRadius(Math.floor(Math.random()*this.gridRadius))},selectRandomTileAtRadius:function(t){var e,i,s,a=100;do{e=this.gridRadius+t*(Math.random()>.5?1:-1),i=this.gridRadius-t+Math.floor(Math.random()*t*2),Math.random()>.5&&(s=e,e=i,i=s),this.selectedTile=this.tiles[e][i]}while(--a>0&&!this.selectedTile.visible);0==a&&(console.log(this.selectedTile.visible,e,i,t),console.error("ERROR: Terrain.selectRandomTileAtRadius: Not found"))},selectTerrainRandomVertex:function(t,e,i){this.selectTerrainRandomCoords(t,e,i),t&&(this.usedVertices[this.randomX][this.randomY]=!0),this.randomVertexIndex=this.terrainPlane.indexGrid[this.randomX][this.randomY],this.randomVertex=this.terrainPlane.vertices[this.randomVertexIndex],this.randomVertexPosition.copy(this.randomVertex.position),this.randomPosition.add(this.selectedTile.position,this.randomVertexPosition),this.randomNormal=this.terrainPlane.vertexNormals[this.randomVertexIndex]},selectTerrainRandomCoords:function(t,e,i){var s,a,r,o,n,h,l,c,d,p=this.terrainPlane.resolution,u=this.usedVertices,m=100,T=t?e*e:0;void 0===i&&(i=0);do{Math.random();if(a=i+Math.floor(Math.random()*(p-2*i)),r=i+Math.floor(Math.random()*(p-2*i)),t)for(s=!0,o=a-e,h=a+e;o<h&&s;o++)for(c=(a-o)*(a-o),n=r-e,l=r+e;n<l&&s;n++)c+(d=(r-n)*(r-n))<=T&&(s=!u[Math.abs(o%p)][Math.abs(n%p)]);else s=!1}while(--m>0&&t&&!s);if(0==m)console.log("ERROR: Terrain.selectTerrainRandomCoords: Not found");else if(t)for(o=a-e,h=a+e;o<h&&s;o++){for(c=a-o,n=r-e,l=r+e;n<l&&s;n++)d=r-n;c*c+d*d<=T&&(u[Math.abs(o%p)][Math.abs(n%p)]=!0)}this.randomX=a,this.randomY=r}},LIGHTS.TerrainDisplacement=function(t){this.initialize(t)},LIGHTS.TerrainDisplacement.prototype={active:!1,initialize:function(t){this.terrain=t,this.terrainPlane=t.terrainPlane,this.spectrum=null,this.velocities=[];var e,i=this.terrainPlane.resolution;for(e=0;e<i;e++)this.velocities[e]=[]},update:function(){switch(LIGHTS.Music.phase.index){case 15:case 21:this.updateSpectrum();break;case 16:case 22:this.updateFlat();break;case 17:this.updateTerrain()}},updateSpectrum:function(){var t,e,i,s,a,r,o,n,h,l=this.terrainPlane.grid,c=this.terrainPlane.heightGrid,d=this.spectrum,p=this.terrainPlane.resolution,u=p/2;for(t=0,e=p;t<e;t++)for(a=l[t],r=c[t],o=(t-u)*(t-u),i=0,s=p;i<s;i++)n=(i-u)*(i-u),h=Math.floor(Math.sqrt(o+n)),a[i].y=r[i]+d[h];this.terrainPlane.tileBorders(),this.terrainPlane.computeFaceNormals(),this.terrainPlane.computeVertexNormals()},updateTerrain:function(){var t,e,i,s,a,r,o,n,h,l=this.terrainPlane.grid,c=this.terrainPlane.heightGrid,d=this.terrainPlane.resolution,p=this.velocities,u=.5*LIGHTS.deltaTime,m=1-5*LIGHTS.deltaTime;for(t=0,e=d;t<e;t++)for(a=l[t],n=c[t],h=p[t],i=0,s=d;i<s;i++)o=(r=a[i]).y,h[i]*=m,h[i]+=(n[i]-o)*(Math.abs(o)*u),r.y+=h[i];this.terrainPlane.tileBorders(),this.terrainPlane.computeFaceNormals(),this.terrainPlane.computeVertexNormals()},updateFlat:function(){var t,e,i,s,a,r,o=this.terrainPlane.grid,n=this.terrainPlane.resolution,h=4*LIGHTS.deltaTime;for(t=0,e=n;t<e;t++)for(a=o[t],i=0,s=n;i<s;i++)(r=a[i]).y-=r.y*h;this.terrainPlane.tileBorders(),this.terrainPlane.computeFaceNormals(),this.terrainPlane.computeVertexNormals()},launchFlat2Terrain:function(){var t,e,i,s,a=this.terrainPlane.resolution;this.terrainPlane.heightGrid;for(t=0,e=a;t<e;t++)for(i=0,s=a;i<s;i++)this.velocities[t][i]=0}},LIGHTS.TerrainMap=function(t){this.initialize(t)},LIGHTS.TerrainMap.size=512,LIGHTS.TerrainMap.uvOffset=.2,LIGHTS.TerrainMap.prototype={post:!0,opacity:.98,subtract:.005,initialize:function(t){this.renderer=t;var e,i,s,a,r,o,n,h,l,c=LIGHTS.TerrainMap.size,d=c/2,p=c*(1+2*LIGHTS.TerrainMap.uvOffset),u=.5*p,m={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat},T={minFilter:THREE.LinearMipMapLinearFilter,magFilter:THREE.LinearMipMapLinearFilter,format:THREE.RGBFormat};this.offset=c*LIGHTS.TerrainMap.uvOffset,this.viewRadius=u,this.camera=new THREE.Camera,this.camera.projectionMatrix=THREE.Matrix4.makeOrtho(-u,u,u,-u,-1e4,1e4),this.camera.position.z=100,this.scene=new THREE.Scene,this.postTexture=new THREE.WebGLRenderTarget(p,p,m),this.postCamera=new THREE.Camera,this.postCamera.projectionMatrix=THREE.Matrix4.makeOrtho(-d,d,d,-d,-1e4,1e4),this.postCamera.position.z=100,this.postScene=new THREE.Scene,this.glowScene=new THREE.Scene,this.texture=new THREE.WebGLRenderTarget(c,c,T),this.combinedTexture=new THREE.WebGLRenderTarget(c,c,m),this.canvasTexture=new THREE.WebGLRenderTarget(c,c,m),e=THREE.ShaderUtils.lib.screen,i={tDiffuse:{type:"t",value:0,texture:this.postTexture}},s=["varying vec2 vUv;","uniform sampler2D tDiffuse;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n"),this.screenMaterial=new THREE.MeshShaderMaterial({uniforms:i,vertexShader:e.vertexShader,fragmentShader:s,blending:THREE.AdditiveBlending,transparent:!0}),a={tDiffuse:{type:"t",value:0,texture:this.canvasTexture},opacity:{type:"f",value:this.opacity},subtract:{type:"f",value:this.subtract}},r=["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform float opacity;","uniform float subtract;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","texel.r = min( texel.r - subtract, texel.r * opacity );","texel.g = min( texel.g - subtract, texel.g * opacity );","texel.b = min( texel.b - subtract, texel.b * opacity );","gl_FragColor = texel;","}"].join("\n"),this.texturedMaterial=new THREE.MeshShaderMaterial({uniforms:a,vertexShader:e.vertexShader,fragmentShader:r}),(o=THREE.UniformsUtils.clone(i)).tDiffuse.texture=this.combinedTexture,n=new THREE.MeshShaderMaterial({uniforms:o,vertexShader:e.vertexShader,fragmentShader:s}),l=new THREE.PlaneGeometry(c,c),(h=new THREE.Mesh(l,this.texturedMaterial)).position.z=-10,this.postScene.addObject(h),this.setupTiledQuad(),this.combinedScene=new THREE.Scene,this.combinedQuad=new THREE.Mesh(l,n),this.combinedScene.addObject(this.combinedQuad);var g=new THREE.Mesh(new THREE.PlaneGeometry(p,p),new THREE.MeshBasicMaterial({map:this.canvasTexture}));g.z=-10,this.glowScene.addObject(g),this.combinedColor=new THREE.Mesh(l,new THREE.MeshBasicMaterial({color:0})),this.combinedColor.position.z=10,this.combinedColor.visible=!1,this.combinedScene.addObject(this.combinedColor)},setupTiledQuad:function(){var t,e,i=LIGHTS.TerrainMap.size,s=i/2,a=LIGHTS.TerrainMap.uvOffset,r=1-LIGHTS.TerrainMap.uvOffset,o=(.5-LIGHTS.TerrainMap.uvOffset)*s;e=new THREE.PlaneGeometry(i,i),this.setQuadUVs(e,a,a,a,r,r,r,r,a),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,o,s,o,-s,s,-s,s,s),this.setQuadUVs(t,0,a,0,r,a,r,a,a),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,-s,s,-s,-s,-o,-s,-o,s),this.setQuadUVs(t,r,a,r,r,1,r,1,a),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,-s,s,-s,o,s,o,s,s),this.setQuadUVs(t,a,r,a,1,r,1,r,r),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,-s,-o,-s,-s,s,-s,s,-o),this.setQuadUVs(t,a,0,a,a,r,a,r,0),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,o,s,o,o,s,o,s,s),this.setQuadUVs(t,0,r,0,1,a,1,a,r),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,-s,s,-s,o,-o,o,-o,s),this.setQuadUVs(t,r,r,r,1,1,1,1,r),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,o,-o,o,-s,s,-s,s,-o),this.setQuadUVs(t,0,0,0,a,a,a,a,0),GeometryUtils.merge(e,t),t=new THREE.PlaneGeometry(i,i),this.setQuadVertices(t,-s,-o,-s,-s,-o,-s,-o,-o),this.setQuadUVs(t,r,0,r,a,1,a,1,0),GeometryUtils.merge(e,t),this.postScene.addObject(new THREE.Mesh(e,this.screenMaterial))},setQuadVertices:function(t,e,i,s,r,o,n,h,l){var p=t instanceof THREE.Mesh?t.geometry:t;vertices=p.vertices,face=p.faces[0],a=vertices[face.a].position,b=vertices[face.b].position,c=vertices[face.c].position,d=vertices[face.d].position,a.x=e,a.y=i,b.x=s,b.y=r,c.x=o,c.y=n,d.x=h,d.y=l},setQuadUVs:function(t,e,i,s,a,r,o,n,h){var l=t instanceof THREE.Mesh?t.geometry:t;uvs=l.faceVertexUvs[0][0],uvs[0].u=e,uvs[0].v=i,uvs[1].u=s,uvs[1].v=a,uvs[2].u=r,uvs[2].v=o,uvs[3].u=n,uvs[3].v=h},update:function(){this.post?(this.renderer.render(this.scene,this.camera,this.postTexture,!0),this.texturedMaterial.uniforms.opacity.value=this.opacity,this.texturedMaterial.uniforms.subtract.value=this.subtract,this.renderer.render(this.postScene,this.postCamera,this.combinedTexture,!0),this.renderer.render(this.combinedScene,this.postCamera,this.canvasTexture,!0),this.renderer.render(this.glowScene,this.camera,this.texture,!0)):this.renderer.render(this.scene,this.camera,this.texture,!0)},clear:function(t){void 0===t&&(t=0),this.combinedColor.materials[0].color.setHex(t),this.combinedColor.visible=!0,this.combinedQuad.visible=!1,this.renderer.render(this.combinedScene,this.postCamera,this.canvasTexture,!0),this.combinedColor.visible=!1,this.combinedQuad.visible=!0}},LIGHTS.TerrainPlane=function(t,e,i,s){THREE.Geometry.call(this),this.resolution=e,this.segmentSize=t/e;var a,r,o,n,h,l,c,d,p,u,m,T=t/2,g=e+1,f=this.segmentSize;for(m=function(t,e,i){var s,a,r,o,n,h,l,c,d,p=[],u=document.createElement("canvas").getContext("2d");for(u.drawImage(i,0,0),s=u.getImageData(0,0,t,t).data,a=0;a<=t;a++)p[a]=[];for(a=0;a<=t;a++)for(o=a<t?a:0,r=0;r<=t;r++)n=r<t?r:0,p[a][r]=s[4*(o+n*t)];for(2,h=[],a=0;a<=t;a++)h[a]=p[a].slice(0);for(a=0;a<=t;a++)for(r=0;r<=t;r++){for(l=0,d=-2;d<=2;d++)for(c=-2;c<=2;c++)(o=a+c)<0?o+=t:o>t&&(o-=t),(n=r+d)<0?n+=t:n>t&&(n-=t),l+=h[o][n];p[a][r]=l/25}for(a=0;a<=t;a++)for(r=0;r<=t;r++)p[a][r]=e*((p[a][r]-128)/255);return p}(e,i,s),this.grid=[],this.vertexGrid=[],this.uvGrid=[],this.indexGrid=[],this.heightGrid=[],a=0;a<=e;a++)for(o=a*f-T,this.grid[a]=[],this.vertexGrid[a]=[],this.indexGrid[a]=[],this.heightGrid[a]=[],r=0;r<=e;r++)n=r*f-T,l=new THREE.Vector3(o,m[a][r],n),h=new THREE.Vertex(l),this.grid[a][r]=l,this.vertexGrid[a][r]=h,this.indexGrid[a][r]=this.vertices.length,this.heightGrid[a][r]=l.y,this.vertices.push(h);for(a=0;a<=e;a++)for(this.uvGrid[a]=[],r=0;r<=e;r++)this.uvGrid[a][r]=new THREE.UV(r/e,a/e);for(a=0;a<e;a++)for(r=0;r<e;r++)c=a+g*r,d=a+1+g*r,p=a+1+g*(r+1),u=a+g*(r+1),this.faces.push(new THREE.Face4(c,d,p,u)),this.faceVertexUvs[0].push([this.uvGrid[a][r],this.uvGrid[a+1][r],this.uvGrid[a+1][r+1],this.uvGrid[a][r+1]]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals(),this.vertexNormals=THREE.MeshUtils.getVertexNormals(this)},LIGHTS.TerrainPlane.prototype=new THREE.Geometry,LIGHTS.TerrainPlane.prototype.constructor=LIGHTS.TerrainPlane,LIGHTS.TerrainPlane.prototype.displaceVertex=function(t,e,i,s){var a,r,o,n,h,l,c,d,p=i*i,u=2*i,m=this.resolution,T=this.grid;for(a=0;a<u;a++)for(o=(a-i)*(a-i),l=T[(m+t+a-i)%m],r=0;r<u;r++)n=(r-i)*(r-i),h=(m+e+r-i)%m,(d=Math.max(0,1-(o+n)/p))>0&&(l[h].y+=s*(Math.sin(rad180*d-rad90)+1)*.5);for(l=T[m],c=T[0],r=0;r<=m;r++)l[r].y=c[r].y;for(a=0;a<m;a++)T[a][m].y=T[a][0].y;this.__dirtyVertices=!0},LIGHTS.TerrainPlane.prototype.tileBorders=function(){var t,e,i,s,a=this.resolution,r=this.grid;for(i=r[a],s=r[0],e=0;e<=a;e++)i[e].y=s[e].y;for(t=0;t<a;t++)r[t][a].y=r[t][0].y;this.__dirtyVertices=!0},LIGHTS.TerrainPlane.prototype.resetVertices=function(){for(x=0;x<=this.resolution;x++)for(y=0;y<=this.resolution;y++)this.grid[x][y].y=this.heightGrid[x][y];this.__dirtyVertices=!0,this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},LIGHTS.TileManager=function(t){this.initialize(t)},LIGHTS.TileManager.prototype={estimatedTileCount:16,containers:[],containerTable:{},containerPool:[],managers:[],initialize:function(t){this.director=t,this.terrain=t.terrain,this.scene=t.view.scene,this.stars=new LIGHTS.StarManager(t),this.managers.push(this.stars),this.terrainDots=new LIGHTS.TerrainDotsManager(t),this.managers.push(this.terrainDots),this.terrainMesh=new LIGHTS.TerrainMeshManager(t),this.managers.push(this.terrainMesh),this.balls=new LIGHTS.BallsManager(t),this.managers.push(this.balls),this.cannons=new LIGHTS.CannonManager(t),this.managers.push(this.cannons);for(var e=0;e<this.estimatedTileCount;e++)this.containerPool.push(this.createTileContainer());this.ready=!1},createTileContainer:function(){var t=new THREE.Object3D;this.containers.push(t);var e=[];return t.balls=new LIGHTS.BallsTile(this.balls,t),e.push(t.balls),t.stars=new LIGHTS.StarTile(this.stars,t),e.push(t.stars),e.push(new LIGHTS.TerrainDotsTile(this.terrainDots)),e.push(new LIGHTS.TerrainMeshTile(this.terrainMesh)),e.push(new LIGHTS.CannonsTile(this.cannons)),t.tiles=e,this.scene.addChild(t),t},update:function(){var t,e,i,s,a,r=this.managers;for(e in this.containerTable)1!=this.terrain.tileIdSet[e]?(t=this.containerTable[e],delete this.containerTable[e],this.containerPool.push(t),THREE.SceneUtils.showHierarchy(t,!1),t.visible=!1):0;for(e in this.terrain.tileIdSet)void 0===this.containerTable[e]&&(this.containerPool.length>0?(t=this.containerPool.pop()).visible=!0:(t=this.createTileContainer(),console.log("createTileContainer",this.containers.length)),this.terrain.selectTileById(e),t.position.copy(this.terrain.selectedTile.position),this.updateTiles(t),this.containerTable[e]=t);for(s=0,a=r.length;s<a;s++)(i=this.managers[s]).active&&i.update()},apply:function(){for(var t in this.containerTable)this.updateTiles(this.containerTable[t])},updateTiles:function(t){var e,i,s,a,r;for(e=0;e<t.tiles.length;e++)for(a=(s=t.tiles[e]).manager.active,i=0;i<s.children.length;i++)(r=s.children[i]).interactive?a&&r.active?r.parent!==t&&THREE.MeshUtils.addChild(this.scene,t,r):r.parent===t&&THREE.MeshUtils.removeChild(this.scene,t,r):a?(r.parent!==t&&THREE.MeshUtils.addChild(this.scene,t,r),r.visible=!0):(r.parent===t&&THREE.MeshUtils.removeChild(this.scene,t,r),r.visible=!1);t.balls.updateTile(),t.stars.updateTile()}},LIGHTS.Ball=function(t,e,i,s){this.initialize(t,e,i,s)},LIGHTS.Ball.prototype={testMode:!1,groupSelectAdd:[[0,0,1],[0,1,0],[0,0,1],[1,0,0],[1,0,0],[0,1,0]],selectAddIntensity:.7,initialize:function(t,e,i,s){this.manager=t,this.container=e,this.behaviour=t.behaviours[i],this.behaviour.balls.push(this),this.geometries=t.geometries,this.terrainDisplacement=t.director.terrain.displacement,this.scene=t.director.view.scene,this.children=[],this.visible=!1,this.state=0,this.interactive=!1,this.selected=!1,this.unselected=!1,this.mouseOver=!1,this.selectGrow=!1,this.selectMultiply=!1,this.selectAdditive=!1,this.selectedPhase=0,this.alpha=0,this.ballSize=LIGHTS.BallGeometries.prototype.ballSize,this.ballOffset=.86*LIGHTS.BallGeometries.prototype.ballSize,this.stemLength=LIGHTS.BallGeometries.prototype.stemLength;var a,r,o=this.geometries,n=this.behaviour.colorIndex;this.colorIndex=n,r=o.sphereGeometries[n],this.sphereGeometry=r,this.sphereMaterial=o.createSphereMaterial(s),this.addR=this.sphereMaterial.addR,this.addG=this.sphereMaterial.addG,this.addB=this.sphereMaterial.addB,(a=new THREE.Mesh(r,this.sphereMaterial)).useQuaternion=!0,a.interactive=!0,a.active=!1,this.ball=a,this.children.push(a),this.selectAddR=this.groupSelectAdd[n][0]*this.selectAddIntensity,this.selectAddG=this.groupSelectAdd[n][1]*this.selectAddIntensity,this.selectAddB=this.groupSelectAdd[n][2]*this.selectAddIntensity,this.selectAdd=0,r=o.balloonGeometries[n],(a=new THREE.Mesh(r,this.sphereMaterial)).useQuaternion=!0,a.interactive=!0,a.active=!1,this.balloon=a,this.children.push(a),this.rotation=new THREE.Quaternion,this.rotation.setFromEuler(new THREE.Vector3(0,0,5)),this.scale=this.behaviour.scale,this.grow=this.growTarget=0,this.colliderRoot=new THREE.SphereCollider(new THREE.Vector3,0),this.colliderRoot.mesh=this.ball,this.colliderRoot.ball=this,t.mouseOverCollisions.colliders.push(this.colliderRoot),this.colliderBall=new THREE.SphereCollider(new THREE.Vector3,0),this.colliderBall.mesh=this.ball,this.colliderBall.ball=this,t.mouseOverCollisions.colliders.push(this.colliderBall),this.colliderBall.other=this.colliderRoot,this.colliderRoot.other=this.colliderBall,this.colliderBall.enabled=!0,this.colliderClick=new THREE.SphereCollider(new THREE.Vector3,0),this.colliderClick.mesh=this.balloon,this.colliderClick.ball=this,t.clickCollisions.colliders.push(this.colliderClick),this.setState(this.state),this.testMode&&(this.trident=new THREE.Trident,this.trident.scale.x=this.trident.scale.y=this.trident.scale.z=.4,t.director.view.scene.addChild(this.trident))},setState:function(t){switch(t){case 0:this.interactive=this.selected=this.unselected=!1,this.mouseOver=!1,this.selectGrow=!1,this.selectMultiply=!1,this.selectAdditive=!1,this.grow=this.growTarget=0,this.ball.active=!0,this.balloon.active=!1,this.colliderRoot.enabled=!1;break;case 1:this.ball.active=!0,this.selected&&this.unselect(!0),this.colliderRoot.enabled=!0;var e=this.balloon.scale;e.x=e.y=e.z=this.behaviour.scale;break;case 2:this.balloon.active=this.balloon.visible=!0,this.balloon.parent!==this.container&&THREE.MeshUtils.addChild(this.scene,this.container,this.balloon),this.colliderRoot.enabled=!1;break;case 3:this.selected&&this.unselect(),this.colliderRoot.enabled=!1;break;case 4:this.selected&&this.unselect(),this.colliderClick.radiusSq=this.colliderClick.radius=0}this.state=t},select:function(){if(!this.unselected||this.selectedPhase==LIGHTS.Music.phase.index)switch(this.interactive=this.selected=!0,this.unselected=!1,this.selectedPhase=LIGHTS.Music.phase.index,this.scale=this.behaviour.scale,LIGHTS.Music.phase.index){case 1:case 2:this.selected=!1;break;case 3:case 4:case 5:case 6:case 8:this.selectGrow=!0,this.growTarget=1,this.setRotation(),this.setScale(),this.selectAdditive=!0;break;case 7:this.selectMultiply=!0,this.behaviour.multiply=1;break;case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 17:case 18:case 19:case 20:case 21:0==this.state?(this.selectGrow=!0,this.growTarget=1,this.setRotation(),this.setScale()):this.selectGrow=!1,this.selectAdditive=!0}},unselect:function(t){switch(this.unselected=!0,this.selectedPhase){case 3:case 4:case 5:t&&(this.interactive=this.unselected=this.selectAdditive=!1,this.addR.value=this.selectAddR,this.addG.value=this.selectAddG,this.addB.value=this.selectAddB,this.selectAdd=1),this.selected=!1;break;case 6:this.selected=!t&&this.grow<=.99;break;case 7:t?(this.interactive=this.unselected=this.selectMultiply=!1,this.behaviour.multiply=1,this.sphereMaterial.multiply.value=1):this.behaviour.multiply=0,this.selected=!1;break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 17:case 18:case 19:case 20:case 21:0==this.state?this.selected=!t&&this.grow<=.99:t&&(this.interactive=this.unselected=this.selectAdditive=!1,this.addR.value=this.addG.value=this.addB.value=0,this.selectAdd=0),this.selected=!1}},update:function(){var t,e=LIGHTS.deltaTime,i=this.behaviour;switch(this.visible&&this.container.visible?(this.ball.visible=this.ball.active,this.balloon.visible=this.balloon.active):this.ball.visible=this.balloon.visible=!1,this.selectAdditive&&(this.selected?(t=10*e,this.addR.value-=(this.addR.value-this.selectAddR)*t,this.addG.value-=(this.addG.value-this.selectAddG)*t,this.addB.value-=(this.addB.value-this.selectAddB)*t,this.selectAdd-=(this.selectAdd-1)*t):this.unselected&&(t=10*e,this.addR.value-=this.addR.value*t,this.addG.value-=this.addG.value*t,this.addB.value-=this.addB.value*t,this.selectAdd-=this.selectAdd*t,this.selectAdd<.01&&(this.addR.value=this.addG.value=this.addB.value=0,this.selectAdd=0,this.selectAdditive=!1,this.selectGrow||(this.interactive=this.unselected=!1)))),this.state){case 0:this.selectGrow?(this.selected?(this.grow-=(this.grow-.3)*e*4,this.scale-=(this.scale-1.5*i.rootScale)*e*4,this.grow>.29&&this.unselected&&(this.selected=!1)):this.unselected&&(this.grow-=(this.grow-0)*e*4,this.scale-=(this.scale-i.scale)*e*12,this.grow<.01&&(this.interactive=this.unselected=this.selectGrow=!1,this.scale=i.scale)),this.setPosition(this.grow*this.stemLength*this.scale),this.setScale()):this.selectMultiply&&(this.selected?this.sphereMaterial.multiply.value<1&&(this.sphereMaterial.multiply.value-=(this.sphereMaterial.multiply.value-1)*e*10,this.sphereMaterial.multiply.value>.99&&(this.sphereMaterial.multiply.value=1)):this.unselected&&(this.sphereMaterial.multiply.value-=(this.sphereMaterial.multiply.value-0)*e*10,this.sphereMaterial.multiply.value<.01&&(this.sphereMaterial.multiply.value=0,this.interactive=this.unselected=this.selectMultiply=!1)));break;case 1:this.selectGrow&&(this.grow-=(this.grow-i.grow)*e*4,this.scale-=(this.scale-i.scale)*e*8,Math.abs(this.grow-i.grow)<.01&&(this.interactive=this.unselected=this.selectGrow=!1,this.grow=i.grow,this.scale=i.scale),this.setPosition(this.grow*this.stemLength*this.scale),this.setScale());break;case 2:this.balloon.active&&(this.balloon.position.copy(i.ballPosition),this.ball.position.copy(i.ballPosition),this.balloon.quaternion.multiplySelf(this.rotation));break;case 3:this.sphereMaterial.multiply.value-=this.sphereMaterial.multiply.value*e*2,this.sphereMaterial.multiply.value<.01&&(this.balloon.active=this.balloon.visible=!1,this.balloon.parent===this.container&&THREE.MeshUtils.removeChild(this.scene,this.container,this.balloon),this.colliderClick.radiusSq=this.colliderClick.radius=0);break;case 4:var s=this.balloon.scale;s.x=Math.max(.001,s.x-8*e),s.y=s.z=s.x}var a=i.root,r=Math.max(this.scale,i.scale);this.colliderRoot.center.x=a.x+this.container.position.x,this.colliderRoot.center.y=a.y+this.container.position.y,this.colliderRoot.center.z=a.z+this.container.position.z,this.colliderBall.center.x=this.ball.position.x+this.container.position.x,this.colliderBall.center.y=this.ball.position.y+this.container.position.y,this.colliderBall.center.z=this.ball.position.z+this.container.position.z,this.colliderRoot.radius=this.colliderBall.radius=r*this.ballSize*phi*2,this.colliderRoot.radiusSq=this.colliderBall.radiusSq=this.colliderBall.radius*this.colliderBall.radius,this.state<2?(this.colliderClick.center.x=this.colliderBall.center.x,this.colliderClick.center.y=this.colliderBall.center.y,this.colliderClick.center.z=this.colliderBall.center.z,this.colliderClick.radius=r*this.ballSize,this.colliderClick.radiusSq=this.colliderClick.radius*this.colliderClick.radius):(this.colliderClick.center.x=this.balloon.position.x+this.container.position.x,this.colliderClick.center.y=this.balloon.position.y+this.container.position.y,this.colliderClick.center.z=this.balloon.position.z+this.container.position.z),this.testMode&&(this.trident.position.add(this.ball.position,this.container.position),this.selected?(this.trident.rotation.x=-rad90,this.trident.rotation.z=0):this.unselected?(this.trident.rotation.x=0,this.trident.rotation.z=rad90):(this.trident.rotation.x=0,this.trident.rotation.z=0))},removeSphere:function(){this.ball.active=this.ball.visible=!1,this.ball.parent===this.container&&THREE.MeshUtils.removeChild(this.scene,this.container,this.ball)},setPosition:function(t){var e,i,s,a,r=this.behaviour.root,o=this.behaviour.normal;e=r.x+o.x*t,i=r.y+o.y*t,s=r.z+o.z*t,(a=this.ball.position).x=e,a.y=i,a.z=s,this.balloon.active&&((a=this.balloon.position).x=e,a.y=i,a.z=s)},setRotation:function(){var t=this.behaviour,e=t.up,i=t.normal,s=t.q,a=t.h;a.add(e,i),a.normalize(),s.w=e.dot(a),s.x=e.y*a.z-e.z*a.y,s.y=e.z*a.x-e.x*a.z,s.z=e.x*a.y-e.y*a.x,this.ball.quaternion.copy(s),this.balloon.active&&this.balloon.quaternion.copy(s)},setScale:function(){var t=this.scale,e=this.ball.scale;e.x=e.y=e.z=t,this.balloon.active&&((e=this.balloon.scale).x=e.y=e.z=t)}},LIGHTS.BallBehaviour=function(t,e){this.initialize(t,e)},LIGHTS.BallBehaviour.prototype={ballFat:.5,up:new THREE.Vector3(0,1,0),h:new THREE.Vector3,q:new THREE.Quaternion,initialize:function(t,e){this.index=e,this.groupIndex=e%2;var i=t.director.terrain;this.root=i.randomVertex.position,this.normal=i.randomNormal,this.terrainDisplacement=i.displacement,this.state=0,this.visible=!1,this.position=new THREE.Vector3,this.ballPosition=new THREE.Vector3,this.scale=this.rootScale=.5*Math.random()+.25,this.scaleDown=0,this.fatActive=!1,this.fat=this.fatTarget=0,this.fatEase=12*Math.random()+4,this.grow=this.growTarget=0,this.stemLength=LIGHTS.BallGeometries.prototype.stemLength,this.colorIndex=3*this.groupIndex+Math.floor(3*Math.random()),void 0===LIGHTS.BallGeometries.prototype.groupBehaviours[this.groupIndex]&&(LIGHTS.BallGeometries.prototype.groupBehaviours[this.groupIndex]=this),this.additive=0,this.multyiply=0,this.balls=[]},setState:function(t){var e,i,s=this.balls;for(e=0,i=s.length;e<i;e++)s[e].setState(t);switch(t){case 0:this.fatActive=!1,this.growActive=!1,this.fat=this.fatTarget=0,this.grow=this.growTarget=0,this.additive=1,this.scale=this.rootScale,this.setPosition(this.scaleDown),this.setRotation(),this.setScale();break;case 1:this.growActive=!0,this.growTarget=1,this.setRotation(),this.setScale();break;case 2:this.ballPosition.copy(this.position),this.height=this.position.y+50*Math.random()+25,this.ease=.2*Math.random()+.2,this.growTarget=0}this.state=t},update:function(){var t,e,i=LIGHTS.deltaTime,s=this.balls;for(t=0,e=s.length;t<e;t++)s[t].update();switch(this.state){case 0:this.fatActive&&(this.fat-=(this.fat-this.fatTarget)*i*this.fatEase,1==this.fatTarget?this.fat=Math.min(this.fat,this.fatTarget):0==this.fatTarget&&(this.fat=Math.max(this.fat,this.fatTarget)),this.scale=this.rootScale*(1+this.fat*this.ballFat),this.setScale()),this.terrainDisplacement.active&&(this.setPosition(this.scaleDown),this.setRotation());break;case 1:this.grow-=(this.grow-this.growTarget)*i*2.5,1==this.growTarget?this.grow=Math.min(this.grow,this.growTarget):0==this.growTarget&&(this.grow=Math.max(this.grow,this.growTarget)),this.setPosition(this.grow*this.stemLength*this.scale),this.terrainDisplacement.active&&this.setRotation();break;case 2:this.scale-=this.scale*i*8,this.scale<.05&&(this.scale=.01),this.setScale(),this.ballPosition.y-=(this.position.y-this.height)*i*this.ease}},setPosition:function(t){var e,i,s,a,r,o,n,h=this.balls,l=this.position,c=this.normal,d=this.root;for(e=l.x=d.x+c.x*t,i=l.y=d.y+c.y*t,s=l.z=d.z+c.z*t,o=0,n=h.length;o<n;o++)(a=h[o]).selectGrow||((r=a.ball.position).x=e,r.y=i,r.z=s)},setRotation:function(){var t,e,i=this.balls,s=this.up,a=this.normal,r=this.q,o=this.h;for(o.add(s,a),o.normalize(),r.w=s.dot(o),r.x=s.y*o.z-s.z*o.y,r.y=s.z*o.x-s.x*o.z,r.z=s.x*o.y-s.y*o.x,t=0,e=i.length;t<e;t++)i[t].ball.quaternion.copy(r)},setScale:function(){var t,e,i,s,a=this.balls,r=this.scale;for(t=0,e=a.length;t<e;t++)(i=a[t]).selectGrow||((s=i.ball.scale).x=s.y=s.z=r)}},LIGHTS.BallExplosions=function(t,e,i,s){this.initialize(t)},LIGHTS.BallExplosions.prototype={explosionCount:16,explosionPool:[],explosions:[],particleMaps:["plasmaRed","plasmaYellow","plasmaGreen","plasmaCyan","plasmaBlue","plasmaMagenta","plasmaWhite"],ballColorTable:[[1,0],[5,0],[1,2],[3,2],[3,4],[5,4]],initialize:function(t){var e,i,s,a;for(this.scene=t.director.view.scene,this.materials=[],s=0,a=this.particleMaps.length;s<a;s++)(i=new THREE.Texture(LIGHTS.images[this.particleMaps[s]])).needsUpdate=!0,e=new THREE.ParticleBasicMaterial({vertexColors:!0,size:16,map:i,blending:THREE.AdditiveBlending,transparent:!0}),this.materials.push(e);for(s=0,a=this.explosionCount;s<a;s++)explosion=new LIGHTS.BallExplosion(e),this.explosionPool.push(explosion),this.explosions.push(explosion)},launchExplosion:function(t){var e=this.explosionPool.pop();if(void 0!==e){THREE.MeshUtils.addChild(this.scene,this.scene,e.particleSystem),e.particleSystem.visible=!0;var i=6;LIGHTS.Music.phase.index>2&&(i=this.ballColorTable[t.colorIndex][Math.floor(2*Math.random())]),e.particleSystem.materials[0]=this.materials[i],e.launch(t)}},update:function(){var t,e,i,s=this.explosions;for(t=0,e=s.length;t<e;t++)(i=s[t]).active&&i.update();for(t=0,e=s.length;t<e;t++)(i=s[t]).active&&i.life<0&&(i.particleSystem.visible=i.active=!1,THREE.MeshUtils.removeChild(this.scene,this.scene,i.particleSystem),this.explosionPool.push(i))}},LIGHTS.BallExplosion=function(t){this.initialize(t)},LIGHTS.BallExplosion.prototype={particleCount:512,gravityStream:-256,gravityExplosion:0,initialize:function(t){var e,i,s,a;for(this.particleGeometry=new THREE.Geometry,this.particles=[],a=this.particleGeometry.colors=[],e=0,i=this.particleCount;e<i;e++)(s=new THREE.Vector3).x=32*Math.random()-16,s.y=32*Math.random()-16,s.z=32*Math.random()-16,s.velocity=new THREE.Vector3,s.color=new THREE.Color(0),this.particles.push(s),this.particleGeometry.vertices.push(new THREE.Vertex(s)),a.push(s.color);this.particleSystem=new THREE.ParticleSystem(this.particleGeometry,t),this.particleSystem.sortParticles=!1,this.particleSystem.dynamic=!0,this.particleSystem.visible=!1,this.active=!1},launch:function(t){if(this.ball=t,!(t.state>3)){var e,i,s,a,r,o,n,h,l,c=this.particles,d=(this.colors,t.state>=2);for(d&&t.setState(4),e=0,i=c.length;e<i;e++)o=c[e],d?(s=2*Math.random()-1,h=l=96*Math.random()+64,o.life=.2*Math.random()+.2,o.delay=.1*Math.random()+.08):(s=.5*Math.random()+.5,l=256*Math.random()+128,h=64*Math.random()+64,o.delay=.5*Math.random()),a=Math.random()*rad360,r=Math.sqrt(1-s*s),(n=o.velocity).x=Math.cos(a)*r*h,n.y=s*l,n.z=Math.sin(a)*r*h,d||t.ball.quaternion.multiplyVector3(n),o.drag=.01*Math.random()+.005,o.color.r=o.color.g=o.color.b=0,o.intensity=.3*Math.random()+.7,o.launch=!1;this.life=2,this.active=!0}},update:function(){var t,e,i,s,a,r=LIGHTS.deltaTime,o=this.particleGeometry,n=this.particles,h=this.ball,l=h.state>=2,c=(l?this.gravityExplosion:this.gravityStream)*r,d=l?h.balloon.position:h.ball.position,p=h.container.position,u=h.behaviour.normal,m=l?0:h.scale*h.ballSize-2.5,T=d.x+p.x+m*u.x,g=d.y+p.y+m*u.y,f=d.z+p.z+m*u.z;for(t=0,e=n.length;t<e;t++)(i=n[t]).delay<0?(s=i.velocity,i.x+=s.x*r,i.y+=s.y*r,i.z+=s.z*r,s.y+=c,drag=1-i.drag*r,s.x*=drag,s.y*=drag,s.z*=drag,i.launch&&((a=i.color).r=a.g=a.b=i.intensity,o.__dirtyColors=!0,i.launch=!1),l?(i.life-=r,i.life<0&&(i.life>-.25?((a=i.color).r=i.intensity*(1+4*i.life),a.g=a.b=a.r,o.__dirtyColors=!0):((a=i.color).r=a.g=a.b=0,o.__dirtyColors=!0))):s.y<0&&((a=i.color).r=a.g=a.b=Math.min(1,10*-i.intensity/s.y),o.__dirtyColors=!0)):(i.delay-=r,i.delay<0&&(i.x=T,i.y=g,i.z=f,i.launch=!0));o.__dirtyVertices=!0,this.life-=r}},LIGHTS.BallGeometries=function(t){this.initialize(t)},LIGHTS.BallGeometries.prototype={ballSize:16,stemWidth:.05,stemRadius:2,stemLength:48,stemCapHeight:2,stemReflectivity:.4,sphereColors:[[16776960,16711680],[16711935,16711680],[16776960,65280],[65535,65280],[65535,255],[16711935,255]],spotColors:[16736352,16736352,6356832,6356832,6316287,6316287],groupBehaviours:[],initialize:function(t){this.director=t,this.createSphereGeometries(),this.createBalloonGeometries(),this.createStemGeometry()},createSphereGeometries:function(){var t,e,i,s;for(this.sphereGeometries=[],i=0,s=this.sphereColors.length;i<s;i++)t=this.createDropGeometry(),e=this.sphereColors[i],THREE.MeshUtils.createVertexColorGradient(t,[e[0],e[1]],.6667),this.sphereGeometries.push(t);this.sphereShader={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,{addR:{type:"f",value:0}},{addG:{type:"f",value:0}},{addB:{type:"f",value:0}},{multiply:{type:"f",value:1}}]),fragmentShader:["uniform float addR;","uniform float addG;","uniform float addB;","uniform float multiply;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vColor * multiply, 1.0 );","gl_FragColor.r = min( gl_FragColor.r + addR, 1.0 );","gl_FragColor.g = min( gl_FragColor.g + addG, 1.0 );","gl_FragColor.b = min( gl_FragColor.b + addB, 1.0 );",THREE.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:[THREE.ShaderChunk.color_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n")},this.sphereMaterials=[],this.sphereMaterialGroups=[],this.groupAdditives=[0,0],this.groupMultiplies=[1,1]},createBalloonGeometries:function(){var t,e,i,s;for(this.balloonGeometries=[],i=0,s=this.sphereColors.length;i<s;i++)t=new LIGHTS.SphereGeometry(this.ballSize,16,12),e=this.sphereColors[i],THREE.MeshUtils.createVertexColorGradient(t,[e[0],e[1]]),this.balloonGeometries.push(t)},createDropGeometry:function(){var t,e,i,s,a,r,o,n,h=[1.81821399749878,2.402843307774461,3.7592494738495223,6.7234277501566355,9.351939279986453,11.548022675641983,13.9635861231426,15.482072410492423,15.999999947561278,15.454813063676234,13.856406445413263,11.31370807962314,7.999999973780639,4.141104984053141],l=[],c=new LIGHTS.CapsuleGeometry(1,1,1,16,[-45,-30.168032,-23.313184,-17.65832,-14.0680352,-11.2017072,-7.888,-4.0291056,.112,4.2531056,8.112,11.4257088,13.9684064,15.5668128],!0,15,1,!1),d=c.vertices;for(v=0,t=0,e=h.length;t<e;t++)for(s=h[t],r=0;r<16;r++)i=d[v++].position,a=Math.atan2(i.z,i.x),o=Math.cos(a),n=Math.sin(a),i.x=s*o,i.z=s*Math.sin(a),i.cos=o,i.sin=n,l.push(i);return c.positions=l,c},refDropRs:[1,2.402843307774461,3.7592494738495223,6.7234277501566355,9.351939279986453,11.548022675641983,13.9635861231426,15.482072410492423,15.999999947561278,15.454813063676234,13.856406445413263,11.31370807962314,7.999999973780639,4.141104984053141],refGrowRs:[],updateDrops:function(t){var e,i,s,a,r,o,n,h,l,c,d,p=this.ballSize,u=this.refDropRs,m=this.refGrowRs,T=void 0===t;for(a=0;a<2;a++){for(d=this.groupBehaviours[a],c=T?1-(Math.sin(Math.min(1,1.1*d.grow)*rad90-rad90)+1):1-(Math.sin(Math.min(1,t)*rad90-rad90)+1),e=0;e<9;e++)m[e]=u[e]-(u[e]-p)*c;if(!T||1==d.growTarget)for(r=3*a,o=3*(a+1);r<o;r++){for(geometry=this.sphereGeometries[r],positions=geometry.positions,n=0,e=0,i=m.length;e<i;e++)for(l=m[e],s=0;s<16;s++)(h=positions[n++]).x=l*h.cos,h.z=l*h.sin;geometry.__dirtyVertices=!0}}},createSphereSpikes:function(t){var e,i,s,a,r,o=t.vertices,n=t.grid,h=[],l=[];for(t.spikesOff=l,t.spikesOn=h,i=0,s=o.length;i<s;i++)l.push(o[i].position.clone()),h.push(o[i].position.clone());for(i=0,s=n.length;i<s;i+=2)if((e=n[i])[0]!=e[1])for(a=0,r=e.length;a<r;a+=2)h[e[a]].multiplyScalar(phi+Math.random());else h[e[0]].multiplyScalar(phi+Math.random())},tweenSphereSpikes:function(t,e){var i,s,a,r,o,n=t.vertices,h=t.spikesOn,l=t.spikesOff,c=1-e;for(r=0,o=n.length;r<o;r++)i=n[r].position,s=h[r],a=l[r],i.x=s.x*e+a.x*c,i.y=s.y*e+a.y*c,i.z=s.z*e+a.z*c;t.__dirtyVertices=!0},createSphereMaterial:function(t){uniforms=THREE.UniformsUtils.clone(this.sphereShader.uniforms);var e=new THREE.MeshShaderMaterial({fog:this.director.view.scene.fog,vertexColors:THREE.VertexColors,uniforms:uniforms,vertexShader:this.sphereShader.vertexShader,fragmentShader:this.sphereShader.fragmentShader});return e.addR=uniforms.addR,e.addG=uniforms.addG,e.addB=uniforms.addB,e.multiply=uniforms.multiply,e.addR.value=0,e.addG.value=0,e.addB.value=0,e.multiply.value=this.groupMultiplies[t],void 0===this.sphereMaterialGroups[t]&&(this.sphereMaterialGroups[t]=[]),this.sphereMaterialGroups[t].push(e),this.sphereMaterials.push(e),e},setSphereMultiplyAdditive:function(t,e,i){var s,a,r,o=void 0!==i,n=o?this.sphereMaterialGroups[i]:this.sphereMaterials;for(a=0,r=n.length;a<r;a++)(s=n[a]).addR.value=e,s.addG.value=e,s.addB.value=e,s.multiply.value=t;o?(this.groupMultiplies[i]=t,this.groupAdditives[i]=e):(this.groupMultiplies[0]=this.groupMultiplies[1]=t,this.groupAdditives[0]=this.groupAdditives[1]=e)},setSphereMultiply:function(t,e){var i,s,a=void 0!==e,r=a?this.sphereMaterialGroups[e]:this.sphereMaterials;for(i=0,s=r.length;i<s;i++)r[i].multiply.value=t;a?this.groupMultiplies[e]=t:this.groupMultiplies[0]=this.groupMultiplies[1]=t},setSphereAdditive:function(t,e){var i,s,a,r=void 0!==e,o=r?this.sphereMaterialGroups[e]:this.sphereMaterials;for(i=0,s=o.length;i<s;i++)(a=o[i]).addR.value=t,a.addG.value=t,a.addB.value=t;r?this.groupAdditives[e]=t:this.groupAdditives[0]=this.groupAdditives[1]=t},setSphereBlend:function(t,e){var i,s,a=void 0!==e?this.sphereMaterialGroups[e]:this.sphereMaterials;for(i=0,s=a.length;i<s;i++)a[i].blending=t?THREE.AdditiveBlending:THREE.NormalBlending,a[i].transparent=t},createStemGeometry:function(){this.stemGeometry=new LIGHTS.CapsuleGeometry(this.stemRadius,this.stemRadius,this.stemLength,8,[0,1],!0,this.stemCapHeight,1,!1),this.moveVertexY(this.stemGeometry.vertices,-(.97*this.ballSize+this.stemLength)),this.stemMaterial=new THREE.MeshBasicMaterial({color:16777215})},createStemGeometryTube:function(){for(this.stemGeometry=new LIGHTS.CapsuleGeometry(this.stemRadius,this.stemRadius,this.stemLength,12,[0,.5,1],!0,this.stemCapHeight,2,!1),THREE.MeshUtils.createVertexColorGradient(this.stemGeometry,[0,0,0,0,0,8421504]),this.moveVertexY(this.stemGeometry.vertices,-(.97*this.ballSize+this.stemLength)),this.stemMaterials=[],i=0;i<this.sphereColors.length;i++)material=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}),this.stemMaterials.push(material),this.director.materialCache.addMaterial(material);this.resetStemColors()},createStemGeometry_Spot:function(){this.stemGeometry=new LIGHTS.SpotGeometry(this.stemRadius,this.stemRadius,this.stemLength),this.moveVertexY(this.stemGeometry.vertices,-(.97*this.ballSize+this.stemLength));var t=new THREE.Texture(LIGHTS.images.spotLine);for(t.needsUpdate=!0,this.stemMaterials=[],i=0;i<this.sphereColors.length;i++)material=new THREE.MeshBasicMaterial({color:16777215,map:t,blending:THREE.AdditiveBlending,transparent:!0}),this.stemMaterials.push(material),this.director.materialCache.addMaterial(material);this.resetStemColors()},setStemColors:function(t){var e,i,s=this.stemMaterials;for(e=0,i=s.length;e<i;e++)s[e].color.setHex(t);this.stemColors=t},resetStemColors:function(){if(null!==this.stemColors){var t,e,i=this.stemMaterials,s=this.spotColors;for(t=0,e=i.length;t<e;t++)i[t].color.setHex(s[t]);this.stemColors=null}},setStemReflection:function(t){var e,i,s=this.stemMaterials;for(e=0,i=s.length;e<i;e++)s[e].reflectivity=t},resetStemReflection:function(){var t,e,i=this.stemMaterials,s=this.stemReflectivity;for(t=0,e=i.length;t<e;t++)i[t].reflectivity=s},moveVertexY:function(t,e){for(var i=0;i<t.length;i++)t[i].position.y+=e}},LIGHTS.BallsManager=function(t){this.initialize(t)},LIGHTS.BallsManager.prototype={ballsPerTile:40,releaseVelocity:5,gravity:-4096,active:!1,tiles:[],balls:[],behaviours:[],visibleGroups:[],cameraTilePosition:new THREE.Vector3,beats:0,initialize:function(t){this.director=t,this.geometries=new LIGHTS.BallGeometries(t);var e,i,s=t.terrain;for(s.selectCenterTile(),e=0,i=this.ballsPerTile;e<i;e++)s.selectTerrainRandomVertex(!0,3,3),this.behaviours.push(new LIGHTS.BallBehaviour(this,e));this.volume=0,this.nextBeat=0,this.mouse=new THREE.Vector3(0,0,.5),this.projector=new THREE.Projector,this.camera=t.view.camera,this.ray=new THREE.Ray(this.camera.position,this.mouse),this.explosions=new LIGHTS.BallExplosions(this),this.mouseOverCollisions=new THREE.CollisionSystem,this.clickCollisions=new THREE.CollisionSystem,this.state=0},launch:function(){var t=this.geometries;switch(LIGHTS.Music.phase.index){case 0:this.beats=1,this.resetState(0),this.setSphereMultiplyAdditive(0,0);break;case 1:t.setSphereBlend(!1),this.setSphereMultiplyAdditive(0,1,0),this.showGroup(0,!0),this.showGroup(1,!1);break;case 2:this.setSphereMultiplyAdditive(0,1,1),this.showGroup(1,!0);break;case 3:this.setSphereMultiplyAdditive(1,1),this.activateFat(!0),this.setFat(phi,1),this.nextBeat=1;break;case 4:case 6:this.setSphereAdditive(1),this.setFat(phi,1),this.nextBeat=1;break;case 5:this.changeFat(),this.nextBeat=2;break;case 7:this.unselect(),this.setSphereMultiply(0),this.activateFat(!1);break;case 8:this.unselect(),this.setSphereMultiplyAdditive(1,1),this.nextBeat=1;break;case 9:this.beats=0,this.unselect(),this.setState(1,!0),this.setGrow(0,0),this.setGrow(1,1);break;case 10:this.beats=1;break;case 11:this.setSphereAdditive(1),this.setState(2,!0),this.nextBeat=1;break;case 13:case 22:this.setState(3,!0);break;case 15:case 16:break;case 17:this.resetState(0),this.activateFat(!0),this.setFat(phi,1),t.setSphereBlend(!1),this.setSphereMultiplyAdditive(1,1),this.setRotation(),this.nextBeat=1;break;case 18:this.setSphereMultiplyAdditive(1,1),this.unselect(),this.setState(1,!0),this.setGrow(0,1),this.setGrow(1,0),this.nextBeat=1;break;case 19:case 20:this.setSphereMultiplyAdditive(1,1),this.changeGrow(),this.beats=0,this.nextBeat=1;break;case 21:this.setSphereMultiplyAdditive(1,1),this.setState(2,!0),this.nextBeat=1}},beat:function(){var t=this.geometries;switch(LIGHTS.Music.phase.index){case 1:this.beats%2==0?this.setSphereAdditive(1,0):this.setSphereAdditive(0,0);break;case 2:this.beats%2==0?(this.setSphereAdditive(1,0),this.setSphereAdditive(0,1)):(this.setSphereAdditive(0,0),this.setSphereAdditive(1,1));break;case 3:case 4:case 6:case 17:0==this.nextBeat?this.changeFat():(this.setFat(0,1),this.setFat(1,.5),this.setSphereAdditive(0),this.nextBeat--);break;case 5:0==this.nextBeat?this.changeFat():1==this.nextBeat?(this.setFat(0,1),this.setFat(1,.5),this.setSphereAdditive(0),this.nextBeat--):(this.setFat(phi,1),this.setSphereAdditive(1),this.nextBeat--);break;case 8:1==this.nextBeat&&(this.setSphereAdditive(0),this.nextBeat--);break;case 9:this.beats>1&&this.beats%2==0&&this.changeGrow();break;case 10:15==this.beats?(this.setGrow(1,0),this.setGrow(1,1)):this.beats<16&&this.beats%2==1&&this.changeGrow();break;case 11:1==this.nextBeat&&(this.setSphereAdditive(0),this.removeSpheres(),t.setSphereBlend(!0),this.nextBeat--);break;case 18:case 19:1==this.nextBeat&&(this.setSphereAdditive(0),this.nextBeat--),this.beats%2==1&&this.changeGrow();break;case 20:1==this.nextBeat&&(this.setSphereAdditive(0),this.nextBeat--),13==this.beats?(this.setGrow(1,0),this.setGrow(1,1)):this.beats<14&&this.beats%2==1&&this.changeGrow();break;case 21:1==this.nextBeat&&(this.setSphereAdditive(0),t.setSphereBlend(!0),this.nextBeat--)}this.beats++},update:function(){var t,e,i=this.behaviours;for(t=0,e=i.length;t<e;t++)i[t].update();this.explosions.update()},raycast:function(){var t,e,i,s,a,r,o=this.ray.origin,n=this.mouse,h=this.balls;for(n.x=LIGHTS.Input.mouseX,n.y=-LIGHTS.Input.mouseY,n.z=.5,this.projector.unprojectVector(n,this.camera),n.x-=o.x,n.y-=o.y,n.z-=o.z,n.normalize(),e=this.mouseOverCollisions.rayCastAll(this.ray),a=0,r=h.length;a<r;a++)h[a].mouseOver=!1;for(a=0,r=e.length;a<r;a++)null!=(i=e[a])&&i.enabled&&(-1!=(s=e.indexOf(i.other))&&(e[s]=null),(t=i.ball).mouseOver=!0,!t.ball.visible||t.selected||t.unselected||t.select());for(a=0,r=h.length;a<r;a++)(t=h[a]).selected&&!t.mouseOver&&t.unselect(!1);LIGHTS.Input.mouseClick&&(LIGHTS.Input.mouseClick=!1,null!==(i=this.clickCollisions.rayCastNearest(this.ray))&&(i.ball.ball.visible||i.ball.balloon.visible)&&this.explosions.launchExplosion(i.ball))},unselect:function(){var t,e,i,s=this.balls;for(e=0,i=s.length;e<i;e++)((t=s[e]).selected||t.unselected)&&t.unselect(!0)},showGroup:function(t,e){var i,s,a,r,o,n=this.tiles,h=this.behaviours;for(i=0,s=n.length;i<s;i++)for(a=0,r=(o=n[i].groups[t]).length;a<r;a++)o[a].visible=e;for(i=0,s=h.length;i<s;i++)h[i].groupIndex==t&&(h[i].visible=e);this.visibleGroups[t]=e},setState:function(t,e,i){var s,a,r,o=this.behaviours,n=t-1;for(s=0,a=o.length;s<a;s++)(r=o[s]).state<t&&(e||r.state==n&&Math.random()<i)&&r.setState(t);this.state=t},resetState:function(t){var e,i,s=this.behaviours;for(e=0,i=s.length;e<i;e++)s[e].setState(t)},setRotation:function(){var t,e=this.balls,i=e.length;for(t=0;t<i;t++)e[t].setRotation()},removeSpheres:function(){var t,e=this.balls,i=e.length;for(t=0;t<i;t++)e[t].removeSphere()},selectBallsAdditive:function(t){var e,i,s,a,r,o,n=this.tiles;for(s=0,a=n.length;s<a;s++)for(r=0,o=(e=n[s].groups[t]).length;r<o;r++)(i=e[r]).sphereMaterial.additive.value=i.selectAdditive?1:0},setSphereAdditive:function(t,e){var i,s,a=this.behaviours,r=void 0===e;for(i=0,s=a.length;i<s;i++)(r||a[i].groupIndex==e)&&(a[i].additive=t);this.geometries.setSphereAdditive(t,e)},setSphereMultiplyAdditive:function(t,e,i){var s,a,r,o=this.behaviours,n=void 0===i;for(s=0,a=o.length;s<a;s++)r=o[s],(n||o[s].groupIndex==i)&&(r.additive=e,r.multiply=t);this.geometries.setSphereMultiplyAdditive(t,e,i)},setSphereMultiply:function(t,e){var i,s,a=this.behaviours,r=void 0===e;for(i=0,s=a.length;i<s;i++)(r||a[i].groupIndex==e)&&(a[i].multiply=t);this.geometries.setSphereMultiply(t,e)},activateFat:function(t){var e,i,s=this.behaviours;for(e=0,i=s.length;e<i;e++)s[e].fatActive=t},changeFat:function(){var t,e,i,s=this.behaviours;for(t=0,e=s.length;t<e;t++)0==(i=s[t]).state&&(i.fatTarget=1-i.fatTarget)},setFat:function(t,e){var i,s,a,r=this.behaviours;for(i=0,s=r.length;i<s;i++)0==(a=r[i]).state&&Math.random()<e&&(a.fatTarget=t)},activateGrow:function(t){var e,i,s=this.behaviours;for(e=0,i=s.length;e<i;e++)s[e].growActive=t},changeGrow:function(){var t,e,i,s=this.behaviours;for(t=0,e=s.length;t<e;t++)(i=s[t]).state>0&&(i.growTarget=1-i.growTarget)},setGrow:function(t,e){var i,s,a,r=this.behaviours;for(i=0,s=r.length;i<s;i++)a=r[i],r[i].groupIndex==e&&(a.growTarget=t)}},LIGHTS.BallsTile=function(t,e){this.initialize(t,e)},LIGHTS.BallsTile.prototype={initialize:function(t,e){var i,s,a,r,o;for(this.manager=t,this.containerPosition=e.position,this.cameraPosition=t.director.view.camera.position,this.children=[],this.balls=[],this.groups=[[],[]],i=0;i<t.ballsPerTile;i++){for(o=i%2,a=new LIGHTS.Ball(t,e,i,o),s=0;s<a.children.length;s++)this.children.push(a.children[s]);this.groups[o].push(a),this.balls.push(a),t.balls.push(a)}for(i=0;i<this.groups.length;i++)for(group=this.groups[i],r=t.visibleGroups[i],s=0;s<group.length;s++)(a=group[s]).visible=r;t.tiles.push(this)},updateTile:function(){this.balls}},LIGHTS.SphereGeometry=function(t,e,i){THREE.Geometry.call(this);t=t||50;var s,a,r=e||8,o=i||6,n=Math.PI,h=Math.max(3,r),l=Math.max(2,o),c=[];for(this.grid=c,a=0;a<l+1;a++){var d=a/l,p=t*Math.cos(d*n),u=t*Math.sin(d*n),m=[],T=0;for(s=0;s<h;s++){var g=2*s/h,f=u*Math.sin(g*n),y=u*Math.cos(g*n);(0==a||a==l)&&s>0||(T=this.vertices.push(new THREE.Vertex(new THREE.Vector3(y,p,f)))-1),m.push(T)}c.push(m)}var v,b,S,H=c.length;for(a=0;a<H;a++){var E=c[a].length;if(a>0)for(s=0;s<E;s++){var x=s==E-1,w=c[a][x?0:s+1],M=c[a][x?E-1:s],G=c[a-1][x?E-1:s],I=c[a-1][x?0:s+1],L=a/(H-1),R=(a-1)/(H-1),C=(s+1)/E,z=s/E,P=new THREE.UV(1-C,L),k=new THREE.UV(1-z,L),A=new THREE.UV(1-z,R),V=new THREE.UV(1-C,R);a<c.length-1&&(v=this.vertices[w].position.clone(),b=this.vertices[M].position.clone(),S=this.vertices[G].position.clone(),v.normalize(),b.normalize(),S.normalize(),this.faces.push(new THREE.Face3(w,M,G,[new THREE.Vector3(v.x,v.y,v.z),new THREE.Vector3(b.x,b.y,b.z),new THREE.Vector3(S.x,S.y,S.z)])),this.faceVertexUvs[0].push([P,k,A])),a>1&&(v=this.vertices[w].position.clone(),b=this.vertices[G].position.clone(),S=this.vertices[I].position.clone(),v.normalize(),b.normalize(),S.normalize(),this.faces.push(new THREE.Face3(w,G,I,[new THREE.Vector3(v.x,v.y,v.z),new THREE.Vector3(b.x,b.y,b.z),new THREE.Vector3(S.x,S.y,S.z)])),this.faceVertexUvs[0].push([P,A,V]))}}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals(),this.boundingSphere={radius:t}},LIGHTS.SphereGeometry.prototype=new THREE.Geometry,LIGHTS.SphereGeometry.prototype.constructor=LIGHTS.SphereGeometry,LIGHTS.CannonManager=function(t){this.initialize(t)},LIGHTS.CannonManager.prototype={countPerTile:8,cannonRadius:8,spotColors:[16728128,4259648,4210943,16777024,4259839,16728319],active:!1,tiles:[],cannons:[],spots:[],positions:[],normals:[],initialize:function(t){this.director=t;var e,i,s,a,r=t.terrain,o=new THREE.Color(0),n=new THREE.Color(16777215);for(this.cannonGeometry=new LIGHTS.CapsuleGeometry(this.cannonRadius,this.cannonRadius,this.cannonRadius,16,[0,1],!0,this.cannonRadius,3,!0,this.cannonRadius,4),e=0,i=(s=this.cannonGeometry.faces).length;e<i;e++)s[e].color=o;for(e=48,i=64;e<i;e++)s[e].color=n;var h=new THREE.Texture([LIGHTS.images.envMapLeftRight,LIGHTS.images.envMapLeftRight,LIGHTS.images.envMapTop,LIGHTS.images.envMapBottom,LIGHTS.images.envMapFrontBack,LIGHTS.images.envMapFrontBack]);h.needsUpdate=!0,this.cannonMaterial=new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,envMap:h,reflectivity:.4,combine:THREE.MultiplyOperation,shading:THREE.SmoothShading}),t.materialCache.addMaterial(this.cannonMaterial),this.spotGeometry=new LIGHTS.SpotGeometry(1.5*this.cannonRadius,3*this.cannonRadius,192),this.moveVertexY(this.spotGeometry.vertices,this.cannonRadius),this.spotMaterials=[];var l=new THREE.Texture(LIGHTS.images.spot);for(l.needsUpdate=!0,e=0,i=this.spotColors.length;e<i;e++)a=new THREE.MeshBasicMaterial({map:l,color:this.spotColors[e],blending:THREE.AdditiveBlending,transparent:!0}),this.spotMaterials.push(a),t.materialCache.addMaterial(a);for(r.selectCenterTile(),e=0,i=this.countPerTile;e<i;e++)r.selectTerrainRandomVertex(!0,3),this.positions.push(r.randomVertex.position),this.normals.push(r.randomNormal)},launch:function(){this.geometries;switch(LIGHTS.Music.phase.index){case 17:this.resetSpotMaterials(),this.cannonMaterial.color.setHex(16777215),this.cannonMaterial.reflectivity=.4,this.rotationActive=!1;break;case 19:this.rotationActive=!0,this.rotationTime=0;break;case 22:this.cannonMaterial.reflectivity=0}},resetSpotMaterials:function(){var t,e,i=this.spotMaterials,s=this.spotColors;for(t=0,e=i.length;t<e;t++)i[t].color.setHex(s[t])},fadeMaterials:function(){var t,e,i,s=this.spotMaterials,a=1-8*LIGHTS.deltaTime;for(t=0,e=s.length;t<e;t++)(i=s[t].color).r*=a,i.g*=a,i.b*=a;(i=this.cannonMaterial.color).r*=a,i.g*=a,i.b*=a},update:function(){if(this.rotationActive){this.rotationTime+=LIGHTS.deltaTime;var t,e=this.tiles,i=e.length;for(t=0;t<i;t++)e[t].update();LIGHTS.time>=208&&this.fadeMaterials()}},moveVertexY:function(t,e){for(var i=0;i<t.length;i++)t[i].position.y+=e}},LIGHTS.CannonsTile=function(t){this.initialize(t)},LIGHTS.CannonsTile.prototype={initialize:function(t){var e,i,s,a;for(this.manager=t,this.children=[],this.cannons=[],this.spots=[],this.groups=[[],[]],e=0;e<t.countPerTile;e++)s=(a=Math.random()>.5)?rad45:-rad45,(i=new THREE.Mesh(t.cannonGeometry,t.cannonMaterial)).position=t.positions[e],i.rotation.x=s,this.children.push(i),this.cannons.push(i),t.cannons.push(i),i.offset=a?rad90:-rad90,i.freq=Math.random()+.5,i.rotX=s,(i=new THREE.Mesh(t.spotGeometry,t.spotMaterials[Math.floor(Math.random()*t.spotMaterials.length)])).doubleSided=!0,i.position=t.positions[e],i.rotation.x=s,this.children.push(i),this.spots.push(i),t.spots.push(i);t.tiles.push(this)},update:function(){var t,e,i,s,a=this.cannons,r=this.spots,o=this.manager.rotationTime;for(e=0,i=a.length;e<i;e++)s=a[e],t=Math.sin(s.offset+o*s.freq)*rad45,s.rotation.x=t,r[e].rotation.x=t}},LIGHTS.StarManager=function(t){this.initialize(t)},LIGHTS.StarManager.prototype={active:!1,tiles:[],particleCount:256,particleSize:4,arpKeys:[[0,.255,.38,.63,.75],[0,.125,.38,.5,.75]],initialize:function(t){var e,i,s,a;for(this.director=t,this.tileSize=t.terrain.tileSize,this.particles=new THREE.Geometry,this.particles.colors=[],this.stars=[],a=new THREE.ParticleBasicMaterial({vertexColors:!0,size:this.particleSize,map:LIGHTS.TextureUtils.getCircleTexture(32),blending:THREE.AdditiveBlending,transparent:!0}),e=0,i=this.particleCount*LIGHTS.TileManager.prototype.estimatedTileCount;e<i;e++)(s=new LIGHTS.Star).position=new THREE.Vector3(999999,0,999999),s.color=new THREE.Color(0),this.stars.push(s),this.particles.vertices.push(new THREE.Vertex(s.position)),this.particles.colors.push(s.color);this.particleSystem=new THREE.ParticleSystem(this.particles,a),this.particleSystem.sortParticles=!1,this.particleSystem.dynamic=!0,this.director.view.scene.addChild(this.particleSystem)},launch:function(){switch(LIGHTS.Music.phase.index){case 0:this.particleSystem.visible=!0,this.beats=0,this.arpTimes=this.arpKeys[0],this.nextArpIndex=0,this.nextArpTime=this.arpTimes[0];break;case 22:this.particleSystem.visible=!1}},beat:function(){this.arpTimes=this.arpKeys[this.beats++%2],this.nextArpIndex=0,this.nextArpTime=this.arpTimes[0]},update:function(){var t,e,i,s,a=this.stars,r=LIGHTS.deltaTime;for(i=0,s=a.length;i<s;i++)(t=this.stars[i]).life+=r,(e=2*t.life%2)>1&&(e=1-(e-1)),t.color.r=t.color.g=t.color.b=4*(Math.sin(e*rad90-rad90)+1);this.particles.__dirtyColors=!0},updateKeys:function(){var t=LIGHTS.time>this.nextArpTime;t&&(this.nextArpIndex++,this.nextArpIndex>=this.arpTimes.length?(this.beats++,this.arpTimes=this.arpKeys[Math.floor(this.beats%4/2)],this.nextArpTime=Math.floor(LIGHTS.time+1)+this.arpTimes[0],this.nextArpIndex=0):this.nextArpTime=Math.floor(LIGHTS.time)+this.arpTimes[this.nextArpIndex]);var e,i,s,a,r=this.stars,o=LIGHTS.deltaTime,n=this.nextArpIndex;for(s=0,a=r.length;s<a;s++)(e=this.stars[s]).life+=o,(i=e.life)<e.fadeIn?i/e.fadeIn:i>e.fadeOut&&1-(i-e.fadeOut)/e.fadeOutTime,i>e.lifeTime&&(0,e.life=0,e.lifeTime=1*Math.random()+.5,e.fadeIn=(.5*Math.random()+.5)*e.lifeTime,e.fadeOut=(.5*Math.random()+.5)*(e.lifeTime-e.fadeIn),e.fadeOutTime=e.lifeTime-e.fadeOut),t&&e.key==n?e.color.r=e.color.g=e.color.b=8:(e.color.r*=.95,e.color.g*=.95,e.color.b*=.95);this.particles.__dirtyColors=!0}},LIGHTS.StarTile=function(t,e){this.initialize(t,e)},LIGHTS.StarTile.prototype={initialize:function(t,e){this.manager=t,this.container=e,this.particles=t.particles,this.stars=t.stars,this.children=[],this.index=t.tiles.length,this.tilePositionX=null,this.tilePositionZ=null,t.tiles.push(this)},update:function(){},updateTile:function(){var t=this.container.position.x,e=this.container.position.z;if(this.tilePositionX!=t||this.tilePositionZ!=e){var i,s,a=this.manager.stars,r=this.manager.tileSize,o=this.manager.particleCount;for(i=this.index*o,s=(this.index+1)*o;i<s;i++)star=a[i],star.position.x=t+(Math.random()-.5)*r,star.position.y=150*Math.random()+80,star.position.z=e+(Math.random()-.5)*r;this.particles.__dirtyVertices=!0,this.tilePositionX=t,this.tilePositionZ=e}}},LIGHTS.Star=function(){this.initialize()},LIGHTS.Star.prototype={initialize:function(){this.position=null,this.color=null,this.life=4*Math.random(),this.lifeTime=0,this.fadeIn=0,this.fadeOut=0,this.key=Math.floor(4*Math.random()),3==this.key?this.key=4:1==this.key&&Math.random()>.5&&(this.key=3)}},LIGHTS.TerrainDotAvatars=function(t){this.initialize(t)},LIGHTS.TerrainDotAvatars.prototype={avatarCount:9,initialize:function(t){this.manager=t,this.player=t.director.player,this.avatars=[];var e,i,s,a,r=0,o=0;for(s=0,a=this.avatarCount;s<a;s++)s%3==1?22:21,1==Math.floor(s/3)?22:21,e=22,i=s%2==0?LIGHTS.images["ellieAvatar"+r++]:LIGHTS.images["avatar"+o++],avatar=new LIGHTS.TerrainDotAvatar(i,e,22),avatar.index=s,this.avatars.push(avatar)}},LIGHTS.TerrainDotAvatar=function(t,e,i){this.initialize(t,e,i)},LIGHTS.TerrainDotAvatar.prototype={opacity:2,initialize:function(t,e,i){var s,a,r,o,n,h,l,c,d=document.createElement("canvas").getContext("2d"),p=this.opacity;for(d.drawImage(t,0,0,e,i),s=d.getImageData(0,0,e,i).data,this.width=e,this.height=i,this.colors=[],r=0;r<e;r++){for(a=[],o=0;o<i;o++)n=4*(r+o*e),h=Math.floor(s[n++]*p),l=Math.floor(s[n++]*p),c=Math.floor(s[n++]*p),a.push([h/255,l/255,c/255]);this.colors.push(a)}}},LIGHTS.TerrainDotsManager=function(t){this.initialize(t)},LIGHTS.TerrainDotsManager.prototype={active:!1,beats:0,grid:[],tiles:[],circles:[],brightColor:new THREE.Color(16777215),darkColor:new THREE.Color(0),debugColor:new THREE.Color(16711680),activeMult:1,avatarOrder:[[0,4],8,2,6,1,5,[3,7]],avatarPosX:[0,22,44,0,22,44,0,22,44],avatarPosY:[0,0,0,22,22,22,44,44,44],rgbColors:[[1,0,0],[0,1,0],[0,0,1],[1,1,0],[0,1,1],[1,0,1]],arpKeys:[0,.375,.75,1,1.375,1.75,2.125,2.5,2.75,3.125,3.5,3.75,4,4.375,4.75,5,5.375,5.75,6.125,6.5,6.75,7.125,7.5,7.75],initialize:function(t){var e,i,s,a,r,o;for(this.director=t,this.terrainPlane=t.terrain.terrainPlane,this.displacement=t.terrain.displacement,this.geometry=new THREE.Geometry,this.geometry.colors=[],this.terrainVertices=[],this.particleVertices=[],this.dots=[],this.avatar=null,e=0,s=0;e<LIGHTS.Terrain.prototype.mapResolution;e++)for(this.grid[e]=[],i=0;i<LIGHTS.Terrain.prototype.mapResolution;i++)this.grid[e][i]=s++,o=t.terrain.terrainPlane.vertexGrid[e][i],r=new THREE.Vertex(o.position.clone()),this.terrainVertices.push(o),this.particleVertices.push(r),this.geometry.colors.push(new THREE.Color(65535)),(a=new LIGHTS.TerrainDot(r.position)).index=s-1,this.dots.push(a);for(this.geometry.vertices=this.terrainVertices,texture=new THREE.Texture(LIGHTS.images.terrainDot),texture.needsUpdate=!0,this.material=new THREE.ParticleBasicMaterial({vertexColors:!0,size:20,color:12632256,map:texture,blending:THREE.AdditiveBlending,transparent:!0}),this.beatTime=.1,this.allPainted=1,s=0;s<6;s++)this.circles.push(new LIGHTS.TerrainCircle(s))},launch:function(){switch(LIGHTS.Music.phase.index){case 0:this.beats=1,this.material.color.setHex(12632256),this.material.size=20,this.resetDots(),this.paintAll(0,!0),this.geometry.vertices=this.terrainVertices,this.dirtyVertices=!0;break;case 1:case 2:this.paintCircles(16,!0);break;case 3:this.paintAll(2,!0);break;case 4:case 6:case 12:this.paintAll(1,!0);break;case 5:this.resetParticles(),this.setupWords(),this.launchWords(),this.geometry.vertices=this.particleVertices,this.dirtyVertices=!0,this.nextBeat=1;break;case 7:this.paintAll(0);break;case 11:this.resetDots(),this.material.size=32,this.paintAll(1,!0),this.geometry.vertices=this.terrainVertices,this.dirtyVertices=!0;break;case 13:this.setupAvatars(),this.launchAvatars(),this.paintAll(1,!0);break;case 15:this.material.size=20,this.resetDots(),this.paintAll(0,!0),this.paintCircles(192);break;case 16:this.material.size=20,this.paintAll(1,!0);break;case 17:this.material.color.setHex(16777215),this.paintAll(0,!0),this.paintCircles(128);break;case 18:case 19:case 20:this.paintAll(0,!0),this.paintCircles(128);break;case 21:this.resetParticles(),this.paintAll(1,!0),this.beats=0;break;case 22:this.paintAll(0,!0),this.paintCircles(128),this.setupMoveUp(),this.geometry.vertices=this.particleVertices,this.dirtyVertices=!0}},beat:function(){switch(LIGHTS.Music.phase.index){case 1:this.beats%2==0&&this.paintCircles(16,!0);break;case 2:this.paintCircles(12,!0);break;case 3:case 4:case 6:this.paintCircles(32);break;case 5:0==this.nextBeat?this.paintCircles(32):(this.paintAll(1,!0),this.nextBeat--);break;case 11:case 12:this.paintCircles(8);break;case 13:case 14:this.beats%2==0&&this.launchAvatar();break;case 15:case 17:case 18:case 19:case 20:break;case 21:this.beats%2!=1&&-1==[12,14].indexOf(this.beats)||(this.paintAll(0,!0),this.paintCircles(128))}this.beats++},update:function(){switch(this.geometry.__dirtyVertices=this.dirtyVertices||this.terrainPlane.__dirtyVertices,this.dirtyVertices=!1,LIGHTS.Music.phase.index){case 0:this.paintDarker(!0,!1,4),this.updateMovingCircles();break;case 1:case 2:this.paintDarker(!0,!1,3);break;case 3:case 4:this.paintDarker(!0,!1,1);break;case 5:case 6:this.moveToWords(),this.paintDarker(!1,!0,.5);break;case 7:this.explodeWords();break;case 11:case 12:case 17:case 18:case 19:case 20:this.paintDarker(!0,!1,.5);break;case 13:case 14:this.paintDarker(!1,!1,.5),this.updateAvatar();break;case 15:break;case 21:this.paintDarker(!0,!1,4);break;case 22:this.moveUp()}},paintAll:function(t,e){var i,s,a,r=this.geometry.colors,o=this.dots,n=o.length;for(i=0;i<n;i++)s=o[i],!e&&s.isActive||((a=r[s.index]).r=a.g=a.b=t);this.allPainted=t,this.geometry.__dirtyColors=!0},paintDarker:function(t,e,i){var s,a,r,o,n=this.geometry.colors,h=this.activeMult,l=this.dots,c=l.length,d=1-i*LIGHTS.deltaTime;for(s=0;s<c;s++)o=(a=l[s]).isActive,t||!o?((r=n[a.index]).r*=d,r.g*=d,r.b*=d):e&&((r=n[a.index]).r>h&&(r.r*=d),r.g>h&&(r.g*=d),r.b>h&&(r.b*=d));this.geometry.__dirtyColors=!0},paintCircles:function(t,e){var i,s,a,r,o,n,h,l,c,d,p,u,m,T,g,f,y,v,b,S,H=this.geometry.colors,E=LIGHTS.Terrain.prototype.mapResolution,x=void 0===e||!1===e,w=this.dots,M=this.grid,G=this.activeMult;for(e&&(n=h=l=2),u=0;u<t;u++)for(s=(i=4*Math.random()+4)*i,i=Math.floor(i),a=Math.floor(Math.random()*E),r=Math.floor(Math.random()*E),x&&(n=(o=this.rgbColors[Math.floor(Math.random()*this.rgbColors.length)])[0],h=o[1],l=o[2],c=Math.min(n+.5,1)*G,d=Math.min(h+.5,1)*G,p=Math.min(l+.5,1)*G),m=a-i,g=a+i;m<=g;m++)for(v=m>=0?M[m%E]:M[(m+Math.ceil(-m/E)*E)%E],y=(a-m)*(a-m),T=r-i,f=r+i;T<=f;T++)y+(r-T)*(r-T)<=s&&(b=H[S=T>=0?v[T%E]:v[(T+Math.ceil(-T/E)*E)%E]],w[S].isActive?(b.r=c,b.g=d,b.b=p):(b.r+=n,b.g+=h,b.b+=l));this.allPainted=null,this.geometry.__dirtyColors=!0},updateMovingCircles:function(){var t,e,i,s,a,r,o,n,h,l,c,d,p,u,m,T=LIGHTS.deltaTime,g=this.geometry.colors,f=this.circles,y=LIGHTS.Terrain.prototype.mapResolution,v=this.grid;for(o=0,n=f.length;o<n;o++)if((e=f[o]).delay<0){for(i=Math.ceil(e.radius),s=e.radius*e.radius,a=e.posX,r=e.posY,t=e.grey,h=a-i,c=a+i;h<=c;h++)for(u=h>=0?v[h%y]:v[(h+Math.ceil(-h/y)*y)%y],p=(a-h)*(a-h),l=r-i,d=r+i;l<=d;l++)s-(p+(r-l)*(r-l))>=0&&((m=g[l>=0?u[l%y]:u[(l+Math.ceil(-l/y)*y)%y]]).r+=t,m.g+=t,m.b+=t);e.radius+=T*e.speed,e.grey-=T*e.fade,e.grey<=0&&e.reset(0)}else e.delay-=T;this.allPainted=null,this.geometry.__dirtyColors=!0},setupAvatars:function(){var t,e,i,s,a,r,o,n,h,l,c,d,p,u,m,T,g,f=this.dots,y=this.grid,v=this.avatarPosX,b=this.avatarPosY,S=new LIGHTS.TerrainDotAvatars(this).avatars;for(this.avatars=S,l=0,c=S.length;l<c;l++){for(e=(t=S[l]).colors,u=t.width,m=t.height,T=v[l],g=b[l],r=[],d=0;d<u;d++){for(i=e[d],s=y[d+T],o=[],p=0;p<m;p++)h=(a=f[s[p+g]]).avatarColor=new THREE.Color(0),n=i[p],h.r=n[0],h.g=n[1],h.b=n[2],o.push(a);r.push(o)}t.dots=r}},launchAvatars:function(){var t,e,i=this.dots;this.avatars,this.avatarPosX,this.avatarPosY;for(t=0,e=i.length;t<e;t++)i[t].isActive=!1;this.avatarNext=0},launchAvatar:function(){this.avatarNext>-1&&(this.avatarNext<this.avatarOrder.length?(this.avatarOrder[this.avatarNext]instanceof Array?this.avatar=null:this.avatar=this.avatars[this.avatarOrder[this.avatarNext]],this.avatarNext++,this.avatarLine=0):this.avatarNext=-1)},updateAvatar:function(){if(this.avatarNext>0&&null!==this.avatarLine){var t,e,i,s,a,r,o,n,h,l,c=this.geometry.colors,d=null===this.avatar,p=Math.ceil(30*LIGHTS.deltaTime);for(t=0,e=d?2:1;t<e;t++)for(dots=d?this.avatars[this.avatarOrder[this.avatarNext-1][t]].dots:this.avatar.dots,a=this.avatarLine,r=Math.min(dots.length,this.avatarLine+p);a<r;a++)for(s=0,i=(n=dots[a]).length;s<i;s++)(o=n[s]).isActive=!0,h=c[o.index],l=o.avatarColor,h.r=l.r,h.g=l.g,h.b=l.b;this.geometry.__dirtyColors=!0,this.avatarLine+=p,this.avatarLine>=dots.length&&(this.avatarLine=null)}},updateAvatarFade:function(){if(this.avatarNext>0){var t,e,i,s,a,r,o,n,h=this.geometry.colors,l=this.avatar,c=l.dots,d=l.height,p=2*LIGHTS.deltaTime;for(t=0,e=l.width;t<e;t++)for(r=c[t],s=0,i=d;s<i;s++)(a=r[s]).isActive=!0,o=h[a.index],n=a.avatarColor,o.r-=(o.r-n[0])*p,o.g-=(o.g-n[1])*p,o.b-=(o.b-n[2])*p;this.geometry.__dirtyColors=!0,this.avatarTime-=LIGHTS.deltaTime,this.avatarTime<0&&this.launchAvatar()}},setupWords:function(){var t,e,i,s,a,r,o,n;for(this.text=new LIGHTS.TerrainDotsText(this),t=0;t<this.text.words.length;t++)for(i=this.text.words[t].dots,e=0;e<i.length;e++){s=1e3;do{dot=this.dots[Math.floor(Math.random()*this.dots.length)]}while(--s>0&&dot.isText);dot.isText?console.log("ERROR: LIGHTS.TerrainDotsManager.setupWords: Dot without text not found!"):(dot.isText=!0,dot.delay=t+.2+.5*Math.random(),dot.wordPosition=i[e],a=2*Math.random()-1,r=Math.random()*rad360,o=Math.sqrt(1-a*a),n=96*Math.random()+64,dot.velocity.x=Math.cos(r)*o*n,dot.velocity.y=a*n,dot.velocity.z=Math.sin(r)*o*n)}},launchWords:function(){var t,e,i=this.dots,s=i.length;for(t=0;t<s;t++)(e=i[t]).isText&&(e.isActive=!0,e.ease=2.5+Math.random())},moveToWords:function(){this.text.update();var t,e,i,s,a,r=LIGHTS.deltaTime,o=this.dots,n=o.length;for(t=0;t<n;t++)(e=o[t]).isText&&(e.delay<0?(s=e.position,a=e.wordPosition,i=r*e.ease,s.x-=(s.x-a.x)*i,s.y-=(s.y-a.y)*i,s.z-=(s.z-a.z)*i,e.ease-=(e.ease-10)*i*.1):e.delay-=r);this.dirtyVertices=!0},explodeWords:function(){var t,e,i,s,a,r,o=LIGHTS.deltaTime,n=this.geometry.colors,h=this.dots,l=h.length,c=1-2*o;for(t=0;t<l;t++)(e=h[t]).isText&&(i=e.position,s=e.velocity,i.x+=s.x*o,i.y+=s.y*o,i.z+=s.z*o,a=1-e.drag*o,s.x*=a,s.y*=a,s.z*=a,(r=n[e.index]).r*=c,r.g*=c,r.b*=c);this.dirtyVertices=!0,this.geometry.__dirtyColors=!0},resetDots:function(){var t,e=this.dots,i=e.length;for(t=0;t<i;t++)e[t].reset()},updateTerrainParticles:function(){var t,e,i,s,a=this.terrainVertices,r=this.dots,o=r.length;for(t=0;t<o;t++)(e=r[t]).isText||e.isAvatar||(i=e.position,s=a[t].position,i.x=s.x,i.y=s.y,i.z=s.z)},resetParticles:function(){var t,e,i=this.terrainVertices,s=this.particleVertices,a=this.dots,r=a.length;for(e=0;e<r;e++)position=s[e].position,t=i[e].position,position.x=t.x,position.y=t.y,position.z=t.z,a[e].reset()},showDebug:function(){var t,e,i,s=this.geometry.colors,a=LIGHTS.Terrain.prototype.mapResolution,r=this.grid,o=this.debugColor;for(t=0;t<a;t++)for(i=r[t],e=0;e<a;e++)s[i[e]]=o;this.geometry.__dirtyColors=!0},show:function(t){var e,i,s=this.tiles;for(e=0,i=s.length;e<i;e++)s[e].particleSystem.visible=t},setupMoveUp:function(){var t,e,i,s,a,r=this.dots,o=this.geometry.colors,n=this.arpKeys,h=n.length;for(t=0,e=r.length;t<e;t++)(i=r[t]).position.y=0,i.delay=n[Math.floor(Math.random()*h)],i.height=150*Math.random()+50,i.ease=2+Math.random(),s=i.color,a=o[t],s.r=a.r,s.g=a.g,s.b=a.b;this.geometry.__dirtyColors=!0},moveUp:function(){var t,e,i,s,a,r,o=LIGHTS.deltaTime,n=this.dots,h=this.terrainVertices,l=this.geometry.colors;for(t=0,e=n.length;t<e;t++)(i=n[t]).delay<0?(i.position.y-=(i.position.y-i.height)*o*i.ease,s=i.color,r=l[t],a=1-i.position.y/i.height,r.r=s.r*a,r.g=s.g*a,r.b=s.b*a):(i.position.y=h[t].position.y,i.delay-=o);this.geometry.__dirtyColors=!0,this.dirtyVertices=!0}},LIGHTS.TerrainDot=function(t){this.initialize(t)},LIGHTS.TerrainDot.prototype={initialize:function(t){this.position=t,this.delay=0,this.avatarColor=null,this.color=new THREE.Color,this.index=null,this.velocity=new THREE.Vector3,this.drag=.01*Math.random()+.005,this.reset()},reset:function(){this.isText=!1,this.isAvatar=!1,this.isActive=!1}},LIGHTS.TerrainCircle=function(t){this.initialize(t)},LIGHTS.TerrainCircle.prototype={initialize:function(t){this.index=t,this.reset(t)},reset:function(t){this.active=!1,this.posX=Math.floor(Math.random()*LIGHTS.Terrain.prototype.mapResolution),this.posY=Math.floor(Math.random()*LIGHTS.Terrain.prototype.mapResolution),this.radius=0,this.grey=1.2,this.delay=t,this.speed=25*Math.random()+5,this.fade=2}},LIGHTS.TerrainDotsTile=function(t){this.initialize(t)},LIGHTS.TerrainDotsTile.prototype={initialize:function(t){this.manager=t,this.children=[],this.particleSystem=new THREE.ParticleSystem(t.geometry,t.material),this.particleSystem.sortParticles=!1,this.particleSystem.position.y=3,this.children.push(this.particleSystem),t.tiles.push(this)},update:function(){}},LIGHTS.TerrainDotsText=function(t){this.initialize(t)},LIGHTS.TerrainDotsText.prototype={textScale:phi,initialize:function(t){this.manager=t,this.player=t.director.player,this.words=[];var e,i,s,a=LIGHTS.Terrain.prototype.tileSize,r=a*(1/3-.5),o=a*(2/3-.5),n=.5*a,h=[];for(h.push([r,80,r]),h.push([r,90,o]),h.push([r,100,n]),h.push([o,120,r]),h.push([o,130,o]),h.push([o,140,n]),h.push([n,150,r]),h.push([n,160,o]),h.push([n,170,n]),s=0;s<LIGHTS.tweets.length;s++)pos=h[s],e=new THREE.Vector3(pos[0],pos[1],pos[2]),i=new LIGHTS.TerrainDotsWord("@"+LIGHTS.tweets[s],e),this.words.push(i)},update:function(){var t,e=this.words,i=e.length,s=this.player.angle;for(t=0;t<i;t++)e[t].update(s)}},LIGHTS.TerrainDotsWord=function(t,e){this.initialize(t,e)},LIGHTS.TerrainDotsWord.prototype={initialize:function(t,e){this.word=t,this.position=e,this.rotation=Math.random()*rad360,this.scale=LIGHTS.TerrainDotsText.prototype.textScale,this.rotationSpeed=.1*Math.random()+.1,this.rotationSpeed*=Math.random()>.5?1:-1,this.floatFreq=5*Math.random()+5,this.floatAmp=5*Math.random()+5,this.pixels=[],this.dots=[];var i,s,a,r,o,n,h=0;for(i=0;i<t.length;i++)if(o=(a=LIGHTS.DotsFont.font[t.charCodeAt(i)]).xoffset,n=a.yoffset,void 0!==a){for(pixels=a.pixels,s=0;s<pixels.length;s++)pixel=pixels[s],this.pixels.push([pixel[0]+o+h,pixel[1]+n]),this.dots.push(new THREE.Vector3);h+=a.xadvance}else console.log("ERROR: LIGHTS.TerrainDotsWord: Char not found in font!");for(this.width=h,r=h/2,i=0;i<this.pixels.length;i++)this.pixels[i][0]-=r},update:function(t){var e,i,s,a,r,o,n=this.pixels,h=this.dots,l=this.position.x,c=this.position.y,d=this.position.z,p=this.scale,u=this.scale,m=Math.sin(this.rotation),T=Math.cos(this.rotation),g=n.length,f=Math.sin(LIGHTS.time%this.floatFreq/this.floatFreq*rad360)*this.floatAmp;for(m*Math.cos(t)-T*Math.sin(t)<0&&(p=-p),e=0;e<g;e++)i=(r=n[e])[0]*p*m,s=r[1]*u,a=r[0]*p*T,(o=h[e]).x=l+i,o.y=c-s+f,o.z=d+a;this.rotation+=this.rotationSpeed*LIGHTS.deltaTime},toString:function(){var t,e,i,s,a=this.pixels,r=(this.dots,this.position.x,this.position.y,this.position.z,this.scale,[]),o="",n=this.width/2,h=a.length;for(t=0;t<h;t++)e=(s=a[t])[0]+n,void 0===r[i=s[1]]&&(r[i]=[]),r[i][e]=!0;for(i=0;i<r.length;i++){if(void 0!==r[i])for(e=0;e<r[i].length;e++)o+=1==r[i][e]?"X":" ";o+="\n"}return o}},LIGHTS.TerrainMeshManager=function(t){this.initialize(t)},LIGHTS.TerrainMeshManager.prototype={active:!1,colors:[16776960,65535,16711935,16711680,65280,255],beats:0,initialize:function(t){this.director=t,this.geometry=t.terrain.terrainPlane,this.terrainMap=new LIGHTS.TerrainMap(t.view.renderer),this.terrainMap.texture.wrapS=this.terrainMap.texture.wrapT=THREE.RepeatWrapping;var e=new THREE.Texture([LIGHTS.images.envMapLeftRight,LIGHTS.images.envMapLeftRight,LIGHTS.images.envMapTop,LIGHTS.images.envMapBottom,LIGHTS.images.envMapFrontBack,LIGHTS.images.envMapFrontBack]);e.needsUpdate=!0,this.material=new THREE.MeshBasicMaterial({color:0,map:this.terrainMap.texture,envMap:e,reflectivity:1,combine:THREE.MultiplyOperation,shading:THREE.SmoothShading}),t.materialCache.addMaterial(this.material),this.mapDots=new LIGHTS.MapDots(this.terrainMap),this.mapLines=new LIGHTS.MapLines(this.terrainMap),this.mapCircles=new LIGHTS.MapCircles(this.terrainMap),this.mapGlows=new LIGHTS.MapGlows(this.terrainMap)},launch:function(){switch(LIGHTS.Music.phase.index){case 0:case 3:break;case 1:this.mapGlows.launch(this.director.tileManager.balls),this.material.color.setHex(16777215),this.material.reflectivity=0,this.terrainMap.clear(),this.terrainMap.update();break;case 2:this.material.reflectivity=.2;break;case 7:this.material.reflectivity=0,this.material.color.setHex(16777215);break;case 8:this.material.reflectivity=.15;break;case 11:case 21:this.material.reflectivity=.2,this.mapGlows.update();break;case 13:this.mapLines.clear();break;case 14:this.dotCount=1;break;case 15:this.terrainMap.clear(8421504),this.material.reflectivity=.3;break;case 16:this.material.reflectivity=0,this.material.color.setHex(0),this.terrainMap.post=!0,this.terrainMap.clear(),this.terrainMap.update();break;case 17:this.material.reflectivity=.3,this.material.color.setHex(16777215),this.mapDots.clear(),this.mapCircles.launch(),this.terrainMap.update();break;case 22:this.material.reflectivity=0,this.mapCircles.clear()}},beat:function(){switch(LIGHTS.Music.phase.index){case 7:this.mapLines.drawLines(4);break;case 8:case 11:case 12:this.mapLines.drawLines(8);break;case 9:this.mapLines.drawLines(16);break;case 10:this.mapLines.drawLines(24);break;case 13:case 17:case 18:case 19:case 20:case 21:break;case 14:this.mapDots.drawDots(this.dotCount),this.beats%8==0&&this.dotCount<24&&this.dotCount++;break;case 15:this.mapDots.drawDots(this.dotCount),this.dotCount<16&&(this.dotCount+=2)}this.beats++},update:function(){switch(LIGHTS.Music.phase.index){case 1:case 2:case 3:case 4:case 5:case 6:this.mapGlows.update(),this.terrainMap.update();break;case 7:case 8:case 9:case 10:this.mapLines.update(),this.mapGlows.update(),this.terrainMap.update();break;case 11:case 12:case 16:this.mapLines.update(),this.terrainMap.update();break;case 13:this.terrainMap.update(),this.material.reflectivity-=this.material.reflectivity*LIGHTS.deltaTime;break;case 14:case 15:this.mapDots.update(),this.terrainMap.update();break;case 17:case 18:case 19:case 20:this.mapGlows.update(),this.mapCircles.update(),this.terrainMap.update();break;case 21:this.mapCircles.update(),this.terrainMap.update();break;case 22:this.terrainMap.update()}},animateUVs:function(){for(var t=this.geometry.uvGrid,e=0;e<t.length;e++)for(var i=.005*(Math.random()-.5),s=0;s<t[e].length;s++)t[s][e].v+=i;this.geometry.__dirtyUvs=!0}},LIGHTS.TerrainMeshTile=function(t){this.initialize(t)},LIGHTS.TerrainMeshTile.prototype={initialize:function(t){this.manager=t,this.children=[];var e=new THREE.Mesh(t.geometry,t.material);e.dynamic=!0,this.children.push(e)},update:function(){}},LIGHTS.BitmapFont=function(t,e){this.initialize(t,e)},LIGHTS.BitmapFont.prototype={initialize:function(t,e){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var s=i.getContext("2d");s.drawImage(e,0,0);var a,r,o,n,h,l,c,d,p,u,m,T=s.getImageData(0,0,i.width,i.height).data,g=t.split("\n"),f=g.length,y=e.width;for(this.font=[],m=0;m<f;m++)"char"==(u=g[m].split(" "))[0]&&(a=parseInt(u[1].split("=")[1]),r=parseInt(u[2].split("=")[1]),o=parseInt(u[3].split("=")[1]),n=parseInt(u[4].split("=")[1]),h=parseInt(u[5].split("=")[1]),l=parseInt(u[6].split("=")[1]),c=parseInt(u[7].split("=")[1]),d=parseInt(u[8].split("=")[1]),p=u[11].split("=")[1].charAt(1),this.font[a]=new LIGHTS.FontChar(T,y,a,r,o,n,h,l,c,d,p))}},LIGHTS.FontChar=function(t,e,i,s,a,r,o,n,h,l,c){this.id=i,this.x=s,this.y=a,this.width=r,this.height=o,this.xoffset=n,this.yoffset=h,this.xadvance=l,this.letter=c,this.pixels=[];var d,p;for(d=0;d<r;d++)for(p=0;p<o;p++)t[4*(s+d+(a+p)*e)]>64&&this.pixels.push([d,p])},LIGHTS.Input=function(){this.initialize()},LIGHTS.Input.mouseX=0,LIGHTS.Input.mouseY=0,LIGHTS.Input.mouseDown=!1,LIGHTS.Input.mouseClick=!1,LIGHTS.Input.keyUp=!1,LIGHTS.Input.keyDown=!1,LIGHTS.Input.keyRight=!1,LIGHTS.Input.keyLeft=!1,LIGHTS.Input.keySpace=!1,LIGHTS.Input.keyReturn=!1,LIGHTS.Input.prototype={initialize:function(){window.addEventListener("keydown",bind(this,this.onKeyDown),!1),window.addEventListener("keyup",bind(this,this.onKeyUp),!1),this.domElement=document,this.domElement.addEventListener("mousemove",bind(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",bind(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",bind(this,this.onMouseUp),!1)},onMouseMove:function(t){t.preventDefault();var e=this.domElement,i=e!=document,s=i?e.offsetLeft:0,a=i?e.offsetTop:0,r=i?e.offsetWidth:window.innerWidth,o=i?e.offsetHeight:window.innerHeight,n=r/2,h=o/2;LIGHTS.Input.pointerX=Math.max(0,Math.min(r,t.clientX-s))-n,LIGHTS.Input.pointerY=Math.max(0,Math.min(o,t.clientY-a))-h,LIGHTS.Input.mouseX=LIGHTS.Input.pointerX/n,LIGHTS.Input.mouseY=LIGHTS.Input.pointerY/h},onMouseDown:function(t){LIGHTS.Input.mouseDown=!0,LIGHTS.Input.mouseClick=!0},onMouseUp:function(t){LIGHTS.Input.mouseDown=!1},onKeyDown:function(t){var e=t.keyCode;38==e||87==e?LIGHTS.Input.keyUp=!0:40==e||83==e?LIGHTS.Input.keyDown=!0:37==e||65==e?LIGHTS.Input.keyRight=!0:39==e||68==e?LIGHTS.Input.keyLeft=!0:32==e?LIGHTS.Input.keySpace=!0:13==e&&(LIGHTS.Input.keyReturn=!0)},onKeyUp:function(t){var e=t.keyCode;38==e||87==e?LIGHTS.Input.keyUp=!1:40==e||83==e?LIGHTS.Input.keyDown=!1:37==e||65==e?LIGHTS.Input.keyRight=!1:39==e||68==e?LIGHTS.Input.keyLeft=!1:32==e?LIGHTS.Input.keySpace=!1:13==e&&(LIGHTS.Input.keyReturn=!1)}},LIGHTS.Stopwatch=function(){this.initialize()},LIGHTS.Stopwatch.prototype={initialize:function(){this.date=new Date},start:function(){this.startTime=this.date.getTime()},stop:function(){this.time=this.date.getTime()-this.startTime,console.log(this.time)}},LIGHTS.CapsuleGeometry=function(t,e,i,s,a,r,o,n,h,l,c){THREE.Geometry.call(this);var d,p,u,m,T,g,f,y,v,b,S,H=this.vertices,E=this.faces,x=[],w=i,M=a.length-1;for(r?w+=o:o=0,h?w+=l:l=0,p=0;p<=M;p++)for(f=t*(1-(m=a[p]))+e*m,d=0;d<s;d++)g=rad360*d/s,u=Math.sin(g)*f,T=Math.cos(g)*f,H.push(new THREE.Vertex(new THREE.Vector3(u,m*i,T))),x.push(new THREE.UV(d/s,(m*i+l)/w));for(p=0;p<M;p++)for(m=p*s,d=0;d<s;d++)g=d+s+m,f=d+m,y=(d+1)%s+m,v=s+(d+1)%s+m,b=new THREE.Face4(g,f,y,v),E.push(b);if(r){for(p=M*s,f=0;f<n-1;f++)for(g=rad90*((f+1)/n),v=e*Math.cos(g),m=i+o*Math.sin(g),d=0;d<s;d++)g=rad360*d/s,u=Math.sin(g)*v,T=Math.cos(g)*v,H.push(new THREE.Vertex(new THREE.Vector3(u,m,T))),x.push(new THREE.UV(d/s,(m+l)/w));for(H.push(new THREE.Vertex(new THREE.Vector3(0,i+o,0))),x.push(new THREE.UV(99,1)),u=0;u<n-1;u++)for(m=u*s+p,d=0;d<s;d++)g=d+s+m,f=d+m,y=(d+1)%s+m,v=(d+1)%s+s+m,b=new THREE.Face4(g,f,y,v),E.push(b);for(f=H.length-1,d=0;d<s-1;d++)g=f-s+d+1,y=f-s+d,b=new THREE.Face3(g,f,y),E.push(b);y=f-1,g=f-s,b=new THREE.Face3(g,f,y),E.push(b)}if(h){for(p+=n*s+1,f=0;f<c-1;f++)for(g=rad90*((f+1)/c),v=e*Math.cos(g),m=-l*Math.sin(g),d=0;d<s;d++)g=rad360*d/s,u=Math.sin(g)*v,T=Math.cos(g)*v,H.push(new THREE.Vertex(new THREE.Vector3(u,m,T))),x.push(new THREE.UV(d/s,-m/w));for(H.push(new THREE.Vertex(new THREE.Vector3(0,-l,0))),x.push(new THREE.UV(99,0)),u=0;u<c-1;u++)for(m=(u-1)*s+p,d=0;d<s;d++)0==u?(g=d+p,f=d,y=(d+1)%s,v=(d+1)%s+p):(g=d+m+s,f=d+m,y=(d+1)%s+m,v=(d+1)%s+m+s),b=new THREE.Face4(y,f,g,v),E.push(b);for(f=H.length-1,d=0;d<s-1;d++)g=f-s+d+1,y=f-s+d,b=new THREE.Face3(y,f,g),E.push(b);y=f-1,g=f-s,b=new THREE.Face3(y,f,g),E.push(b)}for(d=0;d<E.length;d++)S=[],g=x[(b=E[d]).a],f=x[b.b],y=x[b.c],void 0!==b.d?(0==y.u&&(y=new THREE.UV(1,y.v)),S.push(new THREE.UV(g.u,g.v)),S.push(new THREE.UV(f.u,f.v)),S.push(new THREE.UV(y.u,y.v)),0==(v=x[b.d]).u&&(v=new THREE.UV(1,v.v)),S.push(new THREE.UV(v.u,v.v))):(99==f.u&&(f=new THREE.UV((g.u+y.u)/2,f.v)),0==g.u&&(g=new THREE.UV(1,g.v)),S.push(new THREE.UV(g.u,g.v)),S.push(new THREE.UV(f.u,f.v)),S.push(new THREE.UV(y.u,y.v))),this.faceVertexUvs[0].push(S);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},LIGHTS.CapsuleGeometry.prototype=new THREE.Geometry,LIGHTS.CapsuleGeometry.prototype.constructor=LIGHTS.CapsuleGeometry,LIGHTS.MaterialCache=function(t){this.initialize(t)},LIGHTS.MaterialCache.prototype={materials:[],initialize:function(t){this.container=new THREE.Object3D,this.container.position=t.player.targetPosition,t.view.scene.addChild(this.container)},addMaterial:function(t){var e=new THREE.Mesh(new THREE.PlaneGeometry(0,0),t);this.container.addChild(e)}},THREE.MeshUtils={},THREE.MeshUtils.addChild=function(t,e,i){i.parent!=e&&(i.parent=e,e.children.push(i),t.objects.push(i),t.__objectsAdded.push(i))},THREE.MeshUtils.removeChild=function(t,e,i){i.parent==e&&(i.parent=null,e.children.splice(e.children.indexOf(i),1),t.objects.splice(t.objects.indexOf(i),1),t.__objectsRemoved.push(i))},THREE.MeshUtils.transformUVs=function(t,e,i,s,a){var r,o,n,h,l,c,d=t.faceVertexUvs[0];for(r=0,o=d.length;r<o;r++)for(n=0,h=(l=d[r]).length;n<h;n++)(c=l[n]).u=c.u*s+e,c.v=c.v*a+i},THREE.MeshUtils.translateVertices=function(t,e,i,s){var a,r,o,n=t.vertices;for(r=0,o=n.length;r<o;r++)(a=n[r].position).x+=e,a.y+=i,a.z+=s},THREE.MeshUtils.getVertexNormals=function(t){var e,i,s,a=t.faces,r=[];for(e=0,i=a.length;e<i;e++)(s=a[e])instanceof THREE.Face3?(r[s.a]=s.vertexNormals[0],r[s.b]=s.vertexNormals[1],r[s.c]=s.vertexNormals[2]):s instanceof THREE.Face4&&(r[s.a]=s.vertexNormals[0],r[s.b]=s.vertexNormals[1],r[s.c]=s.vertexNormals[2],r[s.d]=s.vertexNormals[3]);return r},THREE.MeshUtils.createVertexColorGradient=function(t,e,i){var s,a,r,o,n,h,l,c,d,p,u,m,T=t.vertices,g=t.faces,f=e.length,y=[],v=[];for(void 0===i&&(i=0),n=0,h=T.length;n<h;n++)-1==y.indexOf(T[n].position.y)&&y.push(T[n].position.y);for(y.sort((function(t,e){return e-t})),s=y[(r=y.length)-1],a=y[0]-s,n=0;n<r;n++)d=(y[n]-s)/a,d=Math.max(0,(d-i)/(1-i)),d*=f-1,index=Math.floor(d),l=e[index],c=e[index+1],topR=(c>>16&255)/255,topG=(c>>8&255)/255,topB=(255&c)/255,bottomR=(l>>16&255)/255,bottomG=(l>>8&255)/255,bottomB=(255&l)/255,u=1-(p=d%1),(m=new THREE.Color).r=topR*p+bottomR*u,m.g=topG*p+bottomG*u,m.b=topB*p+bottomB*u,m.updateHex(),v[n]=m;for(n=0,h=g.length;n<h;n++)(o=g[n]).vertexColors.push(v[y.indexOf(T[o.a].position.y)]),o.vertexColors.push(v[y.indexOf(T[o.b].position.y)]),o.vertexColors.push(v[y.indexOf(T[o.c].position.y)]),void 0!==o.d&&o.vertexColors.push(v[y.indexOf(T[o.d].position.y)]);delete y,t.vertexColorList=v},THREE.RenderStats=function(t,e){this.initialize(t,e)},THREE.RenderStats.prototype={initialize:function(t,e){this.renderer=t,void 0===e&&(e={});var i,s=void 0!==e.color?e.color:"#FF1561",a=void 0!==e.top?e.top:"42px";this.values=document.createElement("div"),(i=this.values.style).fontFamily="Helvetica, Arial, sans-serif",i.fontSize="16px",i.fontWeight="bold",i.lineHeight="28px",i.textAlign="left",i.color=s,i.position="absolute",i.margin="2px 2px 2px 4px";var r=document.createElement("div");(i=r.style).fontFamily="Helvetica, Arial, sans-serif",i.fontSize="8px",i.fontWeight="bold",i.lineHeight="28px",i.textAlign="left",i.color=s,i.position="absolute",i.top="12px",i.margin="2px 2px 2px 4px",r.innerHTML="VERTS<br>TRIS<br>DRAWS",this.container=document.createElement("div"),(i=this.container.style).zIndex="10000",i.position="absolute",i.top=a,this.container.appendChild(r),this.container.appendChild(this.values),document.body.appendChild(this.container)},update:function(){this.values.innerHTML=this.renderer.data.vertices,this.values.innerHTML+="</br>"+this.renderer.data.faces,this.values.innerHTML+="</br>"+this.renderer.data.drawCalls}},eval(function(t,e,i,s,a,r){for(a=function(t){return(t<57?"":a(parseInt(t/57)))+((t%=57)>35?String.fromCharCode(t+29):t.toString(36))};i--;)s[i]&&(t=t.replace(new RegExp("\\b"+a(i)+"\\b","g"),s[i]));return t}("D.C=d(2,1){0.B(2,1)};D.C.U={B:d(2,1){0.2=2;T(1===k)1={};A 3=(1.3!==k)?1.3:'#S',5=1.5!==k?1.5:'R',s;0.4=a.j('i');s=0.4.h;s.z='y, x, w-v';s.u='Q';s.t='r';s.q='p';s.o='n';s.3=3;s.g='f';s.m='6 6 6 l';A b=a.j('i');s=b.h;s.z='y, x, w-v';s.u='P';s.t='r';s.q='p';s.o='n';s.3=3;s.g='f';s.5='O';s.m='6 6 6 l';b.9='N<8>M<8>L';0.7=a.j('i');s=0.7.h;s.K=\"J\";s.g='f';s.5=5;0.7.e(b);0.7.e(0.4);a.I.e(0.7)},H:d(){0.4.9=0.2.c.G;0.4.9+='</8>'+0.2.c.F;0.4.9+='</8>'+0.2.c.E}};",0,57,"this|parameters|renderer|color|values|top|2px|container|br|innerHTML|document|labels|data|function|appendChild|absolute|position|style|div|createElement|undefined|4px|margin|left|textAlign|28px|lineHeight|bold||fontWeight|fontSize|serif|sans|Arial|Helvetica|fontFamily|var|initialize|RenderStats|THREE|drawCalls|faces|vertices|update|body|10000|zIndex|DRAWS|TRIS|VERTS|12px|8px|16px|42px|FF1561|if|prototype".split("|"))),LIGHTS.SpotGeometry=function(t,e,i,s,a){THREE.Geometry.call(this),void 0===s&&(s=1),void 0===a&&(a=3);var r,o,n,h,l,c,d,p,u,m,T,g=t/2,f=e/2,y=Math.sin(30*deg2rad),v=Math.cos(30*deg2rad),b=Math.sin(-30*deg2rad),S=Math.cos(-30*deg2rad),H=[[g,f],[g*y,f*y],[g*b,f*b]],E=[[0,0],[g*v,f*v],[g*S,f*S]];for(r=0;r<a;r++)for(n=H[T=r%3][0],h=H[T][1],l=E[T][0],c=E[T][1],this.vertices.push(new THREE.Vertex(new THREE.Vector3(-n,0,-l))),this.vertices.push(new THREE.Vertex(new THREE.Vector3(n,0,l))),o=0;o<s;o++)u=n*(1-(p=(o+1)/s))+h*p,m=l*(1-p)+c*p,this.vertices.push(new THREE.Vertex(new THREE.Vector3(-u,p*i,-m))),this.vertices.push(new THREE.Vertex(new THREE.Vector3(u,p*i,m))),d=this.vertices.length-4,this.faces.push(new THREE.Face4(d,d+1,d+3,d+2)),this.faceVertexUvs[0].push([new THREE.UV(0,p),new THREE.UV(1,p),new THREE.UV(1,o/s),new THREE.UV(0,o/s)]);this.computeFaceNormals()},LIGHTS.SpotGeometry.prototype=new THREE.Geometry,LIGHTS.SpotGeometry.prototype.constructor=LIGHTS.SpotGeometry,LIGHTS.TextureUtils=function(){this.initialize()},LIGHTS.TextureUtils.grays=[],LIGHTS.TextureUtils.prototype={initialize:function(){for(var t=0;t<256;t++)LIGHTS.TextureUtils.grays=65793*t}},LIGHTS.TextureUtils.getCircleTexture=function(t){var e,i,s,a,r=.5*t;return(i=document.createElement("canvas")).width=t,i.height=t,(e=(s=i.getContext("2d")).createRadialGradient(r,r,0,r,r,r)).addColorStop(0,"#FFFFFF"),e.addColorStop(.4,"#FFFFFF"),e.addColorStop(.8,"#808080"),e.addColorStop(1,"#000000"),s.fillStyle=e,s.beginPath(),s.arc(r,r,.95*r,0,rad360,!0),s.closePath(),s.fill(),(a=new THREE.Texture(i,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter)).needsUpdate=!0,a},LIGHTS.TextureUtils.getGradientColors=function(t){var e,i,s,a,r,o=[];for((s=document.createElement("canvas")).width=256,s.height=1,i=(a=s.getContext("2d")).createLinearGradient(0,0,255,0),e=0;e<t.length;e++)i.addColorStop(t[e][1],t[e][0]);for(a.fillStyle=i,a.fillRect(0,0,256,1),r=a.getImageData(0,0,256,1).data,e=0;e<r.length;e+=4)o.push(65536*r[e]+256*r[e+1]+1*r[e+2]);return o};
